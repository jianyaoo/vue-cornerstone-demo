{"ast":null,"code":"import { getEnabledElement, StackViewport, VolumeViewport, utilities, getEnabledElementByIds } from '@cornerstonejs/core';\nimport { addAnnotation, getAnnotations } from '../stateManagement/annotation/annotationState';\nimport { isAnnotationVisible } from '../stateManagement/annotation/annotationVisibility';\nimport { drawLine } from '../drawingSvg';\nimport { getViewportIdsWithToolToRender } from '../utilities/viewportFilters';\nimport triggerAnnotationRenderForViewportIds from '../utilities/triggerAnnotationRenderForViewportIds';\nimport { vec3 } from 'gl-matrix';\nimport AnnotationDisplayTool from './base/AnnotationDisplayTool';\nimport vtkMath from '@kitware/vtk.js/Common/Core/Math';\nimport { hideElementCursor, resetElementCursor } from '../cursors/elementCursor';\nimport { getToolGroup } from '../store/ToolGroupManager';\nclass ReferenceCursors extends AnnotationDisplayTool {\n  constructor(toolProps = {}, defaultToolProps = {\n    supportedInteractionTypes: ['Mouse', 'Touch'],\n    configuration: {\n      shadow: true,\n      preventHandleOutsideImage: false,\n      displayThreshold: 5,\n      positionSync: true,\n      disableCursor: false\n    }\n  }) {\n    super(toolProps, defaultToolProps);\n    this.isDrawing = false;\n    this.isHandleOutsideImage = false;\n    this._elementWithCursor = null;\n    this._currentCursorWorldPosition = null;\n    this._currentCanvasPosition = null;\n    this._disableCursorEnabled = false;\n    this.mouseMoveCallback = evt => {\n      const {\n        detail\n      } = evt;\n      const {\n        element,\n        currentPoints\n      } = detail;\n      this._currentCursorWorldPosition = currentPoints.world;\n      this._currentCanvasPosition = currentPoints.canvas;\n      this._elementWithCursor = element;\n      const annotation = this.getActiveAnnotation(element);\n      if (annotation === null) {\n        this.createInitialAnnotation(currentPoints.world, element);\n        return false;\n      }\n      this.updateAnnotationPosition(element, annotation);\n      return false;\n    };\n    this.createInitialAnnotation = (worldPos, element) => {\n      const enabledElement = getEnabledElement(element);\n      if (!enabledElement) {\n        throw new Error('No enabled element found');\n      }\n      const {\n        viewport,\n        renderingEngine\n      } = enabledElement;\n      this.isDrawing = true;\n      const camera = viewport.getCamera();\n      const {\n        viewPlaneNormal,\n        viewUp\n      } = camera;\n      if (!viewPlaneNormal || !viewUp) {\n        throw new Error('Camera not found');\n      }\n      const referencedImageId = this.getReferencedImageId(viewport, worldPos, viewPlaneNormal, viewUp);\n      const FrameOfReferenceUID = viewport.getFrameOfReferenceUID();\n      const annotation = {\n        highlighted: true,\n        invalidated: true,\n        metadata: {\n          toolName: this.getToolName(),\n          viewPlaneNormal: [...viewPlaneNormal],\n          viewUp: [...viewUp],\n          FrameOfReferenceUID,\n          referencedImageId\n        },\n        data: {\n          label: '',\n          handles: {\n            points: [[...worldPos]],\n            activeHandleIndex: null,\n            textBox: {\n              hasMoved: false,\n              worldPosition: [0, 0, 0],\n              worldBoundingBox: {\n                topLeft: [0, 0, 0],\n                topRight: [0, 0, 0],\n                bottomLeft: [0, 0, 0],\n                bottomRight: [0, 0, 0]\n              }\n            }\n          }\n        }\n      };\n      const annotations = getAnnotations(this.getToolName(), element);\n      if (annotations.length > 0) {\n        return null;\n      }\n      const annotationId = addAnnotation(annotation, element);\n      if (annotationId === null) {\n        return;\n      }\n      const viewportIdsToRender = getViewportIdsWithToolToRender(element, this.getToolName(), false);\n      triggerAnnotationRenderForViewportIds(renderingEngine, viewportIdsToRender);\n    };\n    this.onCameraModified = evt => {\n      const eventDetail = evt.detail;\n      const {\n        element,\n        previousCamera,\n        camera\n      } = eventDetail;\n      const enabledElement = getEnabledElement(element);\n      const viewport = enabledElement.viewport;\n      if (element !== this._elementWithCursor) {\n        return;\n      }\n      const oldFocalPoint = previousCamera.focalPoint;\n      const cameraNormal = camera.viewPlaneNormal;\n      const newFocalPoint = camera.focalPoint;\n      const deltaCameraFocalPoint = [0, 0, 0];\n      vtkMath.subtract(newFocalPoint, oldFocalPoint, deltaCameraFocalPoint);\n      if (deltaCameraFocalPoint.reduce((a, b) => a + b, 0) === 0) {\n        return;\n      }\n      const dotProduct = vtkMath.dot(deltaCameraFocalPoint, cameraNormal);\n      if (Math.abs(dotProduct) < 1e-2) {\n        return;\n      }\n      if (!this._currentCanvasPosition) {\n        return;\n      }\n      const newWorldPos = viewport.canvasToWorld(this._currentCanvasPosition);\n      this._currentCursorWorldPosition = newWorldPos;\n      this.updateAnnotationPosition(element, this.getActiveAnnotation(element));\n    };\n    this.renderAnnotation = (enabledElement, svgDrawingHelper) => {\n      let renderStatus = false;\n      const {\n        viewport,\n        FrameOfReferenceUID\n      } = enabledElement;\n      const isElementWithCursor = this._elementWithCursor === viewport.element;\n      if (this.configuration.positionSync && !isElementWithCursor) {\n        this.updateViewportImage(viewport);\n      }\n      const {\n        element\n      } = viewport;\n      let annotations = getAnnotations(this.getToolName(), element);\n      if (!annotations?.length) {\n        return renderStatus;\n      }\n      annotations = this.filterInteractableAnnotationsForElement(element, annotations);\n      if (!annotations?.length) {\n        return renderStatus;\n      }\n      const styleSpecifier = {\n        toolGroupId: this.toolGroupId,\n        toolName: this.getToolName(),\n        viewportId: enabledElement.viewport.id\n      };\n      for (let i = 0; i < annotations.length; i++) {\n        const annotation = annotations[i];\n        const {\n          annotationUID,\n          data\n        } = annotation;\n        const {\n          handles\n        } = data;\n        const {\n          points\n        } = handles;\n        if (!annotationUID) {\n          return renderStatus;\n        }\n        styleSpecifier.annotationUID = annotationUID;\n        const lineWidthBase = parseFloat(this.getStyle('lineWidth', styleSpecifier, annotation));\n        const lineWidth = typeof lineWidthBase === 'number' && isElementWithCursor ? lineWidthBase : lineWidthBase;\n        const lineDash = this.getStyle('lineDash', styleSpecifier, annotation);\n        const color = this.getStyle('color', styleSpecifier, annotation);\n        if (points[0].some(e => isNaN(e))) {\n          return renderStatus;\n        }\n        const canvasCoordinates = points.map(p => viewport.worldToCanvas(p));\n        if (!viewport.getRenderingEngine()) {\n          console.warn('Rendering Engine has been destroyed');\n          return renderStatus;\n        }\n        if (!isAnnotationVisible(annotationUID)) {\n          continue;\n        }\n        const crosshairUIDs = {\n          upper: 'upper',\n          right: 'right',\n          lower: 'lower',\n          left: 'left'\n        };\n        const [x, y] = canvasCoordinates[0];\n        const centerSpace = isElementWithCursor ? 20 : 7;\n        const lineLength = isElementWithCursor ? 5 : 7;\n        drawLine(svgDrawingHelper, annotationUID, crosshairUIDs.upper, [x, y - (centerSpace / 2 + lineLength)], [x, y - centerSpace / 2], {\n          color,\n          lineDash,\n          lineWidth\n        });\n        drawLine(svgDrawingHelper, annotationUID, crosshairUIDs.lower, [x, y + (centerSpace / 2 + lineLength)], [x, y + centerSpace / 2], {\n          color,\n          lineDash,\n          lineWidth\n        });\n        drawLine(svgDrawingHelper, annotationUID, crosshairUIDs.right, [x + (centerSpace / 2 + lineLength), y], [x + centerSpace / 2, y], {\n          color,\n          lineDash,\n          lineWidth\n        });\n        drawLine(svgDrawingHelper, annotationUID, crosshairUIDs.left, [x - (centerSpace / 2 + lineLength), y], [x - centerSpace / 2, y], {\n          color,\n          lineDash,\n          lineWidth\n        });\n        renderStatus = true;\n      }\n      return renderStatus;\n    };\n    this._disableCursorEnabled = this.configuration.disableCursor;\n  }\n  onSetToolActive() {\n    this._disableCursorEnabled = this.configuration.disableCursor;\n    if (!this._disableCursorEnabled) {\n      return;\n    }\n    const viewportIds = getToolGroup(this.toolGroupId).viewportsInfo;\n    if (!viewportIds) {\n      return;\n    }\n    const enabledElements = viewportIds.map(e => getEnabledElementByIds(e.viewportId, e.renderingEngineId));\n    enabledElements.forEach(element => {\n      if (element) {\n        hideElementCursor(element.viewport.element);\n      }\n    });\n  }\n  onSetToolDisabled() {\n    if (!this._disableCursorEnabled) {\n      return;\n    }\n    const viewportIds = getToolGroup(this.toolGroupId).viewportsInfo;\n    if (!viewportIds) {\n      return;\n    }\n    const enabledElements = viewportIds.map(e => getEnabledElementByIds(e.viewportId, e.renderingEngineId));\n    enabledElements.forEach(element => {\n      if (element) {\n        resetElementCursor(element.viewport.element);\n      }\n    });\n  }\n  getActiveAnnotation(element) {\n    const annotations = getAnnotations(this.getToolName(), element);\n    if (!annotations.length) {\n      return null;\n    }\n    const targetAnnotation = annotations[0];\n    return targetAnnotation;\n  }\n  updateAnnotationPosition(element, annotation) {\n    const worldPos = this._currentCursorWorldPosition;\n    if (!worldPos) {\n      return;\n    }\n    if (!annotation.data?.handles?.points) {\n      return;\n    }\n    annotation.data.handles.points = [[...worldPos]];\n    annotation.invalidated = true;\n    const viewportIdsToRender = getViewportIdsWithToolToRender(element, this.getToolName(), false);\n    const enabledElement = getEnabledElement(element);\n    if (!enabledElement) {\n      return;\n    }\n    const {\n      renderingEngine\n    } = enabledElement;\n    triggerAnnotationRenderForViewportIds(renderingEngine, viewportIdsToRender);\n  }\n  filterInteractableAnnotationsForElement(element, annotations) {\n    if (!(annotations instanceof Array) || annotations.length === 0) {\n      return [];\n    }\n    const annotation = annotations[0];\n    const viewport = getEnabledElement(element)?.viewport;\n    if (!viewport) {\n      return [];\n    }\n    const camera = viewport.getCamera();\n    const {\n      viewPlaneNormal,\n      focalPoint\n    } = camera;\n    if (!viewPlaneNormal || !focalPoint) {\n      return [];\n    }\n    const points = annotation.data?.handles?.points;\n    if (!(points instanceof Array) || points.length !== 1) {\n      return [];\n    }\n    const worldPos = points[0];\n    const plane = utilities.planar.planeEquation(viewPlaneNormal, focalPoint);\n    const distance = utilities.planar.planeDistanceToPoint(plane, worldPos);\n    return distance < this.configuration.displayThreshold ? [annotation] : [];\n  }\n  updateViewportImage(viewport) {\n    const currentMousePosition = this._currentCursorWorldPosition;\n    if (!currentMousePosition || currentMousePosition.some(e => isNaN(e))) {\n      return;\n    }\n    if (viewport instanceof StackViewport) {\n      const closestIndex = utilities.getClosestStackImageIndexForPoint(currentMousePosition, viewport);\n      if (closestIndex === null) {\n        return;\n      }\n      if (closestIndex !== viewport.getCurrentImageIdIndex()) {\n        viewport.setImageIdIndex(closestIndex);\n      }\n    } else if (viewport instanceof VolumeViewport) {\n      const {\n        focalPoint,\n        viewPlaneNormal\n      } = viewport.getCamera();\n      if (!focalPoint || !viewPlaneNormal) {\n        return;\n      }\n      const plane = utilities.planar.planeEquation(viewPlaneNormal, focalPoint);\n      const currentDistance = utilities.planar.planeDistanceToPoint(plane, currentMousePosition, true);\n      if (Math.abs(currentDistance) < 0.5) {\n        return;\n      }\n      const normalizedViewPlane = vec3.normalize(vec3.create(), vec3.fromValues(...viewPlaneNormal));\n      const scaledPlaneNormal = vec3.scale(vec3.create(), normalizedViewPlane, currentDistance);\n      const newFocalPoint = vec3.add(vec3.create(), vec3.fromValues(...focalPoint), scaledPlaneNormal);\n      const isInBounds = true;\n      if (isInBounds) {\n        viewport.setCamera({\n          focalPoint: newFocalPoint\n        });\n        const renderingEngine = viewport.getRenderingEngine();\n        if (renderingEngine) {\n          renderingEngine.renderViewport(viewport.id);\n        }\n      }\n    }\n  }\n}\nReferenceCursors.toolName = 'ReferenceCursors';\nexport default ReferenceCursors;","map":{"version":3,"names":["getEnabledElement","StackViewport","VolumeViewport","utilities","getEnabledElementByIds","addAnnotation","getAnnotations","isAnnotationVisible","drawLine","getViewportIdsWithToolToRender","triggerAnnotationRenderForViewportIds","vec3","AnnotationDisplayTool","vtkMath","hideElementCursor","resetElementCursor","getToolGroup","ReferenceCursors","constructor","toolProps","defaultToolProps","supportedInteractionTypes","configuration","shadow","preventHandleOutsideImage","displayThreshold","positionSync","disableCursor","isDrawing","isHandleOutsideImage","_elementWithCursor","_currentCursorWorldPosition","_currentCanvasPosition","_disableCursorEnabled","mouseMoveCallback","evt","detail","element","currentPoints","world","canvas","annotation","getActiveAnnotation","createInitialAnnotation","updateAnnotationPosition","worldPos","enabledElement","Error","viewport","renderingEngine","camera","getCamera","viewPlaneNormal","viewUp","referencedImageId","getReferencedImageId","FrameOfReferenceUID","getFrameOfReferenceUID","highlighted","invalidated","metadata","toolName","getToolName","data","label","handles","points","activeHandleIndex","textBox","hasMoved","worldPosition","worldBoundingBox","topLeft","topRight","bottomLeft","bottomRight","annotations","length","annotationId","viewportIdsToRender","onCameraModified","eventDetail","previousCamera","oldFocalPoint","focalPoint","cameraNormal","newFocalPoint","deltaCameraFocalPoint","subtract","reduce","a","b","dotProduct","dot","Math","abs","newWorldPos","canvasToWorld","renderAnnotation","svgDrawingHelper","renderStatus","isElementWithCursor","updateViewportImage","filterInteractableAnnotationsForElement","styleSpecifier","toolGroupId","viewportId","id","i","annotationUID","lineWidthBase","parseFloat","getStyle","lineWidth","lineDash","color","some","e","isNaN","canvasCoordinates","map","p","worldToCanvas","getRenderingEngine","console","warn","crosshairUIDs","upper","right","lower","left","x","y","centerSpace","lineLength","onSetToolActive","viewportIds","viewportsInfo","enabledElements","renderingEngineId","forEach","onSetToolDisabled","targetAnnotation","Array","plane","planar","planeEquation","distance","planeDistanceToPoint","currentMousePosition","closestIndex","getClosestStackImageIndexForPoint","getCurrentImageIdIndex","setImageIdIndex","currentDistance","normalizedViewPlane","normalize","create","fromValues","scaledPlaneNormal","scale","add","isInBounds","setCamera","renderViewport"],"sources":["../../../src/tools/ReferenceCursors.ts"],"sourcesContent":[null],"mappings":"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"},"metadata":{},"sourceType":"module","externalDependencies":[]}