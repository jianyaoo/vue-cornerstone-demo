{"ast":null,"code":"import now from './now';\nimport generateColorLUT from './generateColorLUT';\nimport storedColorPixelDataToCanvasImageData from './storedColorPixelDataToCanvasImageData';\nimport storedRGBAPixelDataToCanvasImageData from './storedRGBAPixelDataToCanvasImageData';\nimport setToPixelCoordinateSystem from './setToPixelCoordinateSystem';\nimport doesImageNeedToBeRendered from './doesImageNeedToBeRendered';\nimport initializeRenderCanvas from './initializeRenderCanvas';\nimport saveLastRendered from './saveLastRendered';\nfunction getLut(image, viewport) {\n  if (image.cachedLut !== undefined && image.cachedLut.windowCenter === viewport.voi.windowCenter && image.cachedLut.windowWidth === viewport.voi.windowWidth && image.cachedLut.invert === viewport.invert) {\n    return image.cachedLut.lutArray;\n  }\n  generateColorLUT(image, viewport.voi.windowWidth, viewport.voi.windowCenter, viewport.invert);\n  image.cachedLut.windowWidth = viewport.voi.windowWidth;\n  image.cachedLut.windowCenter = viewport.voi.windowCenter;\n  image.cachedLut.invert = viewport.invert;\n  return image.cachedLut.lutArray;\n}\nfunction getRenderCanvas(enabledElement, image, invalidated) {\n  const canvasWasColor = enabledElement.renderingTools.lastRenderedIsColor === true;\n  if (!enabledElement.renderingTools.renderCanvas || !canvasWasColor) {\n    enabledElement.renderingTools.renderCanvas = document.createElement('canvas');\n  }\n  const renderCanvas = enabledElement.renderingTools.renderCanvas;\n  const {\n    windowWidth,\n    windowCenter\n  } = enabledElement.viewport.voi;\n  if ((windowWidth === 256 || windowWidth === 255) && (windowCenter === 128 || windowCenter === 127) && enabledElement.viewport.invert === false && image.getCanvas && image.getCanvas()) {\n    return image.getCanvas();\n  }\n  if (doesImageNeedToBeRendered(enabledElement, image) === false && invalidated !== true) {\n    return renderCanvas;\n  }\n  if (renderCanvas.width !== image.width || renderCanvas.height !== image.height) {\n    initializeRenderCanvas(enabledElement, image);\n  }\n  let start = now();\n  const colorLUT = getLut(image, enabledElement.viewport);\n  image.stats = image.stats || {};\n  image.stats.lastLutGenerateTime = now() - start;\n  const renderCanvasData = enabledElement.renderingTools.renderCanvasData;\n  const renderCanvasContext = enabledElement.renderingTools.renderCanvasContext;\n  if (image.rgba) {\n    storedRGBAPixelDataToCanvasImageData(image, colorLUT, renderCanvasData.data);\n  } else {\n    storedColorPixelDataToCanvasImageData(image, colorLUT, renderCanvasData.data);\n  }\n  start = now();\n  renderCanvasContext.putImageData(renderCanvasData, 0, 0);\n  image.stats.lastPutImageDataTime = now() - start;\n  return renderCanvas;\n}\nexport function renderColorImage(enabledElement, invalidated) {\n  if (enabledElement === undefined) {\n    throw new Error('renderColorImage: enabledElement parameter must not be undefined');\n  }\n  const image = enabledElement.image;\n  if (image === undefined) {\n    throw new Error('renderColorImage: image must be loaded before it can be drawn');\n  }\n  const context = enabledElement.canvas.getContext('2d');\n  context.setTransform(1, 0, 0, 1, 0, 0);\n  context.fillStyle = 'black';\n  context.fillRect(0, 0, enabledElement.canvas.width, enabledElement.canvas.height);\n  context.imageSmoothingEnabled = !enabledElement.viewport.pixelReplication;\n  setToPixelCoordinateSystem(enabledElement, context);\n  const renderCanvas = getRenderCanvas(enabledElement, image, invalidated);\n  const sx = enabledElement.viewport.displayedArea.tlhc.x - 1;\n  const sy = enabledElement.viewport.displayedArea.tlhc.y - 1;\n  const width = enabledElement.viewport.displayedArea.brhc.x - sx;\n  const height = enabledElement.viewport.displayedArea.brhc.y - sy;\n  context.drawImage(renderCanvas, sx, sy, width, height, 0, 0, width, height);\n  enabledElement.renderingTools = saveLastRendered(enabledElement);\n}","map":{"version":3,"names":["now","generateColorLUT","storedColorPixelDataToCanvasImageData","storedRGBAPixelDataToCanvasImageData","setToPixelCoordinateSystem","doesImageNeedToBeRendered","initializeRenderCanvas","saveLastRendered","getLut","image","viewport","cachedLut","undefined","windowCenter","voi","windowWidth","invert","lutArray","getRenderCanvas","enabledElement","invalidated","canvasWasColor","renderingTools","lastRenderedIsColor","renderCanvas","document","createElement","getCanvas","width","height","start","colorLUT","stats","lastLutGenerateTime","renderCanvasData","renderCanvasContext","rgba","data","putImageData","lastPutImageDataTime","renderColorImage","Error","context","canvas","getContext","setTransform","fillStyle","fillRect","imageSmoothingEnabled","pixelReplication","sx","displayedArea","tlhc","x","sy","y","brhc","drawImage"],"sources":["../../../../../../src/RenderingEngine/helpers/cpuFallback/rendering/renderColorImage.ts"],"sourcesContent":[null],"mappings":"AAAA,OAAOA,GAAG,MAAM,OAAO;AACvB,OAAOC,gBAAgB,MAAM,oBAAoB;AACjD,OAAOC,qCAAqC,MAAM,yCAAyC;AAC3F,OAAOC,oCAAoC,MAAM,wCAAwC;AACzF,OAAOC,0BAA0B,MAAM,8BAA8B;AACrE,OAAOC,yBAAyB,MAAM,6BAA6B;AACnE,OAAOC,sBAAsB,MAAM,0BAA0B;AAC7D,OAAOC,gBAAgB,MAAM,oBAAoB;AAgBjD,SAASC,MAAMA,CAACC,KAAa,EAAEC,QAA6B;EAE1D,IACED,KAAK,CAACE,SAAS,KAAKC,SAAS,IAC7BH,KAAK,CAACE,SAAS,CAACE,YAAY,KAAKH,QAAQ,CAACI,GAAG,CAACD,YAAY,IAC1DJ,KAAK,CAACE,SAAS,CAACI,WAAW,KAAKL,QAAQ,CAACI,GAAG,CAACC,WAAW,IACxDN,KAAK,CAACE,SAAS,CAACK,MAAM,KAAKN,QAAQ,CAACM,MAAM,EAC1C;IACA,OAAOP,KAAK,CAACE,SAAS,CAACM,QAAQ;;EAIjChB,gBAAgB,CACdQ,KAAK,EACLC,QAAQ,CAACI,GAAG,CAACC,WAAW,EACxBL,QAAQ,CAACI,GAAG,CAACD,YAAY,EACzBH,QAAQ,CAACM,MAAM,CAChB;EACDP,KAAK,CAACE,SAAS,CAACI,WAAW,GAAGL,QAAQ,CAACI,GAAG,CAACC,WAAW;EACtDN,KAAK,CAACE,SAAS,CAACE,YAAY,GAAGH,QAAQ,CAACI,GAAG,CAACD,YAAY;EACxDJ,KAAK,CAACE,SAAS,CAACK,MAAM,GAAGN,QAAQ,CAACM,MAAM;EAExC,OAAOP,KAAK,CAACE,SAAS,CAACM,QAAQ;AACjC;AAYA,SAASC,eAAeA,CACtBC,cAAyC,EACzCV,KAAa,EACbW,WAAoB;EAEpB,MAAMC,cAAc,GAClBF,cAAc,CAACG,cAAc,CAACC,mBAAmB,KAAK,IAAI;EAE5D,IAAI,CAACJ,cAAc,CAACG,cAAc,CAACE,YAAY,IAAI,CAACH,cAAc,EAAE;IAClEF,cAAc,CAACG,cAAc,CAACE,YAAY,GACxCC,QAAQ,CAACC,aAAa,CAAC,QAAQ,CAAC;;EAGpC,MAAMF,YAAY,GAAGL,cAAc,CAACG,cAAc,CAACE,YAAY;EAK/D,MAAM;IAAET,WAAW;IAAEF;EAAY,CAAE,GAAGM,cAAc,CAACT,QAAQ,CAACI,GAAG;EACjE,IACE,CAACC,WAAW,KAAK,GAAG,IAAIA,WAAW,KAAK,GAAG,MAC1CF,YAAY,KAAK,GAAG,IAAIA,YAAY,KAAK,GAAG,CAAC,IAC9CM,cAAc,CAACT,QAAQ,CAACM,MAAM,KAAK,KAAK,IACxCP,KAAK,CAACkB,SAAS,IACflB,KAAK,CAACkB,SAAS,EAAE,EACjB;IACA,OAAOlB,KAAK,CAACkB,SAAS,EAAE;;EAI1B,IACEtB,yBAAyB,CAACc,cAAc,EAAEV,KAAK,CAAC,KAAK,KAAK,IAC1DW,WAAW,KAAK,IAAI,EACpB;IACA,OAAOI,YAAY;;EAMrB,IACEA,YAAY,CAACI,KAAK,KAAKnB,KAAK,CAACmB,KAAK,IAClCJ,YAAY,CAACK,MAAM,KAAKpB,KAAK,CAACoB,MAAM,EACpC;IACAvB,sBAAsB,CAACa,cAAc,EAAEV,KAAK,CAAC;;EAI/C,IAAIqB,KAAK,GAAG9B,GAAG,EAAE;EACjB,MAAM+B,QAAQ,GAAGvB,MAAM,CAACC,KAAK,EAAEU,cAAc,CAACT,QAAQ,CAAC;EAEvDD,KAAK,CAACuB,KAAK,GAAGvB,KAAK,CAACuB,KAAK,IAAI,EAAE;EAC/BvB,KAAK,CAACuB,KAAK,CAACC,mBAAmB,GAAGjC,GAAG,EAAE,GAAG8B,KAAK;EAE/C,MAAMI,gBAAgB,GAAGf,cAAc,CAACG,cAAc,CAACY,gBAAgB;EACvE,MAAMC,mBAAmB,GAAGhB,cAAc,CAACG,cAAc,CAACa,mBAAmB;EAI7E,IAAI1B,KAAK,CAAC2B,IAAI,EAAE;IACdjC,oCAAoC,CAClCM,KAAK,EACLsB,QAAQ,EACRG,gBAAgB,CAACG,IAAI,CACtB;GACF,MAAM;IACLnC,qCAAqC,CACnCO,KAAK,EACLsB,QAAQ,EACRG,gBAAgB,CAACG,IAAI,CACtB;;EAGHP,KAAK,GAAG9B,GAAG,EAAE;EACbmC,mBAAmB,CAACG,YAAY,CAACJ,gBAAgB,EAAE,CAAC,EAAE,CAAC,CAAC;EACxDzB,KAAK,CAACuB,KAAK,CAACO,oBAAoB,GAAGvC,GAAG,EAAE,GAAG8B,KAAK;EAEhD,OAAON,YAAY;AACrB;AAUA,OAAM,SAAUgB,gBAAgBA,CAC9BrB,cAAyC,EACzCC,WAAoB;EAEpB,IAAID,cAAc,KAAKP,SAAS,EAAE;IAChC,MAAM,IAAI6B,KAAK,CACb,kEAAkE,CACnE;;EAGH,MAAMhC,KAAK,GAAGU,cAAc,CAACV,KAAK;EAElC,IAAIA,KAAK,KAAKG,SAAS,EAAE;IACvB,MAAM,IAAI6B,KAAK,CACb,+DAA+D,CAChE;;EAIH,MAAMC,OAAO,GAAGvB,cAAc,CAACwB,MAAM,CAACC,UAAU,CAAC,IAAI,CAAC;EAEtDF,OAAO,CAACG,YAAY,CAAC,CAAC,EAAE,CAAC,EAAE,CAAC,EAAE,CAAC,EAAE,CAAC,EAAE,CAAC,CAAC;EAGtCH,OAAO,CAACI,SAAS,GAAG,OAAO;EAC3BJ,OAAO,CAACK,QAAQ,CACd,CAAC,EACD,CAAC,EACD5B,cAAc,CAACwB,MAAM,CAACf,KAAK,EAC3BT,cAAc,CAACwB,MAAM,CAACd,MAAM,CAC7B;EAGDa,OAAO,CAACM,qBAAqB,GAAG,CAAC7B,cAAc,CAACT,QAAQ,CAACuC,gBAAgB;EAGzE7C,0BAA0B,CAACe,cAAc,EAAEuB,OAAO,CAAC;EAEnD,MAAMlB,YAAY,GAAGN,eAAe,CAACC,cAAc,EAAEV,KAAK,EAAEW,WAAW,CAAC;EAExE,MAAM8B,EAAE,GAAG/B,cAAc,CAACT,QAAQ,CAACyC,aAAa,CAACC,IAAI,CAACC,CAAC,GAAG,CAAC;EAC3D,MAAMC,EAAE,GAAGnC,cAAc,CAACT,QAAQ,CAACyC,aAAa,CAACC,IAAI,CAACG,CAAC,GAAG,CAAC;EAC3D,MAAM3B,KAAK,GAAGT,cAAc,CAACT,QAAQ,CAACyC,aAAa,CAACK,IAAI,CAACH,CAAC,GAAGH,EAAE;EAC/D,MAAMrB,MAAM,GAAGV,cAAc,CAACT,QAAQ,CAACyC,aAAa,CAACK,IAAI,CAACD,CAAC,GAAGD,EAAE;EAEhEZ,OAAO,CAACe,SAAS,CAACjC,YAAY,EAAE0B,EAAE,EAAEI,EAAE,EAAE1B,KAAK,EAAEC,MAAM,EAAE,CAAC,EAAE,CAAC,EAAED,KAAK,EAAEC,MAAM,CAAC;EAE3EV,cAAc,CAACG,cAAc,GAAGf,gBAAgB,CAACY,cAAc,CAAC;AAClE"},"metadata":{},"sourceType":"module","externalDependencies":[]}