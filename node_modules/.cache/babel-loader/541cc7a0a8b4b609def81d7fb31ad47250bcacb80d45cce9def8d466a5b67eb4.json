{"ast":null,"code":"import { BaseVolumeViewport, cache, getEnabledElement, metaData } from '@cornerstonejs/core';\nimport { vec2 } from 'gl-matrix';\nimport AnnotationDisplayTool from './AnnotationDisplayTool';\nimport { isAnnotationLocked } from '../../stateManagement/annotation/annotationLocking';\nimport { isAnnotationVisible } from '../../stateManagement/annotation/annotationVisibility';\nclass AnnotationTool extends AnnotationDisplayTool {\n  constructor(toolProps, defaultToolProps) {\n    super(toolProps, defaultToolProps);\n    this.mouseMoveCallback = (evt, filteredAnnotations) => {\n      if (!filteredAnnotations) {\n        return false;\n      }\n      const {\n        element,\n        currentPoints\n      } = evt.detail;\n      const canvasCoords = currentPoints.canvas;\n      let annotationsNeedToBeRedrawn = false;\n      for (const annotation of filteredAnnotations) {\n        if (isAnnotationLocked(annotation) || !isAnnotationVisible(annotation.annotationUID)) {\n          continue;\n        }\n        const {\n          data\n        } = annotation;\n        const activateHandleIndex = data.handles ? data.handles.activeHandleIndex : undefined;\n        const near = this._imagePointNearToolOrHandle(element, annotation, canvasCoords, 6);\n        const nearToolAndNotMarkedActive = near && !annotation.highlighted;\n        const notNearToolAndMarkedActive = !near && annotation.highlighted;\n        if (nearToolAndNotMarkedActive || notNearToolAndMarkedActive) {\n          annotation.highlighted = !annotation.highlighted;\n          annotationsNeedToBeRedrawn = true;\n        } else if (data.handles && data.handles.activeHandleIndex !== activateHandleIndex) {\n          annotationsNeedToBeRedrawn = true;\n        }\n      }\n      return annotationsNeedToBeRedrawn;\n    };\n    if (toolProps.configuration?.getTextLines) {\n      this.configuration.getTextLines = toolProps.configuration.getTextLines;\n    }\n    if (toolProps.configuration?.statsCalculator) {\n      this.configuration.statsCalculator = toolProps.configuration.statsCalculator;\n    }\n  }\n  getHandleNearImagePoint(element, annotation, canvasCoords, proximity) {\n    const enabledElement = getEnabledElement(element);\n    const {\n      viewport\n    } = enabledElement;\n    const {\n      data\n    } = annotation;\n    const {\n      points,\n      textBox\n    } = data.handles;\n    if (textBox) {\n      const {\n        worldBoundingBox\n      } = textBox;\n      if (worldBoundingBox) {\n        const canvasBoundingBox = {\n          topLeft: viewport.worldToCanvas(worldBoundingBox.topLeft),\n          topRight: viewport.worldToCanvas(worldBoundingBox.topRight),\n          bottomLeft: viewport.worldToCanvas(worldBoundingBox.bottomLeft),\n          bottomRight: viewport.worldToCanvas(worldBoundingBox.bottomRight)\n        };\n        if (canvasCoords[0] >= canvasBoundingBox.topLeft[0] && canvasCoords[0] <= canvasBoundingBox.bottomRight[0] && canvasCoords[1] >= canvasBoundingBox.topLeft[1] && canvasCoords[1] <= canvasBoundingBox.bottomRight[1]) {\n          data.handles.activeHandleIndex = null;\n          return textBox;\n        }\n      }\n    }\n    for (let i = 0; i < points.length; i++) {\n      const point = points[i];\n      const annotationCanvasCoordinate = viewport.worldToCanvas(point);\n      const near = vec2.distance(canvasCoords, annotationCanvasCoordinate) < proximity;\n      if (near === true) {\n        data.handles.activeHandleIndex = i;\n        return point;\n      }\n    }\n    data.handles.activeHandleIndex = null;\n  }\n  getLinkedTextBoxStyle(specifications, annotation) {\n    return {\n      visibility: this.getStyle('textBoxVisibility', specifications, annotation),\n      fontFamily: this.getStyle('textBoxFontFamily', specifications, annotation),\n      fontSize: this.getStyle('textBoxFontSize', specifications, annotation),\n      color: this.getStyle('textBoxColor', specifications, annotation),\n      shadow: this.getStyle('textBoxShadow', specifications, annotation),\n      background: this.getStyle('textBoxBackground', specifications, annotation),\n      lineWidth: this.getStyle('textBoxLinkLineWidth', specifications, annotation),\n      lineDash: this.getStyle('textBoxLinkLineDash', specifications, annotation)\n    };\n  }\n  isSuvScaled(viewport, targetId, imageId) {\n    if (viewport instanceof BaseVolumeViewport) {\n      const volumeId = targetId.split('volumeId:')[1];\n      const volume = cache.getVolume(volumeId);\n      return volume.scaling?.PT !== undefined;\n    }\n    const scalingModule = imageId && metaData.get('scalingModule', imageId);\n    return typeof scalingModule?.suvbw === 'number';\n  }\n  getAnnotationStyle(context) {\n    const {\n      annotation,\n      styleSpecifier\n    } = context;\n    const getStyle = property => this.getStyle(property, styleSpecifier, annotation);\n    const {\n      annotationUID\n    } = annotation;\n    const visibility = isAnnotationVisible(annotationUID);\n    const locked = isAnnotationLocked(annotation);\n    const lineWidth = getStyle('lineWidth');\n    const lineDash = getStyle('lineDash');\n    const color = getStyle('color');\n    const shadow = getStyle('shadow');\n    const textboxStyle = this.getLinkedTextBoxStyle(styleSpecifier, annotation);\n    return {\n      visibility,\n      locked,\n      color,\n      lineWidth,\n      lineDash,\n      lineOpacity: 1,\n      fillColor: color,\n      fillOpacity: 0,\n      shadow,\n      textbox: textboxStyle\n    };\n  }\n  _imagePointNearToolOrHandle(element, annotation, canvasCoords, proximity) {\n    const handleNearImagePoint = this.getHandleNearImagePoint(element, annotation, canvasCoords, proximity);\n    if (handleNearImagePoint) {\n      return true;\n    }\n    const toolNewImagePoint = this.isPointNearTool(element, annotation, canvasCoords, proximity, 'mouse');\n    if (toolNewImagePoint) {\n      return true;\n    }\n  }\n}\nAnnotationTool.toolName = 'AnnotationTool';\nexport default AnnotationTool;","map":{"version":3,"names":["BaseVolumeViewport","cache","getEnabledElement","metaData","vec2","AnnotationDisplayTool","isAnnotationLocked","isAnnotationVisible","AnnotationTool","constructor","toolProps","defaultToolProps","mouseMoveCallback","evt","filteredAnnotations","element","currentPoints","detail","canvasCoords","canvas","annotationsNeedToBeRedrawn","annotation","annotationUID","data","activateHandleIndex","handles","activeHandleIndex","undefined","near","_imagePointNearToolOrHandle","nearToolAndNotMarkedActive","highlighted","notNearToolAndMarkedActive","configuration","getTextLines","statsCalculator","getHandleNearImagePoint","proximity","enabledElement","viewport","points","textBox","worldBoundingBox","canvasBoundingBox","topLeft","worldToCanvas","topRight","bottomLeft","bottomRight","i","length","point","annotationCanvasCoordinate","distance","getLinkedTextBoxStyle","specifications","visibility","getStyle","fontFamily","fontSize","color","shadow","background","lineWidth","lineDash","isSuvScaled","targetId","imageId","volumeId","split","volume","getVolume","scaling","PT","scalingModule","get","suvbw","getAnnotationStyle","context","styleSpecifier","property","locked","textboxStyle","lineOpacity","fillColor","fillOpacity","textbox","handleNearImagePoint","toolNewImagePoint","isPointNearTool","toolName"],"sources":["../../../../src/tools/base/AnnotationTool.ts"],"sourcesContent":[null],"mappings":"AAAA,SACEA,kBAAkB,EAClBC,KAAK,EACLC,iBAAiB,EACjBC,QAAQ,QACH,qBAAqB;AAG5B,SAASC,IAAI,QAAQ,WAAW;AAEhC,OAAOC,qBAAqB,MAAM,yBAAyB;AAC3D,SAASC,kBAAkB,QAAQ,oDAAoD;AACvF,SAASC,mBAAmB,QAAQ,uDAAuD;AAsB3F,MAAeC,cAAe,SAAQH,qBAAqB;EAMzDI,YAAYC,SAA0B,EAAEC,gBAA2B;IACjE,KAAK,CAACD,SAAS,EAAEC,gBAAgB,CAAC;IAqF7B,KAAAC,iBAAiB,GAAG,CACzBC,GAAkC,EAClCC,mBAAiC,KACtB;MACX,IAAI,CAACA,mBAAmB,EAAE;QACxB,OAAO,KAAK;;MAGd,MAAM;QAAEC,OAAO;QAAEC;MAAa,CAAE,GAAGH,GAAG,CAACI,MAAM;MAC7C,MAAMC,YAAY,GAAGF,aAAa,CAACG,MAAM;MACzC,IAAIC,0BAA0B,GAAG,KAAK;MAEtC,KAAK,MAAMC,UAAU,IAAIP,mBAAmB,EAAE;QAE5C,IACER,kBAAkB,CAACe,UAAU,CAAC,IAC9B,CAACd,mBAAmB,CAACc,UAAU,CAACC,aAAa,CAAC,EAC9C;UACA;;QAGF,MAAM;UAAEC;QAAI,CAAE,GAAGF,UAAU;QAC3B,MAAMG,mBAAmB,GAAGD,IAAI,CAACE,OAAO,GACpCF,IAAI,CAACE,OAAO,CAACC,iBAAiB,GAC9BC,SAAS;QAIb,MAAMC,IAAI,GAAG,IAAI,CAACC,2BAA2B,CAC3Cd,OAAO,EACPM,UAAU,EACVH,YAAY,EACZ,CAAC,CACF;QAED,MAAMY,0BAA0B,GAAGF,IAAI,IAAI,CAACP,UAAU,CAACU,WAAW;QAClE,MAAMC,0BAA0B,GAAG,CAACJ,IAAI,IAAIP,UAAU,CAACU,WAAW;QAClE,IAAID,0BAA0B,IAAIE,0BAA0B,EAAE;UAC5DX,UAAU,CAACU,WAAW,GAAG,CAACV,UAAU,CAACU,WAAW;UAChDX,0BAA0B,GAAG,IAAI;SAClC,MAAM,IACLG,IAAI,CAACE,OAAO,IACZF,IAAI,CAACE,OAAO,CAACC,iBAAiB,KAAKF,mBAAmB,EACtD;UAEAJ,0BAA0B,GAAG,IAAI;;;MAIrC,OAAOA,0BAA0B;IACnC,CAAC;IArIC,IAAIV,SAAS,CAACuB,aAAa,EAAEC,YAAY,EAAE;MACzC,IAAI,CAACD,aAAa,CAACC,YAAY,GAAGxB,SAAS,CAACuB,aAAa,CAACC,YAAY;;IAGxE,IAAIxB,SAAS,CAACuB,aAAa,EAAEE,eAAe,EAAE;MAC5C,IAAI,CAACF,aAAa,CAACE,eAAe,GAChCzB,SAAS,CAACuB,aAAa,CAACE,eAAe;;EAE7C;EA4IAC,uBAAuBA,CACrBrB,OAAuB,EACvBM,UAAsB,EACtBH,YAA0B,EAC1BmB,SAAiB;IAEjB,MAAMC,cAAc,GAAGpC,iBAAiB,CAACa,OAAO,CAAC;IACjD,MAAM;MAAEwB;IAAQ,CAAE,GAAGD,cAAc;IAEnC,MAAM;MAAEf;IAAI,CAAE,GAAGF,UAAU;IAC3B,MAAM;MAAEmB,MAAM;MAAEC;IAAO,CAAE,GAAGlB,IAAI,CAACE,OAAO;IAExC,IAAIgB,OAAO,EAAE;MACX,MAAM;QAAEC;MAAgB,CAAE,GAAGD,OAAO;MACpC,IAAIC,gBAAgB,EAAE;QACpB,MAAMC,iBAAiB,GAAG;UACxBC,OAAO,EAAEL,QAAQ,CAACM,aAAa,CAACH,gBAAgB,CAACE,OAAO,CAAC;UACzDE,QAAQ,EAAEP,QAAQ,CAACM,aAAa,CAACH,gBAAgB,CAACI,QAAQ,CAAC;UAC3DC,UAAU,EAAER,QAAQ,CAACM,aAAa,CAACH,gBAAgB,CAACK,UAAU,CAAC;UAC/DC,WAAW,EAAET,QAAQ,CAACM,aAAa,CAACH,gBAAgB,CAACM,WAAW;SACjE;QAED,IACE9B,YAAY,CAAC,CAAC,CAAC,IAAIyB,iBAAiB,CAACC,OAAO,CAAC,CAAC,CAAC,IAC/C1B,YAAY,CAAC,CAAC,CAAC,IAAIyB,iBAAiB,CAACK,WAAW,CAAC,CAAC,CAAC,IACnD9B,YAAY,CAAC,CAAC,CAAC,IAAIyB,iBAAiB,CAACC,OAAO,CAAC,CAAC,CAAC,IAC/C1B,YAAY,CAAC,CAAC,CAAC,IAAIyB,iBAAiB,CAACK,WAAW,CAAC,CAAC,CAAC,EACnD;UACAzB,IAAI,CAACE,OAAO,CAACC,iBAAiB,GAAG,IAAI;UACrC,OAAOe,OAAqB;;;;IAKlC,KAAK,IAAIQ,CAAC,GAAG,CAAC,EAAEA,CAAC,GAAGT,MAAM,CAACU,MAAM,EAAED,CAAC,EAAE,EAAE;MACtC,MAAME,KAAK,GAAGX,MAAM,CAACS,CAAC,CAAC;MACvB,MAAMG,0BAA0B,GAAGb,QAAQ,CAACM,aAAa,CAACM,KAAK,CAAC;MAEhE,MAAMvB,IAAI,GACRxB,IAAI,CAACiD,QAAQ,CAACnC,YAAY,EAAEkC,0BAA0B,CAAC,GAAGf,SAAS;MAErE,IAAIT,IAAI,KAAK,IAAI,EAAE;QACjBL,IAAI,CAACE,OAAO,CAACC,iBAAiB,GAAGuB,CAAC;QAClC,OAAOE,KAAK;;;IAIhB5B,IAAI,CAACE,OAAO,CAACC,iBAAiB,GAAG,IAAI;EACvC;EAYO4B,qBAAqBA,CAC1BC,cAA8B,EAC9BlC,UAAuB;IAKvB,OAAO;MACLmC,UAAU,EAAE,IAAI,CAACC,QAAQ,CACvB,mBAAmB,EACnBF,cAAc,EACdlC,UAAU,CACX;MACDqC,UAAU,EAAE,IAAI,CAACD,QAAQ,CACvB,mBAAmB,EACnBF,cAAc,EACdlC,UAAU,CACX;MACDsC,QAAQ,EAAE,IAAI,CAACF,QAAQ,CAAC,iBAAiB,EAAEF,cAAc,EAAElC,UAAU,CAAC;MACtEuC,KAAK,EAAE,IAAI,CAACH,QAAQ,CAAC,cAAc,EAAEF,cAAc,EAAElC,UAAU,CAAC;MAChEwC,MAAM,EAAE,IAAI,CAACJ,QAAQ,CAAC,eAAe,EAAEF,cAAc,EAAElC,UAAU,CAAC;MAClEyC,UAAU,EAAE,IAAI,CAACL,QAAQ,CACvB,mBAAmB,EACnBF,cAAc,EACdlC,UAAU,CACX;MACD0C,SAAS,EAAE,IAAI,CAACN,QAAQ,CACtB,sBAAsB,EACtBF,cAAc,EACdlC,UAAU,CACX;MACD2C,QAAQ,EAAE,IAAI,CAACP,QAAQ,CACrB,qBAAqB,EACrBF,cAAc,EACdlC,UAAU;KAEb;EACH;EASA4C,WAAWA,CACT1B,QAAsD,EACtD2B,QAAgB,EAChBC,OAAgB;IAEhB,IAAI5B,QAAQ,YAAYvC,kBAAkB,EAAE;MAC1C,MAAMoE,QAAQ,GAAGF,QAAQ,CAACG,KAAK,CAAC,WAAW,CAAC,CAAC,CAAC,CAAC;MAC/C,MAAMC,MAAM,GAAGrE,KAAK,CAACsE,SAAS,CAACH,QAAQ,CAAC;MACxC,OAAOE,MAAM,CAACE,OAAO,EAAEC,EAAE,KAAK9C,SAAS;;IAEzC,MAAM+C,aAAa,GACjBP,OAAO,IAAIhE,QAAQ,CAACwE,GAAG,CAAC,eAAe,EAAER,OAAO,CAAC;IACnD,OAAO,OAAOO,aAAa,EAAEE,KAAK,KAAK,QAAQ;EACjD;EAMUC,kBAAkBA,CAACC,OAG5B;IACC,MAAM;MAAEzD,UAAU;MAAE0D;IAAc,CAAE,GAAGD,OAAO;IAC9C,MAAMrB,QAAQ,GAAIuB,QAAQ,IACxB,IAAI,CAACvB,QAAQ,CAACuB,QAAQ,EAAED,cAAc,EAAE1D,UAAU,CAAC;IACrD,MAAM;MAAEC;IAAa,CAAE,GAAGD,UAAU;IACpC,MAAMmC,UAAU,GAAGjD,mBAAmB,CAACe,aAAa,CAAC;IACrD,MAAM2D,MAAM,GAAG3E,kBAAkB,CAACe,UAAU,CAAC;IAE7C,MAAM0C,SAAS,GAAGN,QAAQ,CAAC,WAAW,CAAW;IACjD,MAAMO,QAAQ,GAAGP,QAAQ,CAAC,UAAU,CAAW;IAC/C,MAAMG,KAAK,GAAGH,QAAQ,CAAC,OAAO,CAAW;IACzC,MAAMI,MAAM,GAAGJ,QAAQ,CAAC,QAAQ,CAAY;IAC5C,MAAMyB,YAAY,GAAG,IAAI,CAAC5B,qBAAqB,CAACyB,cAAc,EAAE1D,UAAU,CAAC;IAE3E,OAAO;MACLmC,UAAU;MACVyB,MAAM;MACNrB,KAAK;MACLG,SAAS;MACTC,QAAQ;MACRmB,WAAW,EAAE,CAAC;MACdC,SAAS,EAAExB,KAAK;MAChByB,WAAW,EAAE,CAAC;MACdxB,MAAM;MACNyB,OAAO,EAAEJ;KACV;EACH;EAYQrD,2BAA2BA,CACjCd,OAAuB,EACvBM,UAAsB,EACtBH,YAA0B,EAC1BmB,SAAiB;IAGjB,MAAMkD,oBAAoB,GAAG,IAAI,CAACnD,uBAAuB,CACvDrB,OAAO,EACPM,UAAU,EACVH,YAAY,EACZmB,SAAS,CACV;IAED,IAAIkD,oBAAoB,EAAE;MACxB,OAAO,IAAI;;IAIb,MAAMC,iBAAiB,GAAG,IAAI,CAACC,eAAe,CAC5C1E,OAAO,EACPM,UAAU,EACVH,YAAY,EACZmB,SAAS,EACT,OAAO,CACR;IAED,IAAImD,iBAAiB,EAAE;MACrB,OAAO,IAAI;;EAEf;;AAGFhF,cAAc,CAACkF,QAAQ,GAAG,gBAAgB;AAC1C,eAAelF,cAAc"},"metadata":{},"sourceType":"module","externalDependencies":[]}