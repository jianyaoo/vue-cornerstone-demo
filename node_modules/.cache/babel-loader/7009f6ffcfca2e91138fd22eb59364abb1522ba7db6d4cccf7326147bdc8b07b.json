{"ast":null,"code":"import \"core-js/modules/es.array.push.js\";\nimport { getEnabledElement, StackViewport, Enums } from '@cornerstonejs/core';\nimport { getToolState } from './state';\nexport const requestType = Enums.RequestType.Prefetch;\nexport const priority = 0;\nexport function range(lowEnd, highEnd) {\n  lowEnd = Math.round(lowEnd) || 0;\n  highEnd = Math.round(highEnd) || 0;\n  const arr = [];\n  let c = highEnd - lowEnd + 1;\n  if (c <= 0) {\n    return arr;\n  }\n  while (c--) {\n    arr[c] = highEnd--;\n  }\n  return arr;\n}\nexport function nearestIndex(arr, x) {\n  let low = 0;\n  let high = arr.length - 1;\n  arr.forEach((v, idx) => {\n    if (v < x) {\n      low = Math.max(idx, low);\n    } else if (v > x) {\n      high = Math.min(idx, high);\n    }\n  });\n  return {\n    low,\n    high\n  };\n}\nexport function getStackData(element) {\n  const enabledElement = getEnabledElement(element);\n  if (!enabledElement) {\n    return null;\n  }\n  const {\n    viewport\n  } = enabledElement;\n  if (!(viewport instanceof StackViewport)) {\n    console.warn('stackPrefetch: element must be a StackViewport, VolumeViewport stackPrefetch not yet implemented');\n    return null;\n  }\n  return {\n    currentImageIdIndex: viewport.getCurrentImageIdIndex(),\n    imageIds: viewport.getImageIds()\n  };\n}\nexport function getPromiseRemovedHandler(element) {\n  return function (e) {\n    const eventData = e.detail;\n    let stackData;\n    try {\n      stackData = getStackData(element);\n    } catch (error) {\n      return;\n    }\n    if (!stackData || !stackData.imageIds || stackData.imageIds.length === 0) {\n      return;\n    }\n    const stack = stackData;\n    const imageIdIndex = stack.imageIds.indexOf(eventData.imageId);\n    if (imageIdIndex < 0) {\n      return;\n    }\n    const stackPrefetchData = getToolState(element);\n    if (!stackPrefetchData || !stackPrefetchData.data || !stackPrefetchData.data.length) {\n      return;\n    }\n    stackPrefetchData.indicesToRequest.push(imageIdIndex);\n  };\n}\nexport const clearFromImageIds = stack => {\n  const imageIdSet = new Set(stack.imageIds);\n  return requestDetails => requestDetails.type !== requestType || !imageIdSet.has(requestDetails.additionalDetails.imageId);\n};","map":{"version":3,"names":["getEnabledElement","StackViewport","Enums","getToolState","requestType","RequestType","Prefetch","priority","range","lowEnd","highEnd","Math","round","arr","c","nearestIndex","x","low","high","length","forEach","v","idx","max","min","getStackData","element","enabledElement","viewport","console","warn","currentImageIdIndex","getCurrentImageIdIndex","imageIds","getImageIds","getPromiseRemovedHandler","e","eventData","detail","stackData","error","stack","imageIdIndex","indexOf","imageId","stackPrefetchData","data","indicesToRequest","push","clearFromImageIds","imageIdSet","Set","requestDetails","type","has","additionalDetails"],"sources":["../../../../src/utilities/stackPrefetch/stackPrefetchUtils.ts"],"sourcesContent":[null],"mappings":"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"},"metadata":{},"sourceType":"module","externalDependencies":[]}