{"ast":null,"code":"import setToPixelCoordinateSystem from './setToPixelCoordinateSystem';\nimport now from './now';\nimport initializeRenderCanvas from './initializeRenderCanvas';\nimport getLut from './getLut';\nimport saveLastRendered from './saveLastRendered';\nimport doesImageNeedToBeRendered from './doesImageNeedToBeRendered';\nimport storedPixelDataToCanvasImageDataPseudocolorLUT from './storedPixelDataToCanvasImageDataPseudocolorLUT';\nimport storedPixelDataToCanvasImageDataPseudocolorLUTPET from './storedPixelDataToCanvasImageDataPseudocolorLUTPET';\nimport * as colors from '../colors/index';\nimport { clamp } from '../../../../utilities';\nfunction getRenderCanvas(enabledElement, image, invalidated) {\n  if (!enabledElement.renderingTools.renderCanvas) {\n    enabledElement.renderingTools.renderCanvas = document.createElement('canvas');\n  }\n  const renderCanvas = enabledElement.renderingTools.renderCanvas;\n  let colormap = enabledElement.viewport.colormap || enabledElement.options.colormap;\n  if (enabledElement.options && enabledElement.options.colormap) {\n    console.warn('enabledElement.options.colormap is deprecated. Use enabledElement.viewport.colormap instead');\n  }\n  if (colormap && typeof colormap === 'string') {\n    colormap = colors.getColormap(colormap);\n  }\n  if (!colormap) {\n    throw new Error('renderPseudoColorImage: colormap not found.');\n  }\n  const colormapId = colormap.getId();\n  if (doesImageNeedToBeRendered(enabledElement, image) === false && invalidated !== true && enabledElement.renderingTools.colormapId === colormapId) {\n    return renderCanvas;\n  }\n  if (renderCanvas.width !== image.width || renderCanvas.height !== image.height) {\n    initializeRenderCanvas(enabledElement, image);\n  }\n  let start = now();\n  if (!enabledElement.renderingTools.colorLUT || invalidated || enabledElement.renderingTools.colormapId !== colormapId) {\n    colormap.setNumberOfColors(256);\n    enabledElement.renderingTools.colorLUT = colormap.createLookupTable();\n    enabledElement.renderingTools.colormapId = colormapId;\n  }\n  const renderCanvasData = enabledElement.renderingTools.renderCanvasData;\n  const renderCanvasContext = enabledElement.renderingTools.renderCanvasContext;\n  const {\n    viewport\n  } = enabledElement;\n  const colorLUT = enabledElement.renderingTools.colorLUT;\n  if (viewport.modality === 'PT') {\n    const {\n      windowWidth,\n      windowCenter\n    } = viewport.voi;\n    const minimum = windowCenter - windowWidth / 2;\n    const maximum = windowCenter + windowWidth / 2;\n    const range = maximum - minimum;\n    const collectedMultiplierTerms = 255.0 / range;\n    let petVOILutFunction;\n    if (viewport.invert) {\n      petVOILutFunction = value => {\n        return clamp(Math.floor(255 - (value - minimum) * collectedMultiplierTerms), 0, 255);\n      };\n    } else {\n      petVOILutFunction = value => {\n        return clamp(Math.floor((value - minimum) * collectedMultiplierTerms), 0, 255);\n      };\n    }\n    storedPixelDataToCanvasImageDataPseudocolorLUTPET(image, petVOILutFunction, colorLUT, renderCanvasData.data);\n  } else {\n    const lut = getLut(image, enabledElement.viewport, invalidated);\n    image.stats = image.stats || {};\n    image.stats.lastLutGenerateTime = now() - start;\n    storedPixelDataToCanvasImageDataPseudocolorLUT(image, lut, colorLUT, renderCanvasData.data);\n  }\n  start = now();\n  renderCanvasContext.putImageData(renderCanvasData, 0, 0);\n  image.stats.lastPutImageDataTime = now() - start;\n  return renderCanvas;\n}\nexport function renderPseudoColorImage(enabledElement, invalidated) {\n  if (enabledElement === undefined) {\n    throw new Error('drawImage: enabledElement parameter must not be undefined');\n  }\n  const image = enabledElement.image;\n  if (image === undefined) {\n    throw new Error('drawImage: image must be loaded before it can be drawn');\n  }\n  const context = enabledElement.canvas.getContext('2d');\n  context.setTransform(1, 0, 0, 1, 0, 0);\n  context.fillStyle = 'black';\n  context.fillRect(0, 0, enabledElement.canvas.width, enabledElement.canvas.height);\n  context.imageSmoothingEnabled = !enabledElement.viewport.pixelReplication;\n  setToPixelCoordinateSystem(enabledElement, context);\n  const renderCanvas = getRenderCanvas(enabledElement, image, invalidated);\n  const sx = enabledElement.viewport.displayedArea.tlhc.x - 1;\n  const sy = enabledElement.viewport.displayedArea.tlhc.y - 1;\n  const width = enabledElement.viewport.displayedArea.brhc.x - sx;\n  const height = enabledElement.viewport.displayedArea.brhc.y - sy;\n  context.drawImage(renderCanvas, sx, sy, width, height, 0, 0, width, height);\n  enabledElement.renderingTools = saveLastRendered(enabledElement);\n}","map":{"version":3,"names":["setToPixelCoordinateSystem","now","initializeRenderCanvas","getLut","saveLastRendered","doesImageNeedToBeRendered","storedPixelDataToCanvasImageDataPseudocolorLUT","storedPixelDataToCanvasImageDataPseudocolorLUTPET","colors","clamp","getRenderCanvas","enabledElement","image","invalidated","renderingTools","renderCanvas","document","createElement","colormap","viewport","options","console","warn","getColormap","Error","colormapId","getId","width","height","start","colorLUT","setNumberOfColors","createLookupTable","renderCanvasData","renderCanvasContext","modality","windowWidth","windowCenter","voi","minimum","maximum","range","collectedMultiplierTerms","petVOILutFunction","invert","value","Math","floor","data","lut","stats","lastLutGenerateTime","putImageData","lastPutImageDataTime","renderPseudoColorImage","undefined","context","canvas","getContext","setTransform","fillStyle","fillRect","imageSmoothingEnabled","pixelReplication","sx","displayedArea","tlhc","x","sy","y","brhc","drawImage"],"sources":["../../../../../../src/RenderingEngine/helpers/cpuFallback/rendering/renderPseudoColorImage.ts"],"sourcesContent":[null],"mappings":"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"},"metadata":{},"sourceType":"module","externalDependencies":[]}