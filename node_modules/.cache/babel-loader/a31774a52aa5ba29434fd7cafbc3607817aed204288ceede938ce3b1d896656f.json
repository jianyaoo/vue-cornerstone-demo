{"ast":null,"code":"var _class;\nimport \"core-js/modules/es.array.push.js\";\nimport { cache, utilities as csUtils } from '@cornerstonejs/core';\nimport { triggerSegmentationDataModified } from '../../../stateManagement/segmentation/triggerSegmentationEvents';\nimport compositions from './compositions';\nimport { getStrategyData } from './utils/getStrategyData';\nimport { isVolumeSegmentation } from './utils/stackVolumeCheck';\nimport { StrategyCallbacks } from '../../../enums';\nconst {\n  VoxelManager\n} = csUtils;\nexport default class BrushStrategy {\n  constructor(name, ...initializers) {\n    this._initialize = [];\n    this._fill = [];\n    this._onInteractionStart = [];\n    this.fill = (enabledElement, operationData) => {\n      const initializedData = this.initialize(enabledElement, operationData);\n      const {\n        strategySpecificConfiguration = {},\n        centerIJK\n      } = initializedData;\n      if (csUtils.isEqual(centerIJK, strategySpecificConfiguration.centerIJK)) {\n        return operationData.preview;\n      } else {\n        strategySpecificConfiguration.centerIJK = centerIJK;\n      }\n      this._fill.forEach(func => func(initializedData));\n      const {\n        segmentationVoxelManager,\n        previewVoxelManager,\n        previewSegmentIndex\n      } = initializedData;\n      triggerSegmentationDataModified(initializedData.segmentationId, segmentationVoxelManager.getArrayOfSlices());\n      if (!previewSegmentIndex || !previewVoxelManager.modifiedSlices.size) {\n        return null;\n      }\n      return initializedData.preview || initializedData;\n    };\n    this.onInteractionStart = (enabledElement, operationData) => {\n      const {\n        preview\n      } = operationData;\n      if (preview?.isPreviewFromHover) {\n        preview.isPreviewFromHover = false;\n        return;\n      }\n      const initializedData = this.initialize(enabledElement, operationData);\n      this._onInteractionStart.forEach(func => func.call(this, initializedData));\n    };\n    this.configurationName = name;\n    this.compositions = initializers;\n    initializers.forEach(initializer => {\n      const result = typeof initializer === 'function' ? initializer() : initializer;\n      if (!result) {\n        return;\n      }\n      for (const key in result) {\n        if (!BrushStrategy.childFunctions[key]) {\n          throw new Error(`Didn't find ${key} as a brush strategy`);\n        }\n        BrushStrategy.childFunctions[key](this, result[key]);\n      }\n    });\n    this.strategyFunction = (enabledElement, operationData) => this.fill(enabledElement, operationData);\n    for (const key of Object.keys(BrushStrategy.childFunctions)) {\n      this.strategyFunction[key] = this[key];\n    }\n  }\n  initialize(enabledElement, operationData) {\n    const {\n      viewport\n    } = enabledElement;\n    const data = getStrategyData({\n      operationData,\n      viewport\n    });\n    if (!data) {\n      console.warn('No data found for BrushStrategy');\n      return operationData.preview;\n    }\n    if (isVolumeSegmentation(operationData)) {\n      const {\n        referencedVolumeId,\n        volumeId\n      } = operationData;\n      const imageVolume = cache.getVolume(referencedVolumeId);\n      const segmentation = cache.getVolume(volumeId);\n      if (!csUtils.isEqual(segmentation.dimensions, imageVolume.dimensions) || !csUtils.isEqual(segmentation.direction, imageVolume.direction)) {\n        throw new Error('Only source data the same dimensions/size/orientation as the segmentation currently supported.');\n      }\n    }\n    const {\n      imageVoxelManager,\n      segmentationVoxelManager,\n      segmentationImageData\n    } = data;\n    const previewVoxelManager = operationData.preview?.previewVoxelManager || VoxelManager.createHistoryVoxelManager(segmentationVoxelManager);\n    const previewEnabled = !!operationData.previewColors;\n    const previewSegmentIndex = previewEnabled ? 255 : undefined;\n    const initializedData = {\n      previewSegmentIndex,\n      ...operationData,\n      enabledElement,\n      imageVoxelManager,\n      segmentationVoxelManager,\n      segmentationImageData,\n      previewVoxelManager,\n      viewport,\n      centerWorld: null,\n      brushStrategy: this\n    };\n    this._initialize.forEach(func => func(initializedData));\n    return initializedData;\n  }\n}\n_class = BrushStrategy;\n_class.COMPOSITIONS = compositions;\n_class.childFunctions = {\n  [StrategyCallbacks.OnInteractionStart]: addListMethod(StrategyCallbacks.OnInteractionStart, StrategyCallbacks.Initialize),\n  [StrategyCallbacks.OnInteractionEnd]: addListMethod(StrategyCallbacks.OnInteractionEnd, StrategyCallbacks.Initialize),\n  [StrategyCallbacks.Fill]: addListMethod(StrategyCallbacks.Fill),\n  [StrategyCallbacks.Initialize]: addListMethod(StrategyCallbacks.Initialize),\n  [StrategyCallbacks.CreateIsInThreshold]: addSingletonMethod(StrategyCallbacks.CreateIsInThreshold),\n  [StrategyCallbacks.AcceptPreview]: addListMethod(StrategyCallbacks.AcceptPreview, StrategyCallbacks.Initialize),\n  [StrategyCallbacks.RejectPreview]: addListMethod(StrategyCallbacks.RejectPreview, StrategyCallbacks.Initialize),\n  [StrategyCallbacks.INTERNAL_setValue]: addSingletonMethod(StrategyCallbacks.INTERNAL_setValue),\n  [StrategyCallbacks.Preview]: addSingletonMethod(StrategyCallbacks.Preview, false),\n  compositions: null\n};\nfunction addListMethod(name, createInitialized) {\n  const listName = `_${name}`;\n  return (brushStrategy, func) => {\n    brushStrategy[listName] ||= [];\n    brushStrategy[listName].push(func);\n    brushStrategy[name] ||= createInitialized ? (enabledElement, operationData) => {\n      const initializedData = brushStrategy[createInitialized](enabledElement, operationData);\n      brushStrategy[listName].forEach(func => func.call(brushStrategy, initializedData));\n    } : operationData => {\n      brushStrategy[listName].forEach(func => func.call(brushStrategy, operationData));\n    };\n  };\n}\nfunction addSingletonMethod(name, isInitialized = true) {\n  return (brushStrategy, func) => {\n    if (brushStrategy[name]) {\n      throw new Error(`The singleton method ${name} already exists`);\n    }\n    brushStrategy[name] = isInitialized ? func : (enabledElement, operationData) => {\n      operationData.enabledElement = enabledElement;\n      return func.call(brushStrategy, operationData);\n    };\n  };\n}","map":{"version":3,"names":["cache","utilities","csUtils","triggerSegmentationDataModified","compositions","getStrategyData","isVolumeSegmentation","StrategyCallbacks","VoxelManager","BrushStrategy","constructor","name","initializers","_initialize","_fill","_onInteractionStart","fill","enabledElement","operationData","initializedData","initialize","strategySpecificConfiguration","centerIJK","isEqual","preview","forEach","func","segmentationVoxelManager","previewVoxelManager","previewSegmentIndex","segmentationId","getArrayOfSlices","modifiedSlices","size","onInteractionStart","isPreviewFromHover","call","configurationName","initializer","result","key","childFunctions","Error","strategyFunction","Object","keys","viewport","data","console","warn","referencedVolumeId","volumeId","imageVolume","getVolume","segmentation","dimensions","direction","imageVoxelManager","segmentationImageData","createHistoryVoxelManager","previewEnabled","previewColors","undefined","centerWorld","brushStrategy","_class","COMPOSITIONS","OnInteractionStart","addListMethod","Initialize","OnInteractionEnd","Fill","CreateIsInThreshold","addSingletonMethod","AcceptPreview","RejectPreview","INTERNAL_setValue","Preview","createInitialized","listName","push","isInitialized"],"sources":["../../../../../src/tools/segmentation/strategies/BrushStrategy.ts"],"sourcesContent":[null],"mappings":"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"},"metadata":{},"sourceType":"module","externalDependencies":[]}