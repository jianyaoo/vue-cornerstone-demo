{"ast":null,"code":"import \"core-js/modules/es.array.push.js\";\nimport { vec2 } from 'gl-matrix';\nimport { getEnabledElement, VolumeViewport, triggerEvent, eventTarget, utilities as csUtils } from '@cornerstonejs/core';\nimport { AnnotationTool } from '../base';\nimport { addAnnotation, getAnnotations, removeAnnotation } from '../../stateManagement/annotation/annotationState';\nimport { getCalibratedProbeUnitsAndValue } from '../../utilities/getCalibratedUnits';\nimport { drawHandles as drawHandlesSvg, drawTextBox as drawTextBoxSvg } from '../../drawingSvg';\nimport { state } from '../../store';\nimport { Events } from '../../enums';\nimport { getViewportIdsWithToolToRender } from '../../utilities/viewportFilters';\nimport { roundNumber } from '../../utilities';\nimport { resetElementCursor, hideElementCursor } from '../../cursors/elementCursor';\nimport triggerAnnotationRenderForViewportIds from '../../utilities/triggerAnnotationRenderForViewportIds';\nimport { getModalityUnit } from '../../utilities/getModalityUnit';\nimport { isViewportPreScaled } from '../../utilities/viewport/isViewportPreScaled';\nconst {\n  transformWorldToIndex\n} = csUtils;\nclass ProbeTool extends AnnotationTool {\n  constructor(toolProps = {}, defaultToolProps = {\n    supportedInteractionTypes: ['Mouse', 'Touch'],\n    configuration: {\n      shadow: true,\n      preventHandleOutsideImage: false,\n      getTextLines: defaultGetTextLines\n    }\n  }) {\n    super(toolProps, defaultToolProps);\n    this.addNewAnnotation = evt => {\n      const eventDetail = evt.detail;\n      const {\n        currentPoints,\n        element\n      } = eventDetail;\n      const worldPos = currentPoints.world;\n      const enabledElement = getEnabledElement(element);\n      const {\n        viewport,\n        renderingEngine\n      } = enabledElement;\n      this.isDrawing = true;\n      const camera = viewport.getCamera();\n      const {\n        viewPlaneNormal,\n        viewUp\n      } = camera;\n      const referencedImageId = this.getReferencedImageId(viewport, worldPos, viewPlaneNormal, viewUp);\n      const FrameOfReferenceUID = viewport.getFrameOfReferenceUID();\n      const annotation = {\n        invalidated: true,\n        highlighted: true,\n        metadata: {\n          toolName: this.getToolName(),\n          viewPlaneNormal: [...viewPlaneNormal],\n          viewUp: [...viewUp],\n          FrameOfReferenceUID,\n          referencedImageId\n        },\n        data: {\n          label: '',\n          handles: {\n            points: [[...worldPos]]\n          },\n          cachedStats: {}\n        }\n      };\n      addAnnotation(annotation, element);\n      const viewportIdsToRender = getViewportIdsWithToolToRender(element, this.getToolName());\n      this.editData = {\n        annotation,\n        newAnnotation: true,\n        viewportIdsToRender\n      };\n      this._activateModify(element);\n      hideElementCursor(element);\n      evt.preventDefault();\n      triggerAnnotationRenderForViewportIds(renderingEngine, viewportIdsToRender);\n      return annotation;\n    };\n    this._endCallback = evt => {\n      const eventDetail = evt.detail;\n      const {\n        element\n      } = eventDetail;\n      const {\n        annotation,\n        viewportIdsToRender,\n        newAnnotation\n      } = this.editData;\n      const enabledElement = getEnabledElement(element);\n      const {\n        renderingEngine\n      } = enabledElement;\n      const {\n        viewportId\n      } = enabledElement;\n      this.eventDispatchDetail = {\n        viewportId,\n        renderingEngineId: renderingEngine.id\n      };\n      this._deactivateModify(element);\n      resetElementCursor(element);\n      this.editData = null;\n      this.isDrawing = false;\n      if (this.isHandleOutsideImage && this.configuration.preventHandleOutsideImage) {\n        removeAnnotation(annotation.annotationUID);\n      }\n      triggerAnnotationRenderForViewportIds(renderingEngine, viewportIdsToRender);\n      if (newAnnotation) {\n        const eventType = Events.ANNOTATION_COMPLETED;\n        const eventDetail = {\n          annotation\n        };\n        triggerEvent(eventTarget, eventType, eventDetail);\n      }\n    };\n    this._dragCallback = evt => {\n      this.isDrawing = true;\n      const eventDetail = evt.detail;\n      const {\n        currentPoints,\n        element\n      } = eventDetail;\n      const worldPos = currentPoints.world;\n      const {\n        annotation,\n        viewportIdsToRender\n      } = this.editData;\n      const {\n        data\n      } = annotation;\n      data.handles.points[0] = [...worldPos];\n      annotation.invalidated = true;\n      const enabledElement = getEnabledElement(element);\n      const {\n        renderingEngine\n      } = enabledElement;\n      triggerAnnotationRenderForViewportIds(renderingEngine, viewportIdsToRender);\n    };\n    this.cancel = element => {\n      if (this.isDrawing) {\n        this.isDrawing = false;\n        this._deactivateModify(element);\n        resetElementCursor(element);\n        const {\n          annotation,\n          viewportIdsToRender,\n          newAnnotation\n        } = this.editData;\n        const {\n          data\n        } = annotation;\n        annotation.highlighted = false;\n        data.handles.activeHandleIndex = null;\n        const enabledElement = getEnabledElement(element);\n        const {\n          renderingEngine\n        } = enabledElement;\n        triggerAnnotationRenderForViewportIds(renderingEngine, viewportIdsToRender);\n        if (newAnnotation) {\n          const eventType = Events.ANNOTATION_COMPLETED;\n          const eventDetail = {\n            annotation\n          };\n          triggerEvent(eventTarget, eventType, eventDetail);\n        }\n        this.editData = null;\n        return annotation.annotationUID;\n      }\n    };\n    this._activateModify = element => {\n      state.isInteractingWithTool = true;\n      element.addEventListener(Events.MOUSE_UP, this._endCallback);\n      element.addEventListener(Events.MOUSE_DRAG, this._dragCallback);\n      element.addEventListener(Events.MOUSE_CLICK, this._endCallback);\n      element.addEventListener(Events.TOUCH_END, this._endCallback);\n      element.addEventListener(Events.TOUCH_DRAG, this._dragCallback);\n      element.addEventListener(Events.TOUCH_TAP, this._endCallback);\n    };\n    this._deactivateModify = element => {\n      state.isInteractingWithTool = false;\n      element.removeEventListener(Events.MOUSE_UP, this._endCallback);\n      element.removeEventListener(Events.MOUSE_DRAG, this._dragCallback);\n      element.removeEventListener(Events.MOUSE_CLICK, this._endCallback);\n      element.removeEventListener(Events.TOUCH_END, this._endCallback);\n      element.removeEventListener(Events.TOUCH_DRAG, this._dragCallback);\n      element.removeEventListener(Events.TOUCH_TAP, this._endCallback);\n    };\n    this.renderAnnotation = (enabledElement, svgDrawingHelper) => {\n      let renderStatus = false;\n      const {\n        viewport\n      } = enabledElement;\n      const {\n        element\n      } = viewport;\n      let annotations = getAnnotations(this.getToolName(), element);\n      if (!annotations?.length) {\n        return renderStatus;\n      }\n      annotations = this.filterInteractableAnnotationsForElement(element, annotations);\n      if (!annotations?.length) {\n        return renderStatus;\n      }\n      const targetId = this.getTargetId(viewport);\n      const renderingEngine = viewport.getRenderingEngine();\n      const styleSpecifier = {\n        toolGroupId: this.toolGroupId,\n        toolName: this.getToolName(),\n        viewportId: enabledElement.viewport.id\n      };\n      for (let i = 0; i < annotations.length; i++) {\n        const annotation = annotations[i];\n        const annotationUID = annotation.annotationUID;\n        const data = annotation.data;\n        const point = data.handles.points[0];\n        const canvasCoordinates = viewport.worldToCanvas(point);\n        styleSpecifier.annotationUID = annotationUID;\n        const {\n          color\n        } = this.getAnnotationStyle({\n          annotation,\n          styleSpecifier\n        });\n        if (!data.cachedStats[targetId] || data.cachedStats[targetId].value == null) {\n          data.cachedStats[targetId] = {\n            Modality: null,\n            index: null,\n            value: null\n          };\n          this._calculateCachedStats(annotation, renderingEngine, enabledElement);\n        } else if (annotation.invalidated) {\n          this._calculateCachedStats(annotation, renderingEngine, enabledElement);\n          if (viewport instanceof VolumeViewport) {\n            const {\n              referencedImageId\n            } = annotation.metadata;\n            for (const targetId in data.cachedStats) {\n              if (targetId.startsWith('imageId')) {\n                const viewports = renderingEngine.getStackViewports();\n                const invalidatedStack = viewports.find(vp => {\n                  const referencedImageURI = csUtils.imageIdToURI(referencedImageId);\n                  const hasImageURI = vp.hasImageURI(referencedImageURI);\n                  const currentImageURI = csUtils.imageIdToURI(vp.getCurrentImageId());\n                  return hasImageURI && currentImageURI !== referencedImageURI;\n                });\n                if (invalidatedStack) {\n                  delete data.cachedStats[targetId];\n                }\n              }\n            }\n          }\n        }\n        if (!viewport.getRenderingEngine()) {\n          console.warn('Rendering Engine has been destroyed');\n          return renderStatus;\n        }\n        const handleGroupUID = '0';\n        drawHandlesSvg(svgDrawingHelper, annotationUID, handleGroupUID, [canvasCoordinates], {\n          color\n        });\n        renderStatus = true;\n        const options = this.getLinkedTextBoxStyle(styleSpecifier, annotation);\n        if (!options.visibility) {\n          continue;\n        }\n        const textLines = this.configuration.getTextLines(data, targetId);\n        if (textLines) {\n          const textCanvasCoordinates = [canvasCoordinates[0] + 6, canvasCoordinates[1] - 6];\n          const textUID = '0';\n          drawTextBoxSvg(svgDrawingHelper, annotationUID, textUID, textLines, [textCanvasCoordinates[0], textCanvasCoordinates[1]], options);\n        }\n      }\n      return renderStatus;\n    };\n  }\n  isPointNearTool() {\n    return false;\n  }\n  toolSelectedCallback() {}\n  getHandleNearImagePoint(element, annotation, canvasCoords, proximity) {\n    const enabledElement = getEnabledElement(element);\n    const {\n      viewport\n    } = enabledElement;\n    const {\n      data\n    } = annotation;\n    const point = data.handles.points[0];\n    const annotationCanvasCoordinate = viewport.worldToCanvas(point);\n    const near = vec2.distance(canvasCoords, annotationCanvasCoordinate) < proximity;\n    if (near === true) {\n      return point;\n    }\n  }\n  handleSelectedCallback(evt, annotation) {\n    const eventDetail = evt.detail;\n    const {\n      element\n    } = eventDetail;\n    annotation.highlighted = true;\n    const viewportIdsToRender = getViewportIdsWithToolToRender(element, this.getToolName());\n    this.editData = {\n      annotation,\n      viewportIdsToRender\n    };\n    this._activateModify(element);\n    hideElementCursor(element);\n    const enabledElement = getEnabledElement(element);\n    const {\n      renderingEngine\n    } = enabledElement;\n    triggerAnnotationRenderForViewportIds(renderingEngine, viewportIdsToRender);\n    evt.preventDefault();\n  }\n  _calculateCachedStats(annotation, renderingEngine, enabledElement) {\n    const data = annotation.data;\n    const {\n      viewportId,\n      renderingEngineId,\n      viewport\n    } = enabledElement;\n    const worldPos = data.handles.points[0];\n    const {\n      cachedStats\n    } = data;\n    const targetIds = Object.keys(cachedStats);\n    for (let i = 0; i < targetIds.length; i++) {\n      const targetId = targetIds[i];\n      const modalityUnitOptions = {\n        isPreScaled: isViewportPreScaled(viewport, targetId),\n        isSuvScaled: this.isSuvScaled(viewport, targetId, annotation.metadata.referencedImageId)\n      };\n      const image = this.getTargetIdImage(targetId, renderingEngine);\n      if (!image) {\n        continue;\n      }\n      const {\n        dimensions,\n        imageData,\n        metadata\n      } = image;\n      const scalarData = 'getScalarData' in image ? image.getScalarData() : image.scalarData;\n      const modality = metadata.Modality;\n      const index = transformWorldToIndex(imageData, worldPos);\n      index[0] = Math.round(index[0]);\n      index[1] = Math.round(index[1]);\n      index[2] = Math.round(index[2]);\n      const samplesPerPixel = scalarData.length / dimensions[2] / dimensions[1] / dimensions[0];\n      if (csUtils.indexWithinDimensions(index, dimensions)) {\n        this.isHandleOutsideImage = false;\n        const yMultiple = dimensions[0] * samplesPerPixel;\n        const zMultiple = dimensions[0] * dimensions[1] * samplesPerPixel;\n        const baseIndex = index[2] * zMultiple + index[1] * yMultiple + index[0] * samplesPerPixel;\n        let value = samplesPerPixel > 2 ? [scalarData[baseIndex], scalarData[baseIndex + 1], scalarData[baseIndex + 2]] : scalarData[baseIndex];\n        if (targetId.startsWith('imageId:')) {\n          const imageId = targetId.split('imageId:')[1];\n          const imageURI = csUtils.imageIdToURI(imageId);\n          const viewports = csUtils.getViewportsWithImageURI(imageURI, renderingEngineId);\n          const viewport = viewports[0];\n          index[2] = viewport.getCurrentImageIdIndex();\n        }\n        let modalityUnit;\n        if (modality === 'US') {\n          const calibratedResults = getCalibratedProbeUnitsAndValue(image, [index]);\n          const hasEnhancedRegionValues = calibratedResults.values.every(value => value !== null);\n          value = hasEnhancedRegionValues ? calibratedResults.values : value;\n          modalityUnit = hasEnhancedRegionValues ? calibratedResults.units : 'raw';\n        } else {\n          modalityUnit = getModalityUnit(modality, annotation.metadata.referencedImageId, modalityUnitOptions);\n        }\n        cachedStats[targetId] = {\n          index,\n          value,\n          Modality: modality,\n          modalityUnit\n        };\n      } else {\n        this.isHandleOutsideImage = true;\n        cachedStats[targetId] = {\n          index,\n          Modality: modality\n        };\n      }\n      annotation.invalidated = false;\n      const eventType = Events.ANNOTATION_MODIFIED;\n      const eventDetail = {\n        annotation,\n        viewportId,\n        renderingEngineId\n      };\n      triggerEvent(eventTarget, eventType, eventDetail);\n    }\n    return cachedStats;\n  }\n}\nfunction defaultGetTextLines(data, targetId) {\n  const cachedVolumeStats = data.cachedStats[targetId];\n  const {\n    index,\n    value,\n    modalityUnit\n  } = cachedVolumeStats;\n  if (value === undefined) {\n    return;\n  }\n  const textLines = [];\n  textLines.push(`(${index[0]}, ${index[1]}, ${index[2]})`);\n  if (value instanceof Array && modalityUnit instanceof Array) {\n    for (let i = 0; i < value.length; i++) {\n      textLines.push(`${roundNumber(value[i])} ${modalityUnit[i]}`);\n    }\n  } else {\n    textLines.push(`${roundNumber(value)} ${modalityUnit}`);\n  }\n  return textLines;\n}\nProbeTool.toolName = 'Probe';\nexport default ProbeTool;","map":{"version":3,"names":["vec2","getEnabledElement","VolumeViewport","triggerEvent","eventTarget","utilities","csUtils","AnnotationTool","addAnnotation","getAnnotations","removeAnnotation","getCalibratedProbeUnitsAndValue","drawHandles","drawHandlesSvg","drawTextBox","drawTextBoxSvg","state","Events","getViewportIdsWithToolToRender","roundNumber","resetElementCursor","hideElementCursor","triggerAnnotationRenderForViewportIds","getModalityUnit","isViewportPreScaled","transformWorldToIndex","ProbeTool","constructor","toolProps","defaultToolProps","supportedInteractionTypes","configuration","shadow","preventHandleOutsideImage","getTextLines","defaultGetTextLines","addNewAnnotation","evt","eventDetail","detail","currentPoints","element","worldPos","world","enabledElement","viewport","renderingEngine","isDrawing","camera","getCamera","viewPlaneNormal","viewUp","referencedImageId","getReferencedImageId","FrameOfReferenceUID","getFrameOfReferenceUID","annotation","invalidated","highlighted","metadata","toolName","getToolName","data","label","handles","points","cachedStats","viewportIdsToRender","editData","newAnnotation","_activateModify","preventDefault","_endCallback","viewportId","eventDispatchDetail","renderingEngineId","id","_deactivateModify","isHandleOutsideImage","annotationUID","eventType","ANNOTATION_COMPLETED","_dragCallback","cancel","activeHandleIndex","isInteractingWithTool","addEventListener","MOUSE_UP","MOUSE_DRAG","MOUSE_CLICK","TOUCH_END","TOUCH_DRAG","TOUCH_TAP","removeEventListener","renderAnnotation","svgDrawingHelper","renderStatus","annotations","length","filterInteractableAnnotationsForElement","targetId","getTargetId","getRenderingEngine","styleSpecifier","toolGroupId","i","point","canvasCoordinates","worldToCanvas","color","getAnnotationStyle","value","Modality","index","_calculateCachedStats","startsWith","viewports","getStackViewports","invalidatedStack","find","vp","referencedImageURI","imageIdToURI","hasImageURI","currentImageURI","getCurrentImageId","console","warn","handleGroupUID","options","getLinkedTextBoxStyle","visibility","textLines","textCanvasCoordinates","textUID","isPointNearTool","toolSelectedCallback","getHandleNearImagePoint","canvasCoords","proximity","annotationCanvasCoordinate","near","distance","handleSelectedCallback","targetIds","Object","keys","modalityUnitOptions","isPreScaled","isSuvScaled","image","getTargetIdImage","dimensions","imageData","scalarData","getScalarData","modality","Math","round","samplesPerPixel","indexWithinDimensions","yMultiple","zMultiple","baseIndex","imageId","split","imageURI","getViewportsWithImageURI","getCurrentImageIdIndex","modalityUnit","calibratedResults","hasEnhancedRegionValues","values","every","units","ANNOTATION_MODIFIED","cachedVolumeStats","undefined","push","Array"],"sources":["../../../../src/tools/annotation/ProbeTool.ts"],"sourcesContent":[null],"mappings":";AACA,SAASA,IAAI,QAAQ,WAAW;AAEhC,SACEC,iBAAiB,EACjBC,cAAc,EACdC,YAAY,EACZC,WAAW,EACXC,SAAS,IAAIC,OAAO,QACf,qBAAqB;AAG5B,SAASC,cAAc,QAAQ,SAAS;AACxC,SACEC,aAAa,EACbC,cAAc,EACdC,gBAAgB,QACX,kDAAkD;AACzD,SAASC,+BAA+B,QAAQ,oCAAoC;AACpF,SACEC,WAAW,IAAIC,cAAc,EAC7BC,WAAW,IAAIC,cAAc,QACxB,kBAAkB;AACzB,SAASC,KAAK,QAAQ,aAAa;AACnC,SAASC,MAAM,QAAQ,aAAa;AACpC,SAASC,8BAA8B,QAAQ,iCAAiC;AAChF,SAASC,WAAW,QAAQ,iBAAiB;AAC7C,SACEC,kBAAkB,EAClBC,iBAAiB,QACZ,6BAA6B;AAMpC,OAAOC,qCAAqC,MAAM,uDAAuD;AAWzG,SAEEC,eAAe,QACV,iCAAiC;AACxC,SAASC,mBAAmB,QAAQ,8CAA8C;AAElF,MAAM;EAAEC;AAAqB,CAAE,GAAGnB,OAAO;AA6CzC,MAAMoB,SAAU,SAAQnB,cAAc;EAiBpCoB,YACEC,SAAA,GAA6B,EAAE,EAC/BC,gBAAA,GAA8B;IAC5BC,yBAAyB,EAAE,CAAC,OAAO,EAAE,OAAO,CAAC;IAC7CC,aAAa,EAAE;MACbC,MAAM,EAAE,IAAI;MACZC,yBAAyB,EAAE,KAAK;MAChCC,YAAY,EAAEC;;GAEjB;IAED,KAAK,CAACP,SAAS,EAAEC,gBAAgB,CAAC;IAmBpC,KAAAO,gBAAgB,GACdC,GAAoC,IACjB;MACnB,MAAMC,WAAW,GAAGD,GAAG,CAACE,MAAM;MAC9B,MAAM;QAAEC,aAAa;QAAEC;MAAO,CAAE,GAAGH,WAAW;MAC9C,MAAMI,QAAQ,GAAGF,aAAa,CAACG,KAAK;MAEpC,MAAMC,cAAc,GAAG3C,iBAAiB,CAACwC,OAAO,CAAC;MACjD,MAAM;QAAEI,QAAQ;QAAEC;MAAe,CAAE,GAAGF,cAAc;MAEpD,IAAI,CAACG,SAAS,GAAG,IAAI;MACrB,MAAMC,MAAM,GAAGH,QAAQ,CAACI,SAAS,EAAE;MACnC,MAAM;QAAEC,eAAe;QAAEC;MAAM,CAAE,GAAGH,MAAM;MAE1C,MAAMI,iBAAiB,GAAG,IAAI,CAACC,oBAAoB,CACjDR,QAAQ,EACRH,QAAQ,EACRQ,eAAe,EACfC,MAAM,CACP;MAED,MAAMG,mBAAmB,GAAGT,QAAQ,CAACU,sBAAsB,EAAE;MAE7D,MAAMC,UAAU,GAAG;QACjBC,WAAW,EAAE,IAAI;QACjBC,WAAW,EAAE,IAAI;QACjBC,QAAQ,EAAE;UACRC,QAAQ,EAAE,IAAI,CAACC,WAAW,EAAE;UAC5BX,eAAe,EAAgB,CAAC,GAAGA,eAAe,CAAC;UACnDC,MAAM,EAAgB,CAAC,GAAGA,MAAM,CAAC;UACjCG,mBAAmB;UACnBF;SACD;QACDU,IAAI,EAAE;UACJC,KAAK,EAAE,EAAE;UACTC,OAAO,EAAE;YAAEC,MAAM,EAAE,CAAe,CAAC,GAAGvB,QAAQ,CAAC;UAAC,CAAE;UAClDwB,WAAW,EAAE;;OAEhB;MAED1D,aAAa,CAACgD,UAAU,EAAEf,OAAO,CAAC;MAElC,MAAM0B,mBAAmB,GAAGjD,8BAA8B,CACxDuB,OAAO,EACP,IAAI,CAACoB,WAAW,EAAE,CACnB;MAED,IAAI,CAACO,QAAQ,GAAG;QACdZ,UAAU;QACVa,aAAa,EAAE,IAAI;QACnBF;OACD;MACD,IAAI,CAACG,eAAe,CAAC7B,OAAO,CAAC;MAE7BpB,iBAAiB,CAACoB,OAAO,CAAC;MAE1BJ,GAAG,CAACkC,cAAc,EAAE;MAEpBjD,qCAAqC,CAACwB,eAAe,EAAEqB,mBAAmB,CAAC;MAE3E,OAAOX,UAAU;IACnB,CAAC;IAoED,KAAAgB,YAAY,GAAInC,GAAoC,IAAU;MAC5D,MAAMC,WAAW,GAAGD,GAAG,CAACE,MAAM;MAC9B,MAAM;QAAEE;MAAO,CAAE,GAAGH,WAAW;MAE/B,MAAM;QAAEkB,UAAU;QAAEW,mBAAmB;QAAEE;MAAa,CAAE,GAAG,IAAI,CAACD,QAAQ;MAExE,MAAMxB,cAAc,GAAG3C,iBAAiB,CAACwC,OAAO,CAAC;MACjD,MAAM;QAAEK;MAAe,CAAE,GAAGF,cAAc;MAE1C,MAAM;QAAE6B;MAAU,CAAE,GAAG7B,cAAc;MACrC,IAAI,CAAC8B,mBAAmB,GAAG;QACzBD,UAAU;QACVE,iBAAiB,EAAE7B,eAAe,CAAC8B;OACpC;MAED,IAAI,CAACC,iBAAiB,CAACpC,OAAO,CAAC;MAE/BrB,kBAAkB,CAACqB,OAAO,CAAC;MAE3B,IAAI,CAAC2B,QAAQ,GAAG,IAAI;MACpB,IAAI,CAACrB,SAAS,GAAG,KAAK;MAEtB,IACE,IAAI,CAAC+B,oBAAoB,IACzB,IAAI,CAAC/C,aAAa,CAACE,yBAAyB,EAC5C;QACAvB,gBAAgB,CAAC8C,UAAU,CAACuB,aAAa,CAAC;;MAG5CzD,qCAAqC,CAACwB,eAAe,EAAEqB,mBAAmB,CAAC;MAE3E,IAAIE,aAAa,EAAE;QACjB,MAAMW,SAAS,GAAG/D,MAAM,CAACgE,oBAAoB;QAE7C,MAAM3C,WAAW,GAAmC;UAClDkB;SACD;QAEDrD,YAAY,CAACC,WAAW,EAAE4E,SAAS,EAAE1C,WAAW,CAAC;;IAErD,CAAC;IAED,KAAA4C,aAAa,GAAI7C,GAAG,IAAI;MACtB,IAAI,CAACU,SAAS,GAAG,IAAI;MACrB,MAAMT,WAAW,GAAGD,GAAG,CAACE,MAAM;MAC9B,MAAM;QAAEC,aAAa;QAAEC;MAAO,CAAE,GAAGH,WAAW;MAC9C,MAAMI,QAAQ,GAAGF,aAAa,CAACG,KAAK;MAEpC,MAAM;QAAEa,UAAU;QAAEW;MAAmB,CAAE,GAAG,IAAI,CAACC,QAAQ;MACzD,MAAM;QAAEN;MAAI,CAAE,GAAGN,UAAU;MAE3BM,IAAI,CAACE,OAAO,CAACC,MAAM,CAAC,CAAC,CAAC,GAAG,CAAC,GAAGvB,QAAQ,CAAC;MACtCc,UAAU,CAACC,WAAW,GAAG,IAAI;MAE7B,MAAMb,cAAc,GAAG3C,iBAAiB,CAACwC,OAAO,CAAC;MACjD,MAAM;QAAEK;MAAe,CAAE,GAAGF,cAAc;MAE1CtB,qCAAqC,CAACwB,eAAe,EAAEqB,mBAAmB,CAAC;IAC7E,CAAC;IAED,KAAAgB,MAAM,GAAI1C,OAAuB,IAAI;MAEnC,IAAI,IAAI,CAACM,SAAS,EAAE;QAClB,IAAI,CAACA,SAAS,GAAG,KAAK;QACtB,IAAI,CAAC8B,iBAAiB,CAACpC,OAAO,CAAC;QAC/BrB,kBAAkB,CAACqB,OAAO,CAAC;QAE3B,MAAM;UAAEe,UAAU;UAAEW,mBAAmB;UAAEE;QAAa,CAAE,GAAG,IAAI,CAACD,QAAQ;QACxE,MAAM;UAAEN;QAAI,CAAE,GAAGN,UAAU;QAE3BA,UAAU,CAACE,WAAW,GAAG,KAAK;QAC9BI,IAAI,CAACE,OAAO,CAACoB,iBAAiB,GAAG,IAAI;QAErC,MAAMxC,cAAc,GAAG3C,iBAAiB,CAACwC,OAAO,CAAC;QACjD,MAAM;UAAEK;QAAe,CAAE,GAAGF,cAAc;QAE1CtB,qCAAqC,CACnCwB,eAAe,EACfqB,mBAAmB,CACpB;QAED,IAAIE,aAAa,EAAE;UACjB,MAAMW,SAAS,GAAG/D,MAAM,CAACgE,oBAAoB;UAE7C,MAAM3C,WAAW,GAAmC;YAClDkB;WACD;UAEDrD,YAAY,CAACC,WAAW,EAAE4E,SAAS,EAAE1C,WAAW,CAAC;;QAGnD,IAAI,CAAC8B,QAAQ,GAAG,IAAI;QACpB,OAAOZ,UAAU,CAACuB,aAAa;;IAEnC,CAAC;IAED,KAAAT,eAAe,GAAI7B,OAAO,IAAI;MAC5BzB,KAAK,CAACqE,qBAAqB,GAAG,IAAI;MAElC5C,OAAO,CAAC6C,gBAAgB,CAACrE,MAAM,CAACsE,QAAQ,EAAE,IAAI,CAACf,YAAY,CAAC;MAC5D/B,OAAO,CAAC6C,gBAAgB,CAACrE,MAAM,CAACuE,UAAU,EAAE,IAAI,CAACN,aAAa,CAAC;MAC/DzC,OAAO,CAAC6C,gBAAgB,CAACrE,MAAM,CAACwE,WAAW,EAAE,IAAI,CAACjB,YAAY,CAAC;MAE/D/B,OAAO,CAAC6C,gBAAgB,CAACrE,MAAM,CAACyE,SAAS,EAAE,IAAI,CAAClB,YAAY,CAAC;MAC7D/B,OAAO,CAAC6C,gBAAgB,CAACrE,MAAM,CAAC0E,UAAU,EAAE,IAAI,CAACT,aAAa,CAAC;MAC/DzC,OAAO,CAAC6C,gBAAgB,CAACrE,MAAM,CAAC2E,SAAS,EAAE,IAAI,CAACpB,YAAY,CAAC;IAC/D,CAAC;IAED,KAAAK,iBAAiB,GAAIpC,OAAO,IAAI;MAC9BzB,KAAK,CAACqE,qBAAqB,GAAG,KAAK;MAEnC5C,OAAO,CAACoD,mBAAmB,CAAC5E,MAAM,CAACsE,QAAQ,EAAE,IAAI,CAACf,YAAY,CAAC;MAC/D/B,OAAO,CAACoD,mBAAmB,CAAC5E,MAAM,CAACuE,UAAU,EAAE,IAAI,CAACN,aAAa,CAAC;MAClEzC,OAAO,CAACoD,mBAAmB,CAAC5E,MAAM,CAACwE,WAAW,EAAE,IAAI,CAACjB,YAAY,CAAC;MAElE/B,OAAO,CAACoD,mBAAmB,CAAC5E,MAAM,CAACyE,SAAS,EAAE,IAAI,CAAClB,YAAY,CAAC;MAChE/B,OAAO,CAACoD,mBAAmB,CAAC5E,MAAM,CAAC0E,UAAU,EAAE,IAAI,CAACT,aAAa,CAAC;MAClEzC,OAAO,CAACoD,mBAAmB,CAAC5E,MAAM,CAAC2E,SAAS,EAAE,IAAI,CAACpB,YAAY,CAAC;IAClE,CAAC;IAUD,KAAAsB,gBAAgB,GAAG,CACjBlD,cAAqC,EACrCmD,gBAAkC,KACvB;MACX,IAAIC,YAAY,GAAG,KAAK;MACxB,MAAM;QAAEnD;MAAQ,CAAE,GAAGD,cAAc;MACnC,MAAM;QAAEH;MAAO,CAAE,GAAGI,QAAQ;MAE5B,IAAIoD,WAAW,GAAGxF,cAAc,CAAC,IAAI,CAACoD,WAAW,EAAE,EAAEpB,OAAO,CAAC;MAE7D,IAAI,CAACwD,WAAW,EAAEC,MAAM,EAAE;QACxB,OAAOF,YAAY;;MAGrBC,WAAW,GAAG,IAAI,CAACE,uCAAuC,CACxD1D,OAAO,EACPwD,WAAW,CACZ;MAED,IAAI,CAACA,WAAW,EAAEC,MAAM,EAAE;QACxB,OAAOF,YAAY;;MAGrB,MAAMI,QAAQ,GAAG,IAAI,CAACC,WAAW,CAACxD,QAAQ,CAAC;MAC3C,MAAMC,eAAe,GAAGD,QAAQ,CAACyD,kBAAkB,EAAE;MAErD,MAAMC,cAAc,GAAmB;QACrCC,WAAW,EAAE,IAAI,CAACA,WAAW;QAC7B5C,QAAQ,EAAE,IAAI,CAACC,WAAW,EAAE;QAC5BY,UAAU,EAAE7B,cAAc,CAACC,QAAQ,CAAC+B;OACrC;MAED,KAAK,IAAI6B,CAAC,GAAG,CAAC,EAAEA,CAAC,GAAGR,WAAW,CAACC,MAAM,EAAEO,CAAC,EAAE,EAAE;QAC3C,MAAMjD,UAAU,GAAGyC,WAAW,CAACQ,CAAC,CAAoB;QACpD,MAAM1B,aAAa,GAAGvB,UAAU,CAACuB,aAAa;QAC9C,MAAMjB,IAAI,GAAGN,UAAU,CAACM,IAAI;QAC5B,MAAM4C,KAAK,GAAG5C,IAAI,CAACE,OAAO,CAACC,MAAM,CAAC,CAAC,CAAC;QACpC,MAAM0C,iBAAiB,GAAG9D,QAAQ,CAAC+D,aAAa,CAACF,KAAK,CAAC;QAEvDH,cAAc,CAACxB,aAAa,GAAGA,aAAa;QAE5C,MAAM;UAAE8B;QAAK,CAAE,GAAG,IAAI,CAACC,kBAAkB,CAAC;UAAEtD,UAAU;UAAE+C;QAAc,CAAE,CAAC;QAEzE,IACE,CAACzC,IAAI,CAACI,WAAW,CAACkC,QAAQ,CAAC,IAC3BtC,IAAI,CAACI,WAAW,CAACkC,QAAQ,CAAC,CAACW,KAAK,IAAI,IAAI,EACxC;UACAjD,IAAI,CAACI,WAAW,CAACkC,QAAQ,CAAC,GAAG;YAC3BY,QAAQ,EAAE,IAAI;YACdC,KAAK,EAAE,IAAI;YACXF,KAAK,EAAE;WACR;UAED,IAAI,CAACG,qBAAqB,CAAC1D,UAAU,EAAEV,eAAe,EAAEF,cAAc,CAAC;SACxE,MAAM,IAAIY,UAAU,CAACC,WAAW,EAAE;UACjC,IAAI,CAACyD,qBAAqB,CAAC1D,UAAU,EAAEV,eAAe,EAAEF,cAAc,CAAC;UASvE,IAAIC,QAAQ,YAAY3C,cAAc,EAAE;YACtC,MAAM;cAAEkD;YAAiB,CAAE,GAAGI,UAAU,CAACG,QAAQ;YAIjD,KAAK,MAAMyC,QAAQ,IAAItC,IAAI,CAACI,WAAW,EAAE;cACvC,IAAIkC,QAAQ,CAACe,UAAU,CAAC,SAAS,CAAC,EAAE;gBAClC,MAAMC,SAAS,GAAGtE,eAAe,CAACuE,iBAAiB,EAAE;gBAErD,MAAMC,gBAAgB,GAAGF,SAAS,CAACG,IAAI,CAAEC,EAAE,IAAI;kBAG7C,MAAMC,kBAAkB,GACtBnH,OAAO,CAACoH,YAAY,CAACtE,iBAAiB,CAAC;kBACzC,MAAMuE,WAAW,GAAGH,EAAE,CAACG,WAAW,CAACF,kBAAkB,CAAC;kBACtD,MAAMG,eAAe,GAAGtH,OAAO,CAACoH,YAAY,CAC1CF,EAAE,CAACK,iBAAiB,EAAE,CACvB;kBACD,OAAOF,WAAW,IAAIC,eAAe,KAAKH,kBAAkB;gBAC9D,CAAC,CAAC;gBAEF,IAAIH,gBAAgB,EAAE;kBACpB,OAAOxD,IAAI,CAACI,WAAW,CAACkC,QAAQ,CAAC;;;;;;QAQ3C,IAAI,CAACvD,QAAQ,CAACyD,kBAAkB,EAAE,EAAE;UAClCwB,OAAO,CAACC,IAAI,CAAC,qCAAqC,CAAC;UACnD,OAAO/B,YAAY;;QAGrB,MAAMgC,cAAc,GAAG,GAAG;QAE1BnH,cAAc,CACZkF,gBAAgB,EAChBhB,aAAa,EACbiD,cAAc,EACd,CAACrB,iBAAiB,CAAC,EACnB;UAAEE;QAAK,CAAE,CACV;QAEDb,YAAY,GAAG,IAAI;QAEnB,MAAMiC,OAAO,GAAG,IAAI,CAACC,qBAAqB,CAAC3B,cAAc,EAAE/C,UAAU,CAAC;QACtE,IAAI,CAACyE,OAAO,CAACE,UAAU,EAAE;UACvB;;QAGF,MAAMC,SAAS,GAAG,IAAI,CAACrG,aAAa,CAACG,YAAY,CAAC4B,IAAI,EAAEsC,QAAQ,CAAC;QACjE,IAAIgC,SAAS,EAAE;UACb,MAAMC,qBAAqB,GAAG,CAC5B1B,iBAAiB,CAAC,CAAC,CAAC,GAAG,CAAC,EACxBA,iBAAiB,CAAC,CAAC,CAAC,GAAG,CAAC,CACzB;UAED,MAAM2B,OAAO,GAAG,GAAG;UACnBvH,cAAc,CACZgF,gBAAgB,EAChBhB,aAAa,EACbuD,OAAO,EACPF,SAAS,EACT,CAACC,qBAAqB,CAAC,CAAC,CAAC,EAAEA,qBAAqB,CAAC,CAAC,CAAC,CAAC,EACpDJ,OAAO,CACR;;;MAIL,OAAOjC,YAAY;IACrB,CAAC;EA3ZD;EAIAuC,eAAeA,CAAA;IACb,OAAO,KAAK;EACd;EAEAC,oBAAoBA,CAAA,GAAI;EAqFxBC,uBAAuBA,CACrBhG,OAAuB,EACvBe,UAA2B,EAC3BkF,YAA0B,EAC1BC,SAAiB;IAEjB,MAAM/F,cAAc,GAAG3C,iBAAiB,CAACwC,OAAO,CAAC;IACjD,MAAM;MAAEI;IAAQ,CAAE,GAAGD,cAAc;IAEnC,MAAM;MAAEkB;IAAI,CAAE,GAAGN,UAAU;IAC3B,MAAMkD,KAAK,GAAG5C,IAAI,CAACE,OAAO,CAACC,MAAM,CAAC,CAAC,CAAC;IACpC,MAAM2E,0BAA0B,GAAG/F,QAAQ,CAAC+D,aAAa,CAACF,KAAK,CAAC;IAEhE,MAAMmC,IAAI,GACR7I,IAAI,CAAC8I,QAAQ,CAACJ,YAAY,EAAEE,0BAA0B,CAAC,GAAGD,SAAS;IAErE,IAAIE,IAAI,KAAK,IAAI,EAAE;MACjB,OAAOnC,KAAK;;EAEhB;EAEAqC,sBAAsBA,CACpB1G,GAAoC,EACpCmB,UAA2B;IAE3B,MAAMlB,WAAW,GAAGD,GAAG,CAACE,MAAM;IAC9B,MAAM;MAAEE;IAAO,CAAE,GAAGH,WAAW;IAE/BkB,UAAU,CAACE,WAAW,GAAG,IAAI;IAE7B,MAAMS,mBAAmB,GAAGjD,8BAA8B,CACxDuB,OAAO,EACP,IAAI,CAACoB,WAAW,EAAE,CACnB;IAID,IAAI,CAACO,QAAQ,GAAG;MAEdZ,UAAU;MACVW;KACD;IACD,IAAI,CAACG,eAAe,CAAC7B,OAAO,CAAC;IAE7BpB,iBAAiB,CAACoB,OAAO,CAAC;IAE1B,MAAMG,cAAc,GAAG3C,iBAAiB,CAACwC,OAAO,CAAC;IACjD,MAAM;MAAEK;IAAe,CAAE,GAAGF,cAAc;IAE1CtB,qCAAqC,CAACwB,eAAe,EAAEqB,mBAAmB,CAAC;IAE3E9B,GAAG,CAACkC,cAAc,EAAE;EACtB;EA4QA2C,qBAAqBA,CAAC1D,UAAU,EAAEV,eAAe,EAAEF,cAAc;IAC/D,MAAMkB,IAAI,GAAGN,UAAU,CAACM,IAAI;IAC5B,MAAM;MAAEW,UAAU;MAAEE,iBAAiB;MAAE9B;IAAQ,CAAE,GAAGD,cAAc;IAElE,MAAMF,QAAQ,GAAGoB,IAAI,CAACE,OAAO,CAACC,MAAM,CAAC,CAAC,CAAC;IACvC,MAAM;MAAEC;IAAW,CAAE,GAAGJ,IAAI;IAE5B,MAAMkF,SAAS,GAAGC,MAAM,CAACC,IAAI,CAAChF,WAAW,CAAC;IAE1C,KAAK,IAAIuC,CAAC,GAAG,CAAC,EAAEA,CAAC,GAAGuC,SAAS,CAAC9C,MAAM,EAAEO,CAAC,EAAE,EAAE;MACzC,MAAML,QAAQ,GAAG4C,SAAS,CAACvC,CAAC,CAAC;MAE7B,MAAM0C,mBAAmB,GAAG;QAC1BC,WAAW,EAAE5H,mBAAmB,CAACqB,QAAQ,EAAEuD,QAAQ,CAAC;QACpDiD,WAAW,EAAE,IAAI,CAACA,WAAW,CAC3BxG,QAAQ,EACRuD,QAAQ,EACR5C,UAAU,CAACG,QAAQ,CAACP,iBAAiB;OAExC;MAED,MAAMkG,KAAK,GAAG,IAAI,CAACC,gBAAgB,CAACnD,QAAQ,EAAEtD,eAAe,CAAC;MAK9D,IAAI,CAACwG,KAAK,EAAE;QACV;;MAGF,MAAM;QAAEE,UAAU;QAAEC,SAAS;QAAE9F;MAAQ,CAAE,GAAG2F,KAAK;MACjD,MAAMI,UAAU,GACd,eAAe,IAAIJ,KAAK,GAAGA,KAAK,CAACK,aAAa,EAAE,GAAGL,KAAK,CAACI,UAAU;MAErE,MAAME,QAAQ,GAAGjG,QAAQ,CAACqD,QAAQ;MAClC,MAAMC,KAAK,GAAGxF,qBAAqB,CAACgI,SAAS,EAAE/G,QAAQ,CAAC;MAExDuE,KAAK,CAAC,CAAC,CAAC,GAAG4C,IAAI,CAACC,KAAK,CAAC7C,KAAK,CAAC,CAAC,CAAC,CAAC;MAC/BA,KAAK,CAAC,CAAC,CAAC,GAAG4C,IAAI,CAACC,KAAK,CAAC7C,KAAK,CAAC,CAAC,CAAC,CAAC;MAC/BA,KAAK,CAAC,CAAC,CAAC,GAAG4C,IAAI,CAACC,KAAK,CAAC7C,KAAK,CAAC,CAAC,CAAC,CAAC;MAE/B,MAAM8C,eAAe,GACnBL,UAAU,CAACxD,MAAM,GAAGsD,UAAU,CAAC,CAAC,CAAC,GAAGA,UAAU,CAAC,CAAC,CAAC,GAAGA,UAAU,CAAC,CAAC,CAAC;MAEnE,IAAIlJ,OAAO,CAAC0J,qBAAqB,CAAC/C,KAAK,EAAEuC,UAAU,CAAC,EAAE;QACpD,IAAI,CAAC1E,oBAAoB,GAAG,KAAK;QACjC,MAAMmF,SAAS,GAAGT,UAAU,CAAC,CAAC,CAAC,GAAGO,eAAe;QACjD,MAAMG,SAAS,GAAGV,UAAU,CAAC,CAAC,CAAC,GAAGA,UAAU,CAAC,CAAC,CAAC,GAAGO,eAAe;QAEjE,MAAMI,SAAS,GACblD,KAAK,CAAC,CAAC,CAAC,GAAGiD,SAAS,GACpBjD,KAAK,CAAC,CAAC,CAAC,GAAGgD,SAAS,GACpBhD,KAAK,CAAC,CAAC,CAAC,GAAG8C,eAAe;QAC5B,IAAIhD,KAAK,GACPgD,eAAe,GAAG,CAAC,GACf,CACEL,UAAU,CAACS,SAAS,CAAC,EACrBT,UAAU,CAACS,SAAS,GAAG,CAAC,CAAC,EACzBT,UAAU,CAACS,SAAS,GAAG,CAAC,CAAC,CAC1B,GACDT,UAAU,CAACS,SAAS,CAAC;QAI3B,IAAI/D,QAAQ,CAACe,UAAU,CAAC,UAAU,CAAC,EAAE;UACnC,MAAMiD,OAAO,GAAGhE,QAAQ,CAACiE,KAAK,CAAC,UAAU,CAAC,CAAC,CAAC,CAAC;UAC7C,MAAMC,QAAQ,GAAGhK,OAAO,CAACoH,YAAY,CAAC0C,OAAO,CAAC;UAC9C,MAAMhD,SAAS,GAAG9G,OAAO,CAACiK,wBAAwB,CAChDD,QAAQ,EACR3F,iBAAiB,CAClB;UAED,MAAM9B,QAAQ,GAAGuE,SAAS,CAAC,CAAC,CAAC;UAE7BH,KAAK,CAAC,CAAC,CAAC,GAAGpE,QAAQ,CAAC2H,sBAAsB,EAAE;;QAG9C,IAAIC,YAAY;QAEhB,IAAIb,QAAQ,KAAK,IAAI,EAAE;UACrB,MAAMc,iBAAiB,GAAG/J,+BAA+B,CAAC2I,KAAK,EAAE,CAC/DrC,KAAK,CACN,CAAC;UAEF,MAAM0D,uBAAuB,GAAGD,iBAAiB,CAACE,MAAM,CAACC,KAAK,CAC3D9D,KAAK,IAAKA,KAAK,KAAK,IAAI,CAC1B;UAEDA,KAAK,GAAG4D,uBAAuB,GAAGD,iBAAiB,CAACE,MAAM,GAAG7D,KAAK;UAClE0D,YAAY,GAAGE,uBAAuB,GAClCD,iBAAiB,CAACI,KAAK,GACvB,KAAK;SACV,MAAM;UACLL,YAAY,GAAGlJ,eAAe,CAC5BqI,QAAQ,EACRpG,UAAU,CAACG,QAAQ,CAACP,iBAAiB,EACrC+F,mBAAmB,CACpB;;QAGHjF,WAAW,CAACkC,QAAQ,CAAC,GAAG;UACtBa,KAAK;UACLF,KAAK;UACLC,QAAQ,EAAE4C,QAAQ;UAClBa;SACD;OACF,MAAM;QACL,IAAI,CAAC3F,oBAAoB,GAAG,IAAI;QAChCZ,WAAW,CAACkC,QAAQ,CAAC,GAAG;UACtBa,KAAK;UACLD,QAAQ,EAAE4C;SACX;;MAGHpG,UAAU,CAACC,WAAW,GAAG,KAAK;MAG9B,MAAMuB,SAAS,GAAG/D,MAAM,CAAC8J,mBAAmB;MAE5C,MAAMzI,WAAW,GAAkC;QACjDkB,UAAU;QACViB,UAAU;QACVE;OACD;MAEDxE,YAAY,CAACC,WAAW,EAAE4E,SAAS,EAAE1C,WAAW,CAAC;;IAGnD,OAAO4B,WAAW;EACpB;;AAGF,SAAS/B,mBAAmBA,CAAC2B,IAAI,EAAEsC,QAAQ;EACzC,MAAM4E,iBAAiB,GAAGlH,IAAI,CAACI,WAAW,CAACkC,QAAQ,CAAC;EACpD,MAAM;IAAEa,KAAK;IAAEF,KAAK;IAAE0D;EAAY,CAAE,GAAGO,iBAAiB;EAExD,IAAIjE,KAAK,KAAKkE,SAAS,EAAE;IACvB;;EAGF,MAAM7C,SAAS,GAAG,EAAE;EAEpBA,SAAS,CAAC8C,IAAI,CAAC,IAAIjE,KAAK,CAAC,CAAC,CAAC,KAAKA,KAAK,CAAC,CAAC,CAAC,KAAKA,KAAK,CAAC,CAAC,CAAC,GAAG,CAAC;EAEzD,IAAIF,KAAK,YAAYoE,KAAK,IAAIV,YAAY,YAAYU,KAAK,EAAE;IAC3D,KAAK,IAAI1E,CAAC,GAAG,CAAC,EAAEA,CAAC,GAAGM,KAAK,CAACb,MAAM,EAAEO,CAAC,EAAE,EAAE;MACrC2B,SAAS,CAAC8C,IAAI,CAAC,GAAG/J,WAAW,CAAC4F,KAAK,CAACN,CAAC,CAAC,CAAC,IAAIgE,YAAY,CAAChE,CAAC,CAAC,EAAE,CAAC;;GAEhE,MAAM;IACL2B,SAAS,CAAC8C,IAAI,CAAC,GAAG/J,WAAW,CAAC4F,KAAK,CAAC,IAAI0D,YAAY,EAAE,CAAC;;EAGzD,OAAOrC,SAAS;AAClB;AAEA1G,SAAS,CAACkC,QAAQ,GAAG,OAAO;AAC5B,eAAelC,SAAS"},"metadata":{},"sourceType":"module","externalDependencies":[]}