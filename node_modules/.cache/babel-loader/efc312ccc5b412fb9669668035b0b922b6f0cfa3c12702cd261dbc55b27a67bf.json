{"ast":null,"code":"import \"core-js/modules/es.array.push.js\";\nimport { getRenderingEngine, getEnabledElement, Enums } from '@cornerstonejs/core';\nclass Synchronizer {\n  constructor(synchronizerId, eventName, eventHandler, options) {\n    this._viewportOptions = {};\n    this._onEvent = evt => {\n      if (this._ignoreFiredEvents === true) {\n        return;\n      }\n      if (!this._targetViewports.length) {\n        return;\n      }\n      const enabledElement = getEnabledElement(evt.currentTarget);\n      if (!enabledElement) {\n        return;\n      }\n      const {\n        renderingEngineId,\n        viewportId\n      } = enabledElement;\n      if (!this._sourceViewports.find(s => s.viewportId === viewportId)) {\n        return;\n      }\n      this.fireEvent({\n        renderingEngineId,\n        viewportId\n      }, evt);\n    };\n    this._enabled = true;\n    this._eventName = eventName;\n    this._eventHandler = eventHandler;\n    this._ignoreFiredEvents = false;\n    this._sourceViewports = [];\n    this._targetViewports = [];\n    this._options = options || {};\n    this._auxiliaryEventNames = this._options.auxiliaryEventNames || [];\n    this.id = synchronizerId;\n  }\n  isDisabled() {\n    return !this._enabled || !this._hasSourceElements();\n  }\n  setOptions(viewportId, options = {}) {\n    this._viewportOptions[viewportId] = options;\n  }\n  getOptions(viewportId) {\n    return this._viewportOptions[viewportId];\n  }\n  add(viewportInfo) {\n    this.addTarget(viewportInfo);\n    this.addSource(viewportInfo);\n  }\n  addSource(viewportInfo) {\n    if (_containsViewport(this._sourceViewports, viewportInfo)) {\n      return;\n    }\n    const {\n      renderingEngineId,\n      viewportId\n    } = viewportInfo;\n    const viewport = getRenderingEngine(renderingEngineId).getViewport(viewportId);\n    if (!viewport) {\n      console.warn(`Synchronizer.addSource: No viewport for ${renderingEngineId} ${viewportId}`);\n      return;\n    }\n    const element = viewport.element;\n    element.addEventListener(this._eventName, this._onEvent.bind(this));\n    if (this._auxiliaryEventNames.length) {\n      this._auxiliaryEventNames.forEach(eventName => {\n        element.addEventListener(eventName, this._onEvent.bind(this));\n      });\n    }\n    this._updateDisableHandlers();\n    this._sourceViewports.push(viewportInfo);\n  }\n  addTarget(viewportInfo) {\n    if (_containsViewport(this._targetViewports, viewportInfo)) {\n      return;\n    }\n    this._targetViewports.push(viewportInfo);\n    this._updateDisableHandlers();\n  }\n  getSourceViewports() {\n    return this._sourceViewports;\n  }\n  getTargetViewports() {\n    return this._targetViewports;\n  }\n  destroy() {\n    this._sourceViewports.forEach(s => this.removeSource(s));\n    this._targetViewports.forEach(t => this.removeTarget(t));\n  }\n  remove(viewportInfo) {\n    this.removeTarget(viewportInfo);\n    this.removeSource(viewportInfo);\n  }\n  removeSource(viewportInfo) {\n    const index = _getViewportIndex(this._sourceViewports, viewportInfo);\n    if (index === -1) {\n      return;\n    }\n    const element = _getViewportElement(viewportInfo);\n    this._sourceViewports.splice(index, 1);\n    element.removeEventListener(this._eventName, this._eventHandler);\n    if (this._auxiliaryEventNames) {\n      this._auxiliaryEventNames.forEach(eventName => {\n        element.removeEventListener(eventName, this._eventHandler);\n      });\n    }\n    this._updateDisableHandlers();\n  }\n  removeTarget(viewportInfo) {\n    const index = _getViewportIndex(this._targetViewports, viewportInfo);\n    if (index === -1) {\n      return;\n    }\n    this._targetViewports.splice(index, 1);\n    this._updateDisableHandlers();\n  }\n  hasSourceViewport(renderingEngineId, viewportId) {\n    return _containsViewport(this._sourceViewports, {\n      renderingEngineId,\n      viewportId\n    });\n  }\n  hasTargetViewport(renderingEngineId, viewportId) {\n    return _containsViewport(this._targetViewports, {\n      renderingEngineId,\n      viewportId\n    });\n  }\n  fireEvent(sourceViewport, sourceEvent) {\n    if (this.isDisabled() || this._ignoreFiredEvents) {\n      return;\n    }\n    this._ignoreFiredEvents = true;\n    const promises = [];\n    try {\n      for (let i = 0; i < this._targetViewports.length; i++) {\n        const targetViewport = this._targetViewports[i];\n        const targetIsSource = sourceViewport.viewportId === targetViewport.viewportId;\n        if (targetIsSource) {\n          continue;\n        }\n        const result = this._eventHandler(this, sourceViewport, targetViewport, sourceEvent, this._options);\n        if (result instanceof Promise) {\n          promises.push(result);\n        }\n      }\n    } catch (ex) {\n      console.warn(`Synchronizer, for: ${this._eventName}`, ex);\n    } finally {\n      if (promises.length) {\n        Promise.allSettled(promises).then(() => {\n          this._ignoreFiredEvents = false;\n        });\n      } else {\n        this._ignoreFiredEvents = false;\n      }\n    }\n  }\n  _hasSourceElements() {\n    return this._sourceViewports.length !== 0;\n  }\n  _updateDisableHandlers() {\n    const viewports = _getUniqueViewports(this._sourceViewports, this._targetViewports);\n    const _remove = this.remove;\n    const disableHandler = elementDisabledEvent => {\n      _remove(elementDisabledEvent.detail.element);\n    };\n    viewports.forEach(function (vUid) {\n      const renderingEngine = getRenderingEngine(vUid.renderingEngineId).getViewport(vUid.viewportId);\n      if (!renderingEngine) {\n        return;\n      }\n      const {\n        element\n      } = renderingEngine;\n      element.removeEventListener(Enums.Events.ELEMENT_DISABLED, disableHandler);\n      element.addEventListener(Enums.Events.ELEMENT_DISABLED, disableHandler);\n    });\n  }\n}\nfunction _getUniqueViewports(vp1, vp2) {\n  const unique = [];\n  const vps = vp1.concat(vp2);\n  for (let i = 0; i < vps.length; i++) {\n    const vp = vps[i];\n    if (!unique.some(u => vp.renderingEngineId === u.renderingEngineId && vp.viewportId === u.viewportId)) {\n      unique.push(vp);\n    }\n  }\n  return unique;\n}\nfunction _getViewportIndex(arr, vp) {\n  return arr.findIndex(ar => vp.renderingEngineId === ar.renderingEngineId && vp.viewportId === ar.viewportId);\n}\nfunction _containsViewport(arr, vp) {\n  return arr.some(ar => ar.renderingEngineId === vp.renderingEngineId && ar.viewportId === vp.viewportId);\n}\nfunction _getViewportElement(vp) {\n  const renderingEngine = getRenderingEngine(vp.renderingEngineId);\n  if (!renderingEngine) {\n    throw new Error(`No RenderingEngine for Id: ${vp.renderingEngineId}`);\n  }\n  return renderingEngine.getViewport(vp.viewportId).element;\n}\nexport default Synchronizer;","map":{"version":3,"names":["getRenderingEngine","getEnabledElement","Enums","Synchronizer","constructor","synchronizerId","eventName","eventHandler","options","_viewportOptions","_onEvent","evt","_ignoreFiredEvents","_targetViewports","length","enabledElement","currentTarget","renderingEngineId","viewportId","_sourceViewports","find","s","fireEvent","_enabled","_eventName","_eventHandler","_options","_auxiliaryEventNames","auxiliaryEventNames","id","isDisabled","_hasSourceElements","setOptions","getOptions","add","viewportInfo","addTarget","addSource","_containsViewport","viewport","getViewport","console","warn","element","addEventListener","bind","forEach","_updateDisableHandlers","push","getSourceViewports","getTargetViewports","destroy","removeSource","t","removeTarget","remove","index","_getViewportIndex","_getViewportElement","splice","removeEventListener","hasSourceViewport","hasTargetViewport","sourceViewport","sourceEvent","promises","i","targetViewport","targetIsSource","result","Promise","ex","allSettled","then","viewports","_getUniqueViewports","_remove","disableHandler","elementDisabledEvent","detail","vUid","renderingEngine","Events","ELEMENT_DISABLED","vp1","vp2","unique","vps","concat","vp","some","u","arr","findIndex","ar","Error"],"sources":["../../../../src/store/SynchronizerManager/Synchronizer.ts"],"sourcesContent":[null],"mappings":"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"},"metadata":{},"sourceType":"module","externalDependencies":[]}