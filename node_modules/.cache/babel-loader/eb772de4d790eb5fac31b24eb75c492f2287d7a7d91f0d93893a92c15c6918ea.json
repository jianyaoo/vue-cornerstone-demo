{"ast":null,"code":"import \"core-js/modules/es.array.push.js\";\nimport { eventTarget, triggerEvent } from '@cornerstonejs/core';\nimport BaseStreamingImageVolume from './BaseStreamingImageVolume';\nimport { Events as StreamingEvents } from './enums';\nexport default class StreamingDynamicImageVolume extends BaseStreamingImageVolume {\n  constructor(imageVolumeProperties, streamingProperties) {\n    StreamingDynamicImageVolume._ensureValidData(imageVolumeProperties, streamingProperties);\n    super(imageVolumeProperties, streamingProperties);\n    this._timePointIndex = 0;\n    this._getTimePointRequests = (timePoint, priority) => {\n      const {\n        imageIds\n      } = timePoint;\n      return this.getImageIdsRequests(imageIds, priority);\n    };\n    this._getTimePointsRequests = priority => {\n      const timePoints = this._getTimePointsToLoad();\n      let timePointsRequests = [];\n      timePoints.forEach(timePoint => {\n        const timePointRequests = this._getTimePointRequests(timePoint, priority);\n        timePointsRequests = timePointsRequests.concat(timePointRequests);\n      });\n      return timePointsRequests;\n    };\n    this.getImageLoadRequests = priority => {\n      return this._getTimePointsRequests(priority);\n    };\n    this._numTimePoints = this.scalarData.length;\n    this._timePoints = this._getTimePointsData();\n  }\n  static _ensureValidData(imageVolumeProperties, streamingProperties) {\n    const imageIds = streamingProperties.imageIds;\n    const scalarDataArrays = imageVolumeProperties.scalarData;\n    if (imageIds.length % scalarDataArrays.length !== 0) {\n      throw new Error(`Number of imageIds is not a multiple of ${scalarDataArrays.length}`);\n    }\n  }\n  _getTimePointsData() {\n    const {\n      imageIds\n    } = this;\n    const scalarData = this.scalarData;\n    const {\n      numFrames\n    } = this;\n    const numTimePoints = scalarData.length;\n    const timePoints = [];\n    for (let i = 0; i < numTimePoints; i++) {\n      const start = i * numFrames;\n      const end = start + numFrames;\n      timePoints.push({\n        imageIds: imageIds.slice(start, end),\n        scalarData: scalarData[i]\n      });\n    }\n    return timePoints;\n  }\n  _getTimePointsToLoad() {\n    const timePoints = this._timePoints;\n    const initialTimePointIndex = this._timePointIndex;\n    const timePointsToLoad = [timePoints[initialTimePointIndex]];\n    let leftIndex = initialTimePointIndex - 1;\n    let rightIndex = initialTimePointIndex + 1;\n    while (leftIndex >= 0 || rightIndex < timePoints.length) {\n      if (leftIndex >= 0) {\n        timePointsToLoad.push(timePoints[leftIndex--]);\n      }\n      if (rightIndex < timePoints.length) {\n        timePointsToLoad.push(timePoints[rightIndex++]);\n      }\n    }\n    return timePointsToLoad;\n  }\n  getImageIdsToLoad() {\n    const timePoints = this._getTimePointsToLoad();\n    let imageIds = [];\n    timePoints.forEach(timePoint => {\n      const {\n        imageIds: timePointIds\n      } = timePoint;\n      imageIds = imageIds.concat(timePointIds);\n    });\n    return imageIds;\n  }\n  isDynamicVolume() {\n    return true;\n  }\n  get timePointIndex() {\n    return this._timePointIndex;\n  }\n  set timePointIndex(newTimePointIndex) {\n    if (newTimePointIndex < 0 || newTimePointIndex >= this.numTimePoints) {\n      throw new Error(`Invalid timePointIndex (${newTimePointIndex})`);\n    }\n    if (this._timePointIndex === newTimePointIndex) {\n      return;\n    }\n    const {\n      imageData\n    } = this;\n    this._timePointIndex = newTimePointIndex;\n    imageData.getPointData().setActiveScalars(`timePoint-${newTimePointIndex}`);\n    this.invalidateVolume(true);\n    triggerEvent(eventTarget, StreamingEvents.DYNAMIC_VOLUME_TIME_POINT_INDEX_CHANGED, {\n      volumeId: this.volumeId,\n      timePointIndex: newTimePointIndex\n    });\n  }\n  get numTimePoints() {\n    return this._numTimePoints;\n  }\n  getScalarData() {\n    return this.scalarData[this._timePointIndex];\n  }\n}","map":{"version":3,"names":["eventTarget","triggerEvent","BaseStreamingImageVolume","Events","StreamingEvents","StreamingDynamicImageVolume","constructor","imageVolumeProperties","streamingProperties","_ensureValidData","_timePointIndex","_getTimePointRequests","timePoint","priority","imageIds","getImageIdsRequests","_getTimePointsRequests","timePoints","_getTimePointsToLoad","timePointsRequests","forEach","timePointRequests","concat","getImageLoadRequests","_numTimePoints","scalarData","length","_timePoints","_getTimePointsData","scalarDataArrays","Error","numFrames","numTimePoints","i","start","end","push","slice","initialTimePointIndex","timePointsToLoad","leftIndex","rightIndex","getImageIdsToLoad","timePointIds","isDynamicVolume","timePointIndex","newTimePointIndex","imageData","getPointData","setActiveScalars","invalidateVolume","DYNAMIC_VOLUME_TIME_POINT_INDEX_CHANGED","volumeId","getScalarData"],"sources":["../../src/StreamingDynamicImageVolume.ts"],"sourcesContent":[null],"mappings":"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"},"metadata":{},"sourceType":"module","externalDependencies":[]}