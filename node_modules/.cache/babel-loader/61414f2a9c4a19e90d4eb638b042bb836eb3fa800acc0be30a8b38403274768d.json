{"ast":null,"code":"import getOrCreateCanvas from '../RenderingEngine/helpers/getOrCreateCanvas';\nimport { ViewportType, Events } from '../enums';\nimport { getRenderingEngine } from '../RenderingEngine/getRenderingEngine';\nimport RenderingEngine from '../RenderingEngine';\nimport isPTPrescaledWithSUV from './isPTPrescaledWithSUV';\nexport default function renderToCanvasGPU(canvas, image, modality = undefined, renderingEngineId = '_thumbnails') {\n  if (!canvas || !(canvas instanceof HTMLCanvasElement)) {\n    throw new Error('canvas element is required');\n  }\n  const imageIdToPrint = image.imageId;\n  const viewportId = `renderGPUViewport-${imageIdToPrint}`;\n  const imageId = image.imageId;\n  const element = document.createElement('div');\n  element.style.width = `${canvas.width}px`;\n  element.style.height = `${canvas.height}px`;\n  element.style.visibility = 'hidden';\n  element.style.position = 'absolute';\n  const devicePixelRatio = window.devicePixelRatio || 1;\n  const originalWidth = canvas.width;\n  const originalHeight = canvas.height;\n  canvas.width = originalWidth * devicePixelRatio;\n  canvas.height = originalHeight * devicePixelRatio;\n  canvas.style.width = `${originalWidth}px`;\n  canvas.style.height = `${originalHeight}px`;\n  document.body.appendChild(element);\n  const uniqueId = viewportId.split(':').join('-');\n  element.setAttribute('viewport-id-for-remove', uniqueId);\n  const renderingEngine = getRenderingEngine(renderingEngineId) || new RenderingEngine(renderingEngineId);\n  let viewport = renderingEngine.getViewport(viewportId);\n  if (!viewport) {\n    const stackViewportInput = {\n      viewportId,\n      type: ViewportType.STACK,\n      element,\n      defaultOptions: {\n        suppressEvents: true\n      }\n    };\n    renderingEngine.enableElement(stackViewportInput);\n    viewport = renderingEngine.getViewport(viewportId);\n  }\n  return new Promise(resolve => {\n    let elementRendered = false;\n    const onImageRendered = eventDetail => {\n      if (elementRendered) {\n        return;\n      }\n      const temporaryCanvas = getOrCreateCanvas(element);\n      const context = canvas.getContext('2d');\n      context.drawImage(temporaryCanvas, 0, 0, temporaryCanvas.width, temporaryCanvas.height, 0, 0, canvas.width, canvas.height);\n      elementRendered = true;\n      element.removeEventListener(Events.IMAGE_RENDERED, onImageRendered);\n      setTimeout(() => {\n        renderingEngine.disableElement(viewportId);\n        const elements = document.querySelectorAll(`[viewport-id-for-remove=\"${uniqueId}\"]`);\n        elements.forEach(element => {\n          element.remove();\n        });\n      }, 0);\n      resolve(imageId);\n    };\n    element.addEventListener(Events.IMAGE_RENDERED, onImageRendered);\n    viewport.renderImageObject(image);\n    viewport.resetCamera();\n    if (modality === 'PT' && !isPTPrescaledWithSUV(image)) {\n      viewport.setProperties({\n        voiRange: {\n          lower: image.minPixelValue,\n          upper: image.maxPixelValue\n        }\n      });\n    }\n    viewport.render();\n  });\n}","map":{"version":3,"names":["getOrCreateCanvas","ViewportType","Events","getRenderingEngine","RenderingEngine","isPTPrescaledWithSUV","renderToCanvasGPU","canvas","image","modality","undefined","renderingEngineId","HTMLCanvasElement","Error","imageIdToPrint","imageId","viewportId","element","document","createElement","style","width","height","visibility","position","devicePixelRatio","window","originalWidth","originalHeight","body","appendChild","uniqueId","split","join","setAttribute","renderingEngine","viewport","getViewport","stackViewportInput","type","STACK","defaultOptions","suppressEvents","enableElement","Promise","resolve","elementRendered","onImageRendered","eventDetail","temporaryCanvas","context","getContext","drawImage","removeEventListener","IMAGE_RENDERED","setTimeout","disableElement","elements","querySelectorAll","forEach","remove","addEventListener","renderImageObject","resetCamera","setProperties","voiRange","lower","minPixelValue","upper","maxPixelValue","render"],"sources":["../../../src/utilities/renderToCanvasGPU.ts"],"sourcesContent":[null],"mappings":"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"},"metadata":{},"sourceType":"module","externalDependencies":[]}