{"ast":null,"code":"import { utilities } from '@cornerstonejs/core';\nimport interpolateVec3 from '../../math/vec3/interpolateVec3';\nimport { isRangeValid, areColorbarRangesEqual, isColorbarSizeValid, areColorbarSizesEqual } from './common';\nconst {\n  clamp\n} = utilities;\nclass ColorbarCanvas {\n  constructor(props) {\n    ColorbarCanvas.validateProps(props);\n    const {\n      colormap,\n      size = {\n        width: 20,\n        height: 100\n      },\n      imageRange = {\n        lower: 0,\n        upper: 1\n      },\n      voiRange = {\n        lower: 0,\n        upper: 1\n      },\n      container,\n      showFullPixelValueRange = false\n    } = props;\n    this._colormap = colormap;\n    this._imageRange = imageRange;\n    this._voiRange = voiRange;\n    this._showFullImageRange = showFullPixelValueRange;\n    this._canvas = this._createRootElement(size);\n    if (container) {\n      this.appendTo(container);\n    }\n  }\n  get colormap() {\n    return this._colormap;\n  }\n  set colormap(colormap) {\n    this._colormap = colormap;\n    this.render();\n  }\n  get size() {\n    const {\n      width,\n      height\n    } = this._canvas;\n    return {\n      width,\n      height\n    };\n  }\n  set size(size) {\n    const {\n      _canvas: canvas\n    } = this;\n    if (!isColorbarSizeValid(size) || areColorbarSizesEqual(canvas, size)) {\n      return;\n    }\n    this._setCanvasSize(canvas, size);\n    this.render();\n  }\n  get imageRange() {\n    return {\n      ...this._imageRange\n    };\n  }\n  set imageRange(imageRange) {\n    if (!isRangeValid(imageRange) || areColorbarRangesEqual(imageRange, this._imageRange)) {\n      return;\n    }\n    this._imageRange = imageRange;\n    this.render();\n  }\n  get voiRange() {\n    return {\n      ...this._voiRange\n    };\n  }\n  set voiRange(voiRange) {\n    if (!isRangeValid(voiRange) || areColorbarRangesEqual(voiRange, this._voiRange)) {\n      return;\n    }\n    this._voiRange = voiRange;\n    this.render();\n  }\n  get showFullImageRange() {\n    return this._showFullImageRange;\n  }\n  set showFullImageRange(showFullImageRange) {\n    if (showFullImageRange === this._showFullImageRange) {\n      return;\n    }\n    this._showFullImageRange = showFullImageRange;\n    this.render();\n  }\n  appendTo(container) {\n    container.appendChild(this._canvas);\n    this.render();\n  }\n  dispose() {\n    const {\n      _canvas: canvas\n    } = this;\n    const {\n      parentElement\n    } = canvas;\n    parentElement?.removeChild(canvas);\n  }\n  static validateProps(props) {\n    const {\n      size,\n      imageRange,\n      voiRange\n    } = props;\n    if (size && !isColorbarSizeValid(size)) {\n      throw new Error('Invalid \"size\"');\n    }\n    if (imageRange && !isRangeValid(imageRange)) {\n      throw new Error('Invalid \"imageRange\"');\n    }\n    if (voiRange && !isRangeValid(voiRange)) {\n      throw new Error('Invalid \"voiRange\"');\n    }\n  }\n  _setCanvasSize(canvas, size) {\n    const {\n      width,\n      height\n    } = size;\n    canvas.width = width;\n    canvas.height = height;\n    Object.assign(canvas.style, {\n      width: `${width}px`,\n      height: `${height}px`\n    });\n  }\n  _createRootElement(size) {\n    const canvas = document.createElement('canvas');\n    Object.assign(canvas.style, {\n      position: 'absolute',\n      top: '0',\n      left: '0',\n      pointerEvents: 'none',\n      boxSizing: 'border-box'\n    });\n    this._setCanvasSize(canvas, size);\n    return canvas;\n  }\n  render() {\n    if (!this._canvas.isConnected) {\n      return;\n    }\n    const {\n      _colormap: colormap\n    } = this;\n    const {\n      RGBPoints: rgbPoints\n    } = colormap;\n    const colorsCount = rgbPoints.length / 4;\n    const getColorPoint = index => {\n      const offset = 4 * index;\n      if (index < 0 || index >= colorsCount) {\n        return;\n      }\n      return {\n        index,\n        position: rgbPoints[offset],\n        color: [rgbPoints[offset + 1], rgbPoints[offset + 2], rgbPoints[offset + 3]]\n      };\n    };\n    const {\n      width,\n      height\n    } = this._canvas;\n    const canvasContext = this._canvas.getContext('2d');\n    const isHorizontal = width > height;\n    const maxValue = isHorizontal ? width : height;\n    const {\n      _voiRange: voiRange\n    } = this;\n    const range = this._showFullImageRange ? this._imageRange : {\n      ...voiRange\n    };\n    const {\n      windowWidth\n    } = utilities.windowLevel.toWindowLevel(voiRange.lower, voiRange.upper);\n    let previousColorPoint = undefined;\n    let currentColorPoint = getColorPoint(0);\n    const incRawPixelValue = (range.upper - range.lower) / (maxValue - 1);\n    let rawPixelValue = range.lower;\n    for (let i = 0; i < maxValue; i++) {\n      const tVoiRange = (rawPixelValue - voiRange.lower) / windowWidth;\n      if (currentColorPoint) {\n        for (let i = currentColorPoint.index; i < colorsCount; i++) {\n          if (tVoiRange <= currentColorPoint.position) {\n            break;\n          }\n          previousColorPoint = currentColorPoint;\n          currentColorPoint = getColorPoint(i + 1);\n        }\n      }\n      let normColor;\n      if (!previousColorPoint) {\n        normColor = [...currentColorPoint.color];\n      } else if (!currentColorPoint) {\n        normColor = [...previousColorPoint.color];\n      } else {\n        const tColorRange = (tVoiRange - previousColorPoint.position) / (currentColorPoint.position - previousColorPoint.position);\n        normColor = interpolateVec3(previousColorPoint.color, currentColorPoint.color, tColorRange);\n      }\n      const color = normColor.map(color => clamp(Math.round(color * 255), 0, 255));\n      canvasContext.fillStyle = `rgb(${color[0]}, ${color[1]}, ${color[2]})`;\n      if (isHorizontal) {\n        canvasContext.fillRect(i, 0, 1, height);\n      } else {\n        canvasContext.fillRect(0, height - i - 1, width, 1);\n      }\n      rawPixelValue += incRawPixelValue;\n    }\n  }\n}\nexport { ColorbarCanvas as default, ColorbarCanvas };","map":{"version":3,"names":["utilities","interpolateVec3","isRangeValid","areColorbarRangesEqual","isColorbarSizeValid","areColorbarSizesEqual","clamp","ColorbarCanvas","constructor","props","validateProps","colormap","size","width","height","imageRange","lower","upper","voiRange","container","showFullPixelValueRange","_colormap","_imageRange","_voiRange","_showFullImageRange","_canvas","_createRootElement","appendTo","render","canvas","_setCanvasSize","showFullImageRange","appendChild","dispose","parentElement","removeChild","Error","Object","assign","style","document","createElement","position","top","left","pointerEvents","boxSizing","isConnected","RGBPoints","rgbPoints","colorsCount","length","getColorPoint","index","offset","color","canvasContext","getContext","isHorizontal","maxValue","range","windowWidth","windowLevel","toWindowLevel","previousColorPoint","undefined","currentColorPoint","incRawPixelValue","rawPixelValue","i","tVoiRange","normColor","tColorRange","map","Math","round","fillStyle","fillRect","default"],"sources":["../../../../../src/utilities/voi/colorbar/ColorbarCanvas.ts"],"sourcesContent":[null],"mappings":"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"},"metadata":{},"sourceType":"module","externalDependencies":[]}