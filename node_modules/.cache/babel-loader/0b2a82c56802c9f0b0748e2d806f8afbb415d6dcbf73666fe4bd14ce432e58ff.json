{"ast":null,"code":"import { vec3 } from 'gl-matrix';\nimport { CONSTANTS, metaData } from '@cornerstonejs/core';\nconst {\n  EPSILON\n} = CONSTANTS;\nconst PARALLEL_THRESHOLD = 1 - EPSILON;\nexport default function filterAnnotationsWithinSlice(annotations, camera, spacingInNormalDirection) {\n  const {\n    viewPlaneNormal\n  } = camera;\n  const annotationsWithParallelNormals = annotations.filter(td => {\n    let annotationViewPlaneNormal = td.metadata.viewPlaneNormal;\n    if (!annotationViewPlaneNormal) {\n      const {\n        referencedImageId\n      } = td.metadata;\n      const {\n        imageOrientationPatient\n      } = metaData.get('imagePlaneModule', referencedImageId);\n      const rowCosineVec = vec3.fromValues(imageOrientationPatient[0], imageOrientationPatient[1], imageOrientationPatient[2]);\n      const colCosineVec = vec3.fromValues(imageOrientationPatient[3], imageOrientationPatient[4], imageOrientationPatient[5]);\n      annotationViewPlaneNormal = vec3.create();\n      vec3.cross(annotationViewPlaneNormal, rowCosineVec, colCosineVec);\n      td.metadata.viewPlaneNormal = annotationViewPlaneNormal;\n    }\n    const isParallel = Math.abs(vec3.dot(viewPlaneNormal, annotationViewPlaneNormal)) > PARALLEL_THRESHOLD;\n    return annotationViewPlaneNormal && isParallel;\n  });\n  if (!annotationsWithParallelNormals.length) {\n    return [];\n  }\n  const halfSpacingInNormalDirection = spacingInNormalDirection / 2;\n  const {\n    focalPoint\n  } = camera;\n  const annotationsWithinSlice = [];\n  for (const annotation of annotationsWithParallelNormals) {\n    const data = annotation.data;\n    const point = data.handles.points[0];\n    if (!annotation.isVisible) {\n      continue;\n    }\n    const dir = vec3.create();\n    vec3.sub(dir, focalPoint, point);\n    const dot = vec3.dot(dir, viewPlaneNormal);\n    if (Math.abs(dot) < halfSpacingInNormalDirection) {\n      annotationsWithinSlice.push(annotation);\n    }\n  }\n  return annotationsWithinSlice;\n}","map":{"version":3,"names":["vec3","CONSTANTS","metaData","EPSILON","PARALLEL_THRESHOLD","filterAnnotationsWithinSlice","annotations","camera","spacingInNormalDirection","viewPlaneNormal","annotationsWithParallelNormals","filter","td","annotationViewPlaneNormal","metadata","referencedImageId","imageOrientationPatient","get","rowCosineVec","fromValues","colCosineVec","create","cross","isParallel","Math","abs","dot","length","halfSpacingInNormalDirection","focalPoint","annotationsWithinSlice","annotation","data","point","handles","points","isVisible","dir","sub","push"],"sources":["../../../../src/utilities/planar/filterAnnotationsWithinSlice.ts"],"sourcesContent":[null],"mappings":"AAAA,SAASA,IAAI,QAAQ,WAAW;AAChC,SAASC,SAAS,EAAEC,QAAQ,QAAQ,qBAAqB;AAKzD,MAAM;EAAEC;AAAO,CAAE,GAAGF,SAAS;AAE7B,MAAMG,kBAAkB,GAAG,CAAC,GAAGD,OAAO;AAYtC,eAAc,SAAUE,4BAA4BA,CAClDC,WAAwB,EACxBC,MAAqB,EACrBC,wBAAgC;EAEhC,MAAM;IAAEC;EAAe,CAAE,GAAGF,MAAM;EASlC,MAAMG,8BAA8B,GAAGJ,WAAW,CAACK,MAAM,CACtDC,EAAc,IAAI;IACjB,IAAIC,yBAAyB,GAAGD,EAAE,CAACE,QAAQ,CAACL,eAAe;IAE3D,IAAI,CAACI,yBAAyB,EAAE;MAG9B,MAAM;QAAEE;MAAiB,CAAE,GAAGH,EAAE,CAACE,QAAQ;MACzC,MAAM;QAAEE;MAAuB,CAAE,GAAGd,QAAQ,CAACe,GAAG,CAC9C,kBAAkB,EAClBF,iBAAiB,CAClB;MACD,MAAMG,YAAY,GAAGlB,IAAI,CAACmB,UAAU,CAClCH,uBAAuB,CAAC,CAAC,CAAC,EAC1BA,uBAAuB,CAAC,CAAC,CAAC,EAC1BA,uBAAuB,CAAC,CAAC,CAAC,CAC3B;MAED,MAAMI,YAAY,GAAGpB,IAAI,CAACmB,UAAU,CAClCH,uBAAuB,CAAC,CAAC,CAAC,EAC1BA,uBAAuB,CAAC,CAAC,CAAC,EAC1BA,uBAAuB,CAAC,CAAC,CAAC,CAC3B;MAEDH,yBAAyB,GAAGb,IAAI,CAACqB,MAAM,EAAkB;MAEzDrB,IAAI,CAACsB,KAAK,CAACT,yBAAyB,EAAEK,YAAY,EAAEE,YAAY,CAAC;MACjER,EAAE,CAACE,QAAQ,CAACL,eAAe,GAAGI,yBAAyB;;IAEzD,MAAMU,UAAU,GACdC,IAAI,CAACC,GAAG,CAACzB,IAAI,CAAC0B,GAAG,CAACjB,eAAe,EAAEI,yBAAyB,CAAC,CAAC,GAC9DT,kBAAkB;IAEpB,OAAOS,yBAAyB,IAAIU,UAAU;EAChD,CAAC,CACF;EAGD,IAAI,CAACb,8BAA8B,CAACiB,MAAM,EAAE;IAC1C,OAAO,EAAE;;EAMX,MAAMC,4BAA4B,GAAGpB,wBAAwB,GAAG,CAAC;EACjE,MAAM;IAAEqB;EAAU,CAAE,GAAGtB,MAAM;EAE7B,MAAMuB,sBAAsB,GAAG,EAAE;EAEjC,KAAK,MAAMC,UAAU,IAAIrB,8BAA8B,EAAE;IACvD,MAAMsB,IAAI,GAAGD,UAAU,CAACC,IAAI;IAC5B,MAAMC,KAAK,GAAGD,IAAI,CAACE,OAAO,CAACC,MAAM,CAAC,CAAC,CAAC;IAEpC,IAAI,CAACJ,UAAU,CAACK,SAAS,EAAE;MACzB;;IASF,MAAMC,GAAG,GAAGrC,IAAI,CAACqB,MAAM,EAAE;IAEzBrB,IAAI,CAACsC,GAAG,CAACD,GAAG,EAAER,UAAU,EAAEI,KAAK,CAAC;IAEhC,MAAMP,GAAG,GAAG1B,IAAI,CAAC0B,GAAG,CAACW,GAAG,EAAE5B,eAAe,CAAC;IAE1C,IAAIe,IAAI,CAACC,GAAG,CAACC,GAAG,CAAC,GAAGE,4BAA4B,EAAE;MAChDE,sBAAsB,CAACS,IAAI,CAACR,UAAU,CAAC;;;EAI3C,OAAOD,sBAAsB;AAC/B"},"metadata":{},"sourceType":"module","externalDependencies":[]}