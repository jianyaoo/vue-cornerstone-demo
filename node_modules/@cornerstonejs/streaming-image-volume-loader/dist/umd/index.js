!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t(require("@cornerstonejs/core"),require("gl-matrix")):"function"==typeof define&&define.amd?define(["@cornerstonejs/core","gl-matrix"],t):"object"==typeof exports?exports.cornerstoneStreamingImageVolumeLoader=t(require("@cornerstonejs/core"),require("gl-matrix")):e.cornerstoneStreamingImageVolumeLoader=t(e.cornerstone3D,e.window)}(self,((e,t)=>(()=>{"use strict";var a={953:t=>{t.exports=e},976:e=>{e.exports=t}},s={};function r(e){var t=s[e];if(void 0!==t)return t.exports;var n=s[e]={exports:{}};return a[e](n,n.exports,r),n.exports}r.d=(e,t)=>{for(var a in t)r.o(t,a)&&!r.o(e,a)&&Object.defineProperty(e,a,{enumerable:!0,get:t[a]})},r.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),r.r=e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})};var n={};return(()=>{r.r(n),r.d(n,{Enums:()=>e,StreamingDynamicImageVolume:()=>P,StreamingImageVolume:()=>u,cornerstoneStreamingDynamicImageVolumeLoader:()=>b,cornerstoneStreamingImageVolumeLoader:()=>h,helpers:()=>D});var e={};r.r(e),r.d(e,{Events:()=>E});var t=r(953);function a(e){return a="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},a(e)}function s(e,t,s){return(t=function(e){var t=function(e,t){if("object"!==a(e)||null===e)return e;var s=e[Symbol.toPrimitive];if(void 0!==s){var r=s.call(e,"string");if("object"!==a(r))return r;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(e)}(e);return"symbol"===a(t)?t:String(t)}(t))in e?Object.defineProperty(e,t,{value:s,enumerable:!0,configurable:!0,writable:!0}):e[t]=s,e}const i=e=>{const a=function(e){const a=(0,t.getRenderingEngines)(),s=[];for(let r=0;r<a.length;r++){const n=a[r],i=t.utilities.getViewportsWithVolumeId(e,n.id);i.length&&s.push({renderingEngine:n,viewportIds:i.map((e=>e.id))})}return s}(e);a&&a.length&&a.forEach((e=>{let{renderingEngine:t,viewportIds:a}=e;t.hasBeenDestroyed||t.renderViewports(a)}))};function o(e,t){const a=e.length,{rescaleSlope:s,rescaleIntercept:r,suvbw:n}=t;if("PT"===t.modality&&"number"==typeof n)for(let t=0;t<a;t++)e[t]=n*(e[t]*s+r);else for(let t=0;t<a;t++)e[t]=e[t]*s+r;return e}const l=t.Enums.RequestType.Prefetch,{ProgressiveIterator:d}=t.utilities,{ImageQualityStatus:c}=t.Enums,{imageRetrieveMetadataProvider:m}=t.utilities;class g extends t.ImageVolume{constructor(e,a){super(e),s(this,"framesLoaded",0),s(this,"framesProcessed",0),s(this,"framesUpdated",0),s(this,"autoRenderOnLoad",!0),s(this,"cachedFrames",[]),s(this,"reRenderTarget",0),s(this,"reRenderFraction",2),s(this,"loadStatus",void 0),s(this,"imagesLoader",this),s(this,"cancelLoading",(()=>{const{loadStatus:e}=this;e&&e.loading&&(e.loading=!1,e.cancelled=!0,this.clearLoadCallbacks(),t.imageLoadPoolManager.filterRequests((e=>{let{additionalDetails:t}=e;return t.volumeId!==this.volumeId})))})),s(this,"load",(e=>{const{imageIds:a,loadStatus:s,numFrames:r}=this,{transferSyntaxUID:n}=t.metaData.get("transferSyntax",a[0])||{},i=t.metaData.get(m.IMAGE_RETRIEVE_CONFIGURATION,this.volumeId,n,"volume");if(this.imagesLoader=i?(i.create||t.ProgressiveRetrieveImages.createProgressive)(i):this,!0===s.loading)return;const{loaded:o}=this.loadStatus,l=a.length;o?e&&e({success:!0,framesLoaded:l,framesProcessed:l,numFrames:r,totalNumFrames:l}):(e&&this.loadStatus.callbacks.push(e),this._prefetchImageIds())})),this.loadStatus=a.loadStatus}invalidateVolume(e){const{imageData:t,vtkOpenGLTexture:a}=this,{numFrames:s}=this;for(let e=0;e<s;e++)a.setUpdatedFrame(e);t.modified(),e&&i(this.volumeId)}clearLoadCallbacks(){this.loadStatus.callbacks=[]}callLoadStatusCallback(e){const{framesUpdated:a,framesProcessed:s,totalNumFrames:r}=e,{volumeId:n,reRenderFraction:o,loadStatus:l,metadata:d}=this,{FrameOfReferenceUID:c}=d;if(this.autoRenderOnLoad&&(a>this.reRenderTarget||s===r)&&(this.reRenderTarget+=o,i(n)),s===r){l.callbacks.forEach((t=>t(e)));const a={FrameOfReferenceUID:c,volumeId:n};(0,t.triggerEvent)(t.eventTarget,t.Enums.Events.IMAGE_VOLUME_LOADING_COMPLETED,a)}}updateTextureAndTriggerEvents(e,a){let s=arguments.length>2&&void 0!==arguments[2]?arguments[2]:c.FULL_RESOLUTION;const r=this.imageIdIndexToFrameIndex(e),{cachedFrames:n,numFrames:i,totalNumFrames:o}=this,{FrameOfReferenceUID:l}=this.metadata;if(n[r]>s)return;if(n[r]===c.FULL_RESOLUTION)return;const d=s===c.FULL_RESOLUTION;n[e]=s,this.framesUpdated++,d&&(this.framesLoaded++,this.framesProcessed++),this.vtkOpenGLTexture.setUpdatedFrame(r),this.imageData.modified();const m={FrameOfReferenceUID:l,imageVolume:this};(0,t.triggerEvent)(t.eventTarget,t.Enums.Events.IMAGE_VOLUME_MODIFIED,m),d&&this.framesProcessed===this.totalNumFrames&&(this.loadStatus.loaded=!0,this.loadStatus.loading=!1),this.callLoadStatusCallback({success:!0,imageIdIndex:e,imageId:a,framesLoaded:this.framesLoaded,framesProcessed:this.framesProcessed,framesUpdated:this.framesUpdated,numFrames:i,totalNumFrames:o,complete:d,imageQualityStatus:s}),this.loadStatus.loaded&&(this.loadStatus.callbacks=[])}successCallback(e,a){const s=this.getImageIdIndex(e),r=this.getLoaderImageOptions(e),n=this.getScalarDataByImageIdIndex(s);!function(e,t,a){if(!(e.buffer instanceof ArrayBuffer))return;const s=a.targetBuffer.offset,r=a.targetBuffer.length,n=t.pixelData?t.pixelData:t.getPixelData();try{if(e instanceof Float32Array){const t=4,a=new Float32Array(n);if(a.length!==r)throw"Error pixelData length does not match frame length";e.set(a,s/t)}if(e instanceof Int16Array){const t=2,a=new Int16Array(n);if(a.length!==r)throw"Error pixelData length does not match frame length";e.set(a,s/t)}if(e instanceof Uint16Array){const t=2,a=new Uint16Array(n);if(a.length!==r)throw"Error pixelData length does not match frame length";e.set(a,s/t)}if(e instanceof Uint8Array){const t=1,a=new Uint8Array(n);if(a.length!==r)throw"Error pixelData length does not match frame length";e.set(a,s/t)}}catch(e){console.error(e)}}(n,a,r);const{scalingParameters:i}=a.preScale||{},{imageQualityStatus:o}=a,l=this.imageIdIndexToFrameIndex(s),d=t.cache.getCachedImageBasedOnImageURI(e),c=t.cache.getVolumeContainingImageId(e);if(this.loadStatus.cancelled)return void console.warn("volume load cancelled, returning for imageIdIndex: ",s);if(!(d||c&&c.volume!==this))return this.updateTextureAndTriggerEvents(s,e,o);const m=!!d;var g,u;m&&r.targetBuffer&&this.imageCacheOffsetMap.set(e,{imageIdIndex:s,frameIndex:l,offset:(null===(g=r.targetBuffer)||void 0===g?void 0:g.offset)||0,length:null===(u=r.targetBuffer)||void 0===u?void 0:u.length});const h=d||c.volume;this.handleImageComingFromCache(h,m,i,n,l,n.buffer,s,e)}errorCallback(e,a,s){if(!a)return;const{totalNumFrames:r,numFrames:n}=this,i=this.getImageIdIndex(e);this.framesProcessed++,this.framesProcessed===r&&(this.loadStatus.loaded=!0,this.loadStatus.loading=!1),this.callLoadStatusCallback({success:!1,imageId:e,imageIdIndex:i,error:s,framesLoaded:this.framesLoaded,framesProcessed:this.framesProcessed,framesUpdated:this.framesUpdated,numFrames:n,totalNumFrames:r}),this.loadStatus.loaded&&(this.loadStatus.callbacks=[]);const o={error:s,imageIdIndex:i,imageId:e};(0,t.triggerEvent)(t.eventTarget,t.Enums.Events.IMAGE_LOAD_ERROR,o)}getLoaderImageOptions(e){const{transferSyntaxUID:a}=t.metaData.get("transferSyntax",e)||{},s=t.metaData.get("imagePlaneModule",e)||{},{rows:r,columns:n}=s,i=this.getImageIdIndex(e),o=this.getScalarDataByImageIdIndex(i);if(!o)return null;const l=o.buffer,{type:d,length:c,lengthInBytes:m}=function(e,t){let a,s;if(e instanceof Uint8Array)a="Uint8Array",s=1;else if(e instanceof Float32Array)a="Float32Array",s=4;else if(e instanceof Uint16Array)a="Uint16Array",s=2;else{if(!(e instanceof Int16Array))throw new Error("Unsupported array type");a="Int16Array",s=2}const r=e.length/t;return{type:a,byteSize:s,length:r,lengthInBytes:r*s}}(o,this.numFrames),g=t.metaData.get("modalityLutModule",e)||{},u=t.metaData.get("generalSeriesModule",e)||{},h={rescaleSlope:g.rescaleSlope,rescaleIntercept:g.rescaleIntercept,modality:u.modality};if("PT"===h.modality){const a=t.metaData.get("scalingModule",e);a&&(this._addScalingToVolume(a),h.suvbw=a.suvbw)}const I="number"==typeof h.rescaleSlope&&"number"==typeof h.rescaleIntercept;this.isPreScaled=I;const f=this.imageIdIndexToFrameIndex(i);return{targetBuffer:{arrayBuffer:l instanceof ArrayBuffer?void 0:l,offset:f*m,length:c,type:d,rows:r,columns:n},skipCreateImage:!0,preScale:{enabled:!0,scalingParameters:h},transferPixelData:!0,transferSyntaxUID:a,loader:t.imageLoader.loadImage,additionalDetails:{imageId:e,imageIdIndex:i,volumeId:this.volumeId}}}callLoadImage(e,a,s){const{cachedFrames:r}=this;if(r[a]!==c.FULL_RESOLUTION)return d.as(t.imageLoader.loadImage(e,s)).forEach((t=>{this.successCallback(e,t)}),this.errorCallback.bind(this,a,e))}getImageIdsRequests(e,t){return this.totalNumFrames=this.imageIds.length,this.autoRenderOnLoad&&(this.reRenderFraction=.02*this.totalNumFrames,this.reRenderTarget=this.reRenderFraction),e.map((e=>{const a=this.getImageIdIndex(e),s=l,r=t,n=this.getLoaderImageOptions(e);return{callLoadImage:this.callLoadImage.bind(this),imageId:e,imageIdIndex:a,options:n,priority:r,requestType:s,additionalDetails:{volumeId:this.volumeId}}}))}handleImageComingFromCache(e,t,a,s,r,n,i,o){(t?e.imageLoadObject:e.convertToCornerstoneImage(o,i)).promise.then((e=>{const t=this._scaleIfNecessary(e,a),{pixelsPerImage:l,bytesPerImage:d}=this.cornerstoneImageMetaData,c=s.constructor;let m=d*r;const g=d/l;s.BYTES_PER_ELEMENT!==g&&(m*=s.BYTES_PER_ELEMENT/g),new c(n,m,l).set(t),this.updateTextureAndTriggerEvents(i,o,e.imageQualityStatus)})).catch((e=>{this.errorCallback(o,!0,e)}))}getImageLoadRequests(e){throw new Error("Abstract method")}getImageIdsToLoad(){throw new Error("Abstract method")}loadImages(e,a){return this.loadStatus.loading=!0,this.getImageLoadRequests(5).reverse().forEach((e=>{if(!e)return;const{callLoadImage:a,imageId:s,imageIdIndex:r,options:n,priority:i,requestType:o,additionalDetails:l}=e;t.imageLoadPoolManager.addRequest(a.bind(this,s,r,n),o,l,i)})),Promise.resolve(!0)}_prefetchImageIds(){this.loadStatus.loading=!0;const e=[...this.getImageIdsToLoad()];return e.reverse(),this.totalNumFrames=this.imageIds.length,this.autoRenderOnLoad&&(this.reRenderFraction=.02*this.totalNumFrames,this.reRenderTarget=this.reRenderFraction),this.imagesLoader.loadImages(e,this).catch((e=>{console.debug("progressive loading failed to complete",e)}))}_scaleIfNecessary(e,t){var a;const s=null===(a=e.preScale)||void 0===a?void 0:a.scaled,r=!t||!t.rescaleIntercept||!t.rescaleSlope;if(!s&&r)return e.getPixelData().slice(0);if(!s&&t&&void 0!==t.rescaleIntercept&&void 0!==t.rescaleSlope)return o(e.getPixelData().slice(0),t);const{rescaleSlope:n,rescaleIntercept:i,suvbw:l}=t,{rescaleSlope:d,rescaleIntercept:c,suvbw:m}=e.preScale.scalingParameters;if(n===d&&i===c&&l===m)return e.getPixelData();const g=l/m,u=n/d,h=i-c*u;return o(e.getPixelData().slice(0),{...t,rescaleSlope:u,rescaleIntercept:h,suvbw:g})}_addScalingToVolume(e){if(this.scaling)return;const{suvbw:t,suvlbm:a,suvbsa:s}=e,r={};a&&(r.suvbwToSuvlbm=a/t),s&&(r.suvbwToSuvbsa=s/t),t&&(r.suvbw=t),this.scaling={PT:r}}}class u extends g{constructor(e,t){e.imageIds||(e.imageIds=t.imageIds),super(e,t),s(this,"getImageIdsToLoad",(()=>{const{imageIds:e}=this;return this.numFrames=e.length,e}))}getScalarData(){return this.scalarData}getImageLoadRequests(e){const{imageIds:t}=this;return this.getImageIdsRequests(t,e)}}const h=function(e,a){if(!a||!a.imageIds||!a.imageIds.length)throw new Error("ImageIds must be provided to create a streaming image volume");const s=async function(){if("wadouri"===a.imageIds[0].split(":")[0]){const[s,r]=[Math.floor(a.imageIds.length/2),a.imageIds.length-1],n=[0,s,r];await Promise.all(n.map((s=>new Promise(((r,n)=>{const i=a.imageIds[s];t.imageLoadPoolManager.addRequest((async()=>{t.imageLoader.loadImage(i).then((()=>{console.log("Prefetched imageId: ".concat(i)),r(!0)})).catch((e=>{n(e)}))}),t.Enums.RequestType.Prefetch,{volumeId:e},1)}))))).catch(console.error)}const{dimensions:s,spacing:r,origin:n,scalarData:i,direction:o,sizeInBytes:l,metadata:d,imageIds:c}=t.utilities.generateVolumePropsFromImageIds(a.imageIds,e);return new u({volumeId:e,metadata:d,dimensions:s,spacing:r,origin:n,direction:o,scalarData:i,sizeInBytes:l,imageIds:c},{imageIds:c,loadStatus:{loaded:!1,loading:!1,cancelled:!1,cachedFrames:[],callbacks:[]}})}();return{promise:s,decache:()=>{s.then((e=>{e.destroy(),e=null}))},cancel:()=>{s.then((e=>{e.cancelLoading()}))}}};function I(e){const a=e.map((e=>{const a=t.metaData.get("petImageModule",e),{frameReferenceTime:s=0}=null!=a?a:{};return{imageId:e,frameReferenceTime:s}})),s=(r="frameReferenceTime",a.reduce(((e,t)=>((e[t[r]]=e[t[r]]||[]).push(t),e)),{}));var r;return Object.keys(s).map(Number.parseFloat).sort(((e,t)=>e-t)).map((e=>s[e].map((e=>e.imageId))))}const f=function(e){const t=[I];for(let a=0;a<t.length;a++){const s=t[a](e);if(!s||s.length<=1)continue;const r=s[0].length;if(s.every((e=>e.length===r)))return s}return[e]};var p=r(976);const{createUint8SharedArray:v,createFloat32SharedArray:y}=t.utilities;var S=function(e){return e.DYNAMIC_VOLUME_TIME_POINT_INDEX_CHANGED="DYNAMIC_VOLUME_TIME_POINT_INDEX_CHANGED",e}(S||{});const E=S;class P extends g{constructor(e,t){P._ensureValidData(e,t),super(e,t),s(this,"_numTimePoints",void 0),s(this,"_timePoints",void 0),s(this,"_timePointIndex",0),s(this,"_getTimePointRequests",((e,t)=>{const{imageIds:a}=e;return this.getImageIdsRequests(a,t)})),s(this,"_getTimePointsRequests",(e=>{const t=this._getTimePointsToLoad();let a=[];return t.forEach((t=>{const s=this._getTimePointRequests(t,e);a=a.concat(s)})),a})),s(this,"getImageLoadRequests",(e=>this._getTimePointsRequests(e))),this._numTimePoints=this.scalarData.length,this._timePoints=this._getTimePointsData()}static _ensureValidData(e,t){const a=t.imageIds,s=e.scalarData;if(a.length%s.length!=0)throw new Error("Number of imageIds is not a multiple of ".concat(s.length))}_getTimePointsData(){const{imageIds:e}=this,t=this.scalarData,{numFrames:a}=this,s=t.length,r=[];for(let n=0;n<s;n++){const s=n*a,i=s+a;r.push({imageIds:e.slice(s,i),scalarData:t[n]})}return r}_getTimePointsToLoad(){const e=this._timePoints,t=this._timePointIndex,a=[e[t]];let s=t-1,r=t+1;for(;s>=0||r<e.length;)s>=0&&a.push(e[s--]),r<e.length&&a.push(e[r++]);return a}getImageIdsToLoad(){const e=this._getTimePointsToLoad();let t=[];return e.forEach((e=>{const{imageIds:a}=e;t=t.concat(a)})),t}isDynamicVolume(){return!0}get timePointIndex(){return this._timePointIndex}set timePointIndex(e){if(e<0||e>=this.numTimePoints)throw new Error("Invalid timePointIndex (".concat(e,")"));if(this._timePointIndex===e)return;const{imageData:a}=this;this._timePointIndex=e,a.getPointData().setActiveScalars("timePoint-".concat(e)),this.invalidateVolume(!0),(0,t.triggerEvent)(t.eventTarget,E.DYNAMIC_VOLUME_TIME_POINT_INDEX_CHANGED,{volumeId:this.volumeId,timePointIndex:e})}get numTimePoints(){return this._numTimePoints}getScalarData(){return this.scalarData[this._timePointIndex]}}const b=function(e,a){if(!a||!a.imageIds||!a.imageIds.length)throw new Error("ImageIds must be provided to create a 4D streaming image volume");const{imageIds:s}=a,r=function(e){return f(e).map((e=>function(e){const a=t.utilities.makeVolumeMetadata(e),{BitsAllocated:s,PixelRepresentation:r,PhotometricInterpretation:n,ImageOrientationPatient:i,PixelSpacing:o,Columns:l,Rows:d}=a,c=p.vec3.fromValues(i[0],i[1],i[2]),m=p.vec3.fromValues(i[3],i[4],i[5]),g=p.vec3.create();p.vec3.cross(g,c,m);const{zSpacing:u,origin:h,sortedImageIds:I}=t.utilities.sortImageIdsAndGetSpacing(e,g),f=e.length,S=[o[1],o[0],u],E=[l,d,f],P=[...c,...m,...g],b=1===r;let D=1;"RGB"===n&&(D=3);const L=(16===s?4:1)*E[0]*E[1]*E[2]*D;if(!t.cache.isCacheable(L))throw new Error(t.Enums.Events.CACHE_SIZE_EXCEEDED);let T;switch(t.cache.decacheIfNecessaryUntilBytesAvailable(L),s){case 8:if(b)throw new Error("8 Bit signed images are not yet supported by this plugin.");T=v(E[0]*E[1]*E[2]);break;case 16:T=y(E[0]*E[1]*E[2]);break;case 24:T=v(E[0]*E[1]*E[2]*D)}return{metadata:a,sortedImageIds:I,dimensions:E,spacing:S,origin:h,direction:P,scalarData:T,sizeInBytes:L}}(e)))}(s),{metadata:n,dimensions:i,spacing:o,origin:l,direction:d,sizeInBytes:c}=r[0],m=[],g=[];r.forEach((e=>{m.push(e.sortedImageIds),g.push(e.scalarData)}));const u=m.flat();let h=new P({volumeId:e,metadata:n,dimensions:i,spacing:o,origin:l,direction:d,scalarData:g,sizeInBytes:c,imageIds:u},{imageIds:u,loadStatus:{loaded:!1,loading:!1,cancelled:!1,cachedFrames:[],callbacks:[]}});return{promise:Promise.resolve(h),decache:()=>{h.destroy(),h=null},cancel:()=>{h.cancelLoading()}}},D={getDynamicVolumeInfo:function(e){const t=f(e);return{isDynamicVolume:t.length>1,timePoints:t}}}})(),n})()));
//# sourceMappingURL=index.js.map