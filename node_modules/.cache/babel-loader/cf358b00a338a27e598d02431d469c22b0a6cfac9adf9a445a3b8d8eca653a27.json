{"ast":null,"code":"import storedPixelDataToCanvasImageData from './storedPixelDataToCanvasImageData';\nimport storedPixelDataToCanvasImageDataPET from './storedPixelDataToCanvasImageDataPET';\nimport storedPixelDataToCanvasImageDataRGBA from './storedPixelDataToCanvasImageDataRGBA';\nimport setToPixelCoordinateSystem from './setToPixelCoordinateSystem';\nimport now from './now';\nimport getLut from './getLut';\nimport doesImageNeedToBeRendered from './doesImageNeedToBeRendered';\nimport initializeRenderCanvas from './initializeRenderCanvas';\nimport saveLastRendered from './saveLastRendered';\nfunction getRenderCanvas(enabledElement, image, invalidated, useAlphaChannel = true) {\n  const canvasWasColor = enabledElement.renderingTools.lastRenderedIsColor === true;\n  if (!enabledElement.renderingTools.renderCanvas || canvasWasColor) {\n    enabledElement.renderingTools.renderCanvas = document.createElement('canvas');\n    initializeRenderCanvas(enabledElement, image);\n  }\n  const renderCanvas = enabledElement.renderingTools.renderCanvas;\n  if (doesImageNeedToBeRendered(enabledElement, image) === false && invalidated !== true) {\n    return renderCanvas;\n  }\n  if (renderCanvas.width !== image.width || renderCanvas.height !== image.height) {\n    initializeRenderCanvas(enabledElement, image);\n  }\n  image.stats = image.stats || {};\n  const renderCanvasData = enabledElement.renderingTools.renderCanvasData;\n  const renderCanvasContext = enabledElement.renderingTools.renderCanvasContext;\n  let start = now();\n  image.stats.lastLutGenerateTime = now() - start;\n  const {\n    viewport\n  } = enabledElement;\n  if (viewport.modality === 'PT' && image.isPreScaled) {\n    const {\n      windowWidth,\n      windowCenter\n    } = viewport.voi;\n    const minimum = windowCenter - windowWidth / 2;\n    const maximum = windowCenter + windowWidth / 2;\n    const range = maximum - minimum;\n    const collectedMultiplierTerms = 255.0 / range;\n    let petVOILutFunction;\n    if (viewport.invert) {\n      petVOILutFunction = value => 255 - (value - minimum) * collectedMultiplierTerms;\n    } else {\n      petVOILutFunction = value => (value - minimum) * collectedMultiplierTerms;\n    }\n    storedPixelDataToCanvasImageDataPET(image, petVOILutFunction, renderCanvasData.data);\n  } else {\n    const lut = getLut(image, viewport, invalidated);\n    if (useAlphaChannel) {\n      storedPixelDataToCanvasImageData(image, lut, renderCanvasData.data);\n    } else {\n      storedPixelDataToCanvasImageDataRGBA(image, lut, renderCanvasData.data);\n    }\n  }\n  start = now();\n  renderCanvasContext.putImageData(renderCanvasData, 0, 0);\n  image.stats.lastPutImageDataTime = now() - start;\n  return renderCanvas;\n}\nexport function renderGrayscaleImage(enabledElement, invalidated) {\n  if (enabledElement === undefined) {\n    throw new Error('drawImage: enabledElement parameter must not be undefined');\n  }\n  const image = enabledElement.image;\n  if (image === undefined) {\n    throw new Error('drawImage: image must be loaded before it can be drawn');\n  }\n  const context = enabledElement.canvas.getContext('2d');\n  context.setTransform(1, 0, 0, 1, 0, 0);\n  context.fillStyle = 'black';\n  context.fillRect(0, 0, enabledElement.canvas.width, enabledElement.canvas.height);\n  context.imageSmoothingEnabled = !enabledElement.viewport.pixelReplication;\n  setToPixelCoordinateSystem(enabledElement, context);\n  const renderCanvas = getRenderCanvas(enabledElement, image, invalidated);\n  const sx = enabledElement.viewport.displayedArea.tlhc.x - 1;\n  const sy = enabledElement.viewport.displayedArea.tlhc.y - 1;\n  const width = enabledElement.viewport.displayedArea.brhc.x - sx;\n  const height = enabledElement.viewport.displayedArea.brhc.y - sy;\n  context.drawImage(renderCanvas, sx, sy, width, height, 0, 0, width, height);\n  enabledElement.renderingTools = saveLastRendered(enabledElement);\n}","map":{"version":3,"names":["storedPixelDataToCanvasImageData","storedPixelDataToCanvasImageDataPET","storedPixelDataToCanvasImageDataRGBA","setToPixelCoordinateSystem","now","getLut","doesImageNeedToBeRendered","initializeRenderCanvas","saveLastRendered","getRenderCanvas","enabledElement","image","invalidated","useAlphaChannel","canvasWasColor","renderingTools","lastRenderedIsColor","renderCanvas","document","createElement","width","height","stats","renderCanvasData","renderCanvasContext","start","lastLutGenerateTime","viewport","modality","isPreScaled","windowWidth","windowCenter","voi","minimum","maximum","range","collectedMultiplierTerms","petVOILutFunction","invert","value","data","lut","putImageData","lastPutImageDataTime","renderGrayscaleImage","undefined","Error","context","canvas","getContext","setTransform","fillStyle","fillRect","imageSmoothingEnabled","pixelReplication","sx","displayedArea","tlhc","x","sy","y","brhc","drawImage"],"sources":["../../../../../../src/RenderingEngine/helpers/cpuFallback/rendering/renderGrayscaleImage.ts"],"sourcesContent":[null],"mappings":"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"},"metadata":{},"sourceType":"module","externalDependencies":[]}