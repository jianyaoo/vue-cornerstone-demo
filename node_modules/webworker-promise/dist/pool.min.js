!function(e,r){"object"==typeof exports&&"object"==typeof module?module.exports=r():"function"==typeof define&&define.amd?define([],r):"object"==typeof exports?exports["webworker-promise-pool"]=r():e.WebWorkerPromisePool=r()}("undefined"!=typeof self?self:this,function(){return function(e){var r={};function t(n){if(r[n])return r[n].exports;var o=r[n]={i:n,l:!1,exports:{}};return e[n].call(o.exports,o,o.exports,t),o.l=!0,o.exports}return t.m=e,t.c=r,t.d=function(e,r,n){t.o(e,r)||Object.defineProperty(e,r,{configurable:!1,enumerable:!0,get:n})},t.n=function(e){var r=e&&e.__esModule?function(){return e.default}:function(){return e};return t.d(r,"a",r),r},t.o=function(e,r){return Object.prototype.hasOwnProperty.call(e,r)},t.p="",t(t.s=0)}([function(e,r,t){"use strict";var n=function(){return function(e,r){if(Array.isArray(e))return e;if(Symbol.iterator in Object(e))return function(e,r){var t=[],n=!0,o=!1,i=void 0;try{for(var a,s=e[Symbol.iterator]();!(n=(a=s.next()).done)&&(t.push(a.value),!r||t.length!==r);n=!0);}catch(e){o=!0,i=e}finally{try{!n&&s.return&&s.return()}finally{if(o)throw i}}return t}(e,r);throw new TypeError("Invalid attempt to destructure non-iterable instance")}}(),o=function(){function e(e,r){for(var t=0;t<r.length;t++){var n=r[t];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(r,t,n){return t&&e(r.prototype,t),n&&e(r,n),r}}();var i=t(1),a=function(){function e(r){var t=r.create,n=r.maxThreads,o=r.terminateAfterDelay,i=r.maxConcurrentPerWorker;!function(e,r){if(!(e instanceof r))throw new TypeError("Cannot call a class as a function")}(this,e),this._queue=[],this._workers=[],this._createWorker=t,this._maxThreads=n,this._terminateAfterDelay=o,this._maxConcurrentPerWorker=i;var a=this._createWebWorker();this._workers.push(a)}return o(e,[{key:"exec",value:function(){for(var e=this,r=arguments.length,t=Array(r),n=0;n<r;n++)t[n]=arguments[n];var o=this.getFreeWorkerOrCreate();return o?this._exec(o,"exec",t):new Promise(function(r){return e._queue.push(["exec",t,r])})}},{key:"postMessage",value:function(){for(var e=this,r=arguments.length,t=Array(r),n=0;n<r;n++)t[n]=arguments[n];var o=this.getFreeWorkerOrCreate();return o?this._exec(o,"postMessage",t):new Promise(function(r){return e._queue.push(["postMessage",t,r])})}},{key:"_exec",value:function(e,r,t){var n=this;return new Promise(function(o,i){e[r].apply(e,function(e){if(Array.isArray(e)){for(var r=0,t=Array(e.length);r<e.length;r++)t[r]=e[r];return t}return Array.from(e)}(t)).then(function(r){n._onWorkDone(e),o(r)}).catch(function(r){n._onWorkDone(e),i(r)})})}},{key:"_onWorkDone",value:function(){if(this._queue.length)for(var e=void 0;this._queue.length&&(e=this.getFreeWorkerOrCreate());){var r=this._queue.shift(),t=n(r,3),o=t[0],i=t[1];(0,t[2])(this._exec(e,o,i))}var a=this.getAllFreeWorkers();a.length&&this._waitAndRemoveWorkers(a)}},{key:"_waitAndRemoveWorkers",value:function(e){var r=this;setTimeout(function(){(e=e.filter(function(e){return e.isFree()}).slice(0,r._workers.length-1)).forEach(function(e){return r._removeWorker(e)})},this._terminateAfterDelay)}},{key:"_removeWorker",value:function(e){this._workers=this._workers.filter(function(r){return r._id!==e._id}),e.terminate()}},{key:"getAllFreeWorkers",value:function(){var e=this;return this._workers.filter(function(r){return r.jobsLength()<e._maxConcurrentPerWorker})}},{key:"getFreeWorkerOrCreate",value:function(){var e=this,r=this._workers.find(function(r){return r.jobsLength()<e._maxConcurrentPerWorker});if(!r&&this._workers.length<this._maxThreads){var t=this._createWebWorker();return this._workers.push(t),t}return r}},{key:"_createWebWorker",value:function(){return new i(this._createWorker())}}],[{key:"create",value:function(r){return r.create||(r.create=function(){return new Worker(r.src)}),r.terminateAfterDelay||(r.terminateAfterDelay=5e3),r.maxThreads||(r.maxThreads=2),r.maxConcurrentPerWorker||(r.maxConcurrentPerWorker=1),Number.isInteger(r.maxThreads)&&Number.isInteger(r.maxConcurrentPerWorker)||console.warn("WARNING: The maxThreads and maxConcurrentPerWorker parameters should be integers equal or greater than 1"),new e(r)}}]),e}();e.exports=a},function(e,r,t){"use strict";var n=function(){return function(e,r){if(Array.isArray(e))return e;if(Symbol.iterator in Object(e))return function(e,r){var t=[],n=!0,o=!1,i=void 0;try{for(var a,s=e[Symbol.iterator]();!(n=(a=s.next()).done)&&(t.push(a.value),!r||t.length!==r);n=!0);}catch(e){o=!0,i=e}finally{try{!n&&s.return&&s.return()}finally{if(o)throw i}}return t}(e,r);throw new TypeError("Invalid attempt to destructure non-iterable instance")}}(),o=function(){function e(e,r){for(var t=0;t<r.length;t++){var n=r[t];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(r,t,n){return t&&e(r.prototype,t),n&&e(r,n),r}}();function i(e){if(Array.isArray(e)){for(var r=0,t=Array(e.length);r<e.length;r++)t[r]=e[r];return t}return Array.from(e)}var a=t(2),s=function(e){function r(e){!function(e,r){if(!(e instanceof r))throw new TypeError("Cannot call a class as a function")}(this,r);var t=function(e,r){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!r||"object"!=typeof r&&"function"!=typeof r?e:r}(this,(r.__proto__||Object.getPrototypeOf(r)).call(this));return t._messageId=1,t._messages=new Map,t._worker=e,t._worker.onmessage=t._onMessage.bind(t),t._id=Math.ceil(1e7*Math.random()),t}return function(e,r){if("function"!=typeof r&&null!==r)throw new TypeError("Super expression must either be null or a function, not "+typeof r);e.prototype=Object.create(r&&r.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),r&&(Object.setPrototypeOf?Object.setPrototypeOf(e,r):e.__proto__=r)}(r,a),o(r,[{key:"terminate",value:function(){this._worker.terminate()}},{key:"isFree",value:function(){return 0===this._messages.size}},{key:"jobsLength",value:function(){return this._messages.size}},{key:"exec",value:function(e){var r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,t=this,n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:[],o=arguments[3];return new Promise(function(i,a){var s=t._messageId++;t._messages.set(s,[i,a,o]),t._worker.postMessage([s,r,e],n||[])})}},{key:"postMessage",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null,r=this,t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[],n=arguments[2];return new Promise(function(o,i){var a=r._messageId++;r._messages.set(a,[o,i,n]),r._worker.postMessage([a,e],t||[])})}},{key:"emit",value:function(e){for(var r=arguments.length,t=Array(r>1?r-1:0),n=1;n<r;n++)t[n-1]=arguments[n];this._worker.postMessage({eventName:e,args:t})}},{key:"_onMessage",value:function(e){var t;if(!Array.isArray(e.data)&&e.data.eventName)return(t=function e(r,t,n){null===r&&(r=Function.prototype);var o=Object.getOwnPropertyDescriptor(r,t);if(void 0===o){var i=Object.getPrototypeOf(r);return null===i?void 0:e(i,t,n)}if("value"in o)return o.value;var a=o.get;return void 0!==a?a.call(n):void 0}(r.prototype.__proto__||Object.getPrototypeOf(r.prototype),"emit",this)).call.apply(t,[this,e.data.eventName].concat(i(e.data.args)));var n=function(e){return Array.isArray(e)?e:Array.from(e)}(e.data),o=n[0],a=n.slice(1);if(1===o)this._onEvent.apply(this,i(a));else{if(0!==o)throw new Error("Wrong message type '"+o+"'");this._onResult.apply(this,i(a))}}},{key:"_onResult",value:function(e,r,t){var o=this._messages.get(e),i=n(o,2),a=i[0],s=i[1];return this._messages.delete(e),1===r?a(t):s(t)}},{key:"_onEvent",value:function(e,r,t){var o=this._messages.get(e),i=n(o,3)[2];i&&i(r,t)}}]),r}();e.exports=s},function(e,r,t){"use strict";var n=function(){function e(e,r){for(var t=0;t<r.length;t++){var n=r[t];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(r,t,n){return t&&e(r.prototype,t),n&&e(r,n),r}}();var o=function(){function e(){!function(e,r){if(!(e instanceof r))throw new TypeError("Cannot call a class as a function")}(this,e),Object.defineProperty(this,"__listeners",{value:{},enumerable:!1,writable:!1})}return n(e,[{key:"emit",value:function(e){if(!this.__listeners[e])return this;for(var r=arguments.length,t=Array(r>1?r-1:0),n=1;n<r;n++)t[n-1]=arguments[n];var o=!0,i=!1,a=void 0;try{for(var s,u=this.__listeners[e][Symbol.iterator]();!(o=(s=u.next()).done);o=!0){s.value.apply(void 0,t)}}catch(e){i=!0,a=e}finally{try{!o&&u.return&&u.return()}finally{if(i)throw a}}return this}},{key:"once",value:function(e,r){var t=this,n=function n(){t.off(e,n),r.apply(void 0,arguments)};return this.on(e,n)}},{key:"on",value:function(e,r){return this.__listeners[e]||(this.__listeners[e]=[]),this.__listeners[e].push(r),this}},{key:"off",value:function(e,r){return this.__listeners[e]=r?this.__listeners[e].filter(function(e){return e!==r}):[],this}}]),e}();e.exports=o}])});