{"ast":null,"code":"import \"core-js/modules/es.array.push.js\";\nimport cloneDeep from 'lodash.clonedeep';\nimport { Enums, eventTarget, getEnabledElement, utilities } from '@cornerstonejs/core';\nimport { checkAndDefineIsLockedProperty } from './annotationLocking';\nimport { checkAndDefineIsVisibleProperty } from './annotationVisibility';\nclass FrameOfReferenceSpecificAnnotationManager {\n  constructor(uid) {\n    this.getGroupKey = annotationGroupSelector => {\n      if (typeof annotationGroupSelector === 'string') {\n        return annotationGroupSelector;\n      }\n      const element = annotationGroupSelector;\n      const enabledElement = getEnabledElement(element);\n      if (!enabledElement) {\n        throw new Error('Element not enabled, you must have an enabled element if you are not providing a FrameOfReferenceUID');\n      }\n      return enabledElement.FrameOfReferenceUID;\n    };\n    this._imageVolumeModifiedHandler = evt => {\n      const eventDetail = evt.detail;\n      const {\n        FrameOfReferenceUID\n      } = eventDetail;\n      const annotations = this.annotations;\n      const frameOfReferenceSpecificAnnotations = annotations[FrameOfReferenceUID];\n      if (!frameOfReferenceSpecificAnnotations) {\n        return;\n      }\n      Object.keys(frameOfReferenceSpecificAnnotations).forEach(toolName => {\n        const toolSpecificAnnotations = frameOfReferenceSpecificAnnotations[toolName];\n        toolSpecificAnnotations.forEach(annotation => {\n          const invalidated = annotation.invalidated;\n          if (invalidated !== undefined) {\n            annotation.invalidated = true;\n          }\n        });\n      });\n    };\n    this.getFramesOfReference = () => {\n      return Object.keys(this.annotations);\n    };\n    this.getAnnotations = (groupKey, toolName) => {\n      const annotations = this.annotations;\n      if (!annotations[groupKey]) {\n        return [];\n      }\n      if (toolName) {\n        return annotations[groupKey][toolName];\n      }\n      return annotations[groupKey];\n    };\n    this.getAnnotation = annotationUID => {\n      const annotations = this.annotations;\n      for (const frameOfReferenceUID in annotations) {\n        const frameOfReferenceAnnotations = annotations[frameOfReferenceUID];\n        for (const toolName in frameOfReferenceAnnotations) {\n          const toolSpecificAnnotations = frameOfReferenceAnnotations[toolName];\n          for (const annotation of toolSpecificAnnotations) {\n            if (annotationUID === annotation.annotationUID) {\n              return annotation;\n            }\n          }\n        }\n      }\n    };\n    this.getNumberOfAnnotations = (groupKey, toolName) => {\n      const annotations = this.getAnnotations(groupKey, toolName);\n      if (!annotations.length) {\n        return 0;\n      }\n      if (toolName) {\n        return annotations.length;\n      }\n      let total = 0;\n      for (const toolName in annotations) {\n        total += annotations[toolName].length;\n      }\n      return total;\n    };\n    this.addAnnotation = (annotation, groupKey) => {\n      const {\n        metadata\n      } = annotation;\n      const {\n        FrameOfReferenceUID,\n        toolName\n      } = metadata;\n      groupKey = groupKey || FrameOfReferenceUID;\n      const annotations = this.annotations;\n      let frameOfReferenceSpecificAnnotations = annotations[groupKey];\n      if (!frameOfReferenceSpecificAnnotations) {\n        annotations[groupKey] = {};\n        frameOfReferenceSpecificAnnotations = annotations[groupKey];\n      }\n      let toolSpecificAnnotations = frameOfReferenceSpecificAnnotations[toolName];\n      if (!toolSpecificAnnotations) {\n        frameOfReferenceSpecificAnnotations[toolName] = [];\n        toolSpecificAnnotations = frameOfReferenceSpecificAnnotations[toolName];\n      }\n      toolSpecificAnnotations.push(annotation);\n      checkAndDefineIsLockedProperty(annotation);\n      checkAndDefineIsVisibleProperty(annotation);\n    };\n    this.removeAnnotation = annotationUID => {\n      const {\n        annotations\n      } = this;\n      for (const groupKey in annotations) {\n        const groupAnnotations = annotations[groupKey];\n        for (const toolName in groupAnnotations) {\n          const toolAnnotations = groupAnnotations[toolName];\n          const index = toolAnnotations.findIndex(annotation => annotation.annotationUID === annotationUID);\n          if (index !== -1) {\n            toolAnnotations.splice(index, 1);\n            if (toolAnnotations.length === 0) {\n              delete groupAnnotations[toolName];\n            }\n          }\n        }\n        if (Object.keys(groupAnnotations).length === 0) {\n          delete annotations[groupKey];\n        }\n      }\n    };\n    this.removeAnnotations = (groupKey, toolName) => {\n      const annotations = this.annotations;\n      if (annotations[groupKey]) {\n        if (toolName) {\n          delete annotations[groupKey][toolName];\n        } else {\n          delete annotations[groupKey];\n        }\n      }\n    };\n    this.saveAnnotations = (groupKey, toolName) => {\n      const annotations = this.annotations;\n      if (groupKey && toolName) {\n        const frameOfReferenceSpecificAnnotations = annotations[groupKey];\n        if (!frameOfReferenceSpecificAnnotations) {\n          return;\n        }\n        const toolSpecificAnnotations = frameOfReferenceSpecificAnnotations[toolName];\n        return cloneDeep(toolSpecificAnnotations);\n      } else if (groupKey) {\n        const frameOfReferenceSpecificAnnotations = annotations[groupKey];\n        return cloneDeep(frameOfReferenceSpecificAnnotations);\n      }\n      return cloneDeep(annotations);\n    };\n    this.restoreAnnotations = (state, groupKey, toolName) => {\n      const annotations = this.annotations;\n      if (groupKey && toolName) {\n        let frameOfReferenceSpecificAnnotations = annotations[groupKey];\n        if (!frameOfReferenceSpecificAnnotations) {\n          annotations[groupKey] = {};\n          frameOfReferenceSpecificAnnotations = annotations[groupKey];\n        }\n        frameOfReferenceSpecificAnnotations[toolName] = state;\n      } else if (groupKey) {\n        annotations[groupKey] = state;\n      } else {\n        this.annotations = cloneDeep(state);\n      }\n    };\n    this.getNumberOfAllAnnotations = () => {\n      let count = 0;\n      const annotations = this.annotations;\n      for (const groupKey in annotations) {\n        const frameOfReferenceSpecificAnnotations = annotations[groupKey];\n        for (const toolName in frameOfReferenceSpecificAnnotations) {\n          const toolSpecificAnnotations = frameOfReferenceSpecificAnnotations[toolName];\n          count += toolSpecificAnnotations.length;\n        }\n      }\n      return count;\n    };\n    this.removeAllAnnotations = () => {\n      this.annotations = {};\n    };\n    if (!uid) {\n      uid = utilities.uuidv4();\n    }\n    this.annotations = {};\n    this.uid = uid;\n    eventTarget.addEventListener(Enums.Events.IMAGE_VOLUME_MODIFIED, this._imageVolumeModifiedHandler);\n  }\n}\nconst defaultFrameOfReferenceSpecificAnnotationManager = new FrameOfReferenceSpecificAnnotationManager('DEFAULT');\nexport { defaultFrameOfReferenceSpecificAnnotationManager };\nexport default FrameOfReferenceSpecificAnnotationManager;","map":{"version":3,"names":["cloneDeep","Enums","eventTarget","getEnabledElement","utilities","checkAndDefineIsLockedProperty","checkAndDefineIsVisibleProperty","FrameOfReferenceSpecificAnnotationManager","constructor","uid","getGroupKey","annotationGroupSelector","element","enabledElement","Error","FrameOfReferenceUID","_imageVolumeModifiedHandler","evt","eventDetail","detail","annotations","frameOfReferenceSpecificAnnotations","Object","keys","forEach","toolName","toolSpecificAnnotations","annotation","invalidated","undefined","getFramesOfReference","getAnnotations","groupKey","getAnnotation","annotationUID","frameOfReferenceUID","frameOfReferenceAnnotations","getNumberOfAnnotations","length","total","addAnnotation","metadata","push","removeAnnotation","groupAnnotations","toolAnnotations","index","findIndex","splice","removeAnnotations","saveAnnotations","restoreAnnotations","state","getNumberOfAllAnnotations","count","removeAllAnnotations","uuidv4","addEventListener","Events","IMAGE_VOLUME_MODIFIED","defaultFrameOfReferenceSpecificAnnotationManager"],"sources":["../../../../src/stateManagement/annotation/FrameOfReferenceSpecificAnnotationManager.ts"],"sourcesContent":[null],"mappings":"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"},"metadata":{},"sourceType":"module","externalDependencies":[]}