{"ast":null,"code":"import { getEnabledElement, triggerEvent, getRenderingEngine } from '@cornerstonejs/core';\nimport { Events, ToolModes } from '../enums';\nimport { draw as drawSvg } from '../drawingSvg';\nimport getToolsWithModesForElement from './getToolsWithModesForElement';\nconst {\n  Active,\n  Passive,\n  Enabled\n} = ToolModes;\nclass AnnotationRenderingEngine {\n  constructor() {\n    this._needsRender = new Set();\n    this._animationFrameSet = false;\n    this._animationFrameHandle = null;\n    this._renderFlaggedViewports = () => {\n      this._throwIfDestroyed();\n      const elements = Array.from(this._viewportElements.values());\n      for (let i = 0; i < elements.length; i++) {\n        const element = elements[i];\n        if (this._needsRender.has(element)) {\n          this._triggerRender(element);\n          this._needsRender.delete(element);\n          if (this._needsRender.size === 0) {\n            this._animationFrameSet = false;\n            this._animationFrameHandle = null;\n            return;\n          }\n        }\n      }\n    };\n    this._viewportElements = new Map();\n  }\n  addViewportElement(viewportId, element) {\n    this._viewportElements.set(viewportId, element);\n  }\n  removeViewportElement(viewportId, element) {\n    this._viewportElements.delete(viewportId);\n    this._needsRender.delete(element);\n    this._reset();\n  }\n  renderViewport(element) {\n    this._setViewportsToBeRenderedNextFrame([element]);\n  }\n  _throwIfDestroyed() {\n    if (this.hasBeenDestroyed) {\n      throw new Error('this.destroy() has been manually called to free up memory, can not longer use this instance. Instead make a new one.');\n    }\n  }\n  _setAllViewportsToBeRenderedNextFrame() {\n    const elements = [...this._viewportElements.values()];\n    elements.forEach(element => {\n      this._needsRender.add(element);\n    });\n    this._renderFlaggedViewports();\n  }\n  _setViewportsToBeRenderedNextFrame(elements) {\n    const elementsEnabled = [...this._viewportElements.values()];\n    elements.forEach(element => {\n      if (elementsEnabled.indexOf(element) !== -1) {\n        this._needsRender.add(element);\n      }\n    });\n    this._render();\n  }\n  _render() {\n    if (this._needsRender.size > 0 && this._animationFrameSet === false) {\n      this._animationFrameHandle = window.requestAnimationFrame(this._renderFlaggedViewports);\n      this._animationFrameSet = true;\n    }\n  }\n  _triggerRender(element) {\n    const enabledElement = getEnabledElement(element);\n    if (!enabledElement) {\n      console.warn('Element has been disabled');\n      return;\n    }\n    const renderingEngine = getRenderingEngine(enabledElement.renderingEngineId);\n    if (!renderingEngine) {\n      console.warn('rendering Engine has been destroyed');\n      return;\n    }\n    const enabledTools = getToolsWithModesForElement(element, [Active, Passive, Enabled]);\n    const {\n      renderingEngineId,\n      viewportId\n    } = enabledElement;\n    const eventDetail = {\n      element,\n      renderingEngineId,\n      viewportId\n    };\n    drawSvg(element, svgDrawingHelper => {\n      let anyRendered = false;\n      const handleDrawSvg = tool => {\n        if (tool.renderAnnotation) {\n          const rendered = tool.renderAnnotation(enabledElement, svgDrawingHelper);\n          anyRendered = anyRendered || rendered;\n        }\n      };\n      enabledTools.forEach(handleDrawSvg);\n      if (anyRendered) {\n        triggerEvent(element, Events.ANNOTATION_RENDERED, {\n          ...eventDetail\n        });\n      }\n    });\n  }\n  _reset() {\n    window.cancelAnimationFrame(this._animationFrameHandle);\n    this._needsRender.clear();\n    this._animationFrameSet = false;\n    this._animationFrameHandle = null;\n    this._setAllViewportsToBeRenderedNextFrame();\n  }\n}\nconst annotationRenderingEngine = new AnnotationRenderingEngine();\nfunction triggerAnnotationRender(element) {\n  annotationRenderingEngine.renderViewport(element);\n}\nexport { annotationRenderingEngine, triggerAnnotationRender };\nexport default triggerAnnotationRender;","map":{"version":3,"names":["getEnabledElement","triggerEvent","getRenderingEngine","Events","ToolModes","draw","drawSvg","getToolsWithModesForElement","Active","Passive","Enabled","AnnotationRenderingEngine","constructor","_needsRender","Set","_animationFrameSet","_animationFrameHandle","_renderFlaggedViewports","_throwIfDestroyed","elements","Array","from","_viewportElements","values","i","length","element","has","_triggerRender","delete","size","Map","addViewportElement","viewportId","set","removeViewportElement","_reset","renderViewport","_setViewportsToBeRenderedNextFrame","hasBeenDestroyed","Error","_setAllViewportsToBeRenderedNextFrame","forEach","add","elementsEnabled","indexOf","_render","window","requestAnimationFrame","enabledElement","console","warn","renderingEngine","renderingEngineId","enabledTools","eventDetail","svgDrawingHelper","anyRendered","handleDrawSvg","tool","renderAnnotation","rendered","ANNOTATION_RENDERED","cancelAnimationFrame","clear","annotationRenderingEngine","triggerAnnotationRender"],"sources":["../../../src/utilities/triggerAnnotationRender.ts"],"sourcesContent":[null],"mappings":"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"},"metadata":{},"sourceType":"module","externalDependencies":[]}