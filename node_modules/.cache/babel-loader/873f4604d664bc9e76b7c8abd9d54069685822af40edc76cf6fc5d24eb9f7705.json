{"ast":null,"code":"import { triggerEvent, eventTarget, getRenderingEngine, Enums } from '@cornerstonejs/core';\nimport { Events as csToolsEvents } from '../../enums';\nimport { getToolGroup, getToolGroupForViewport } from '../../store/ToolGroupManager';\nimport SegmentationDisplayTool from '../../tools/displayTools/SegmentationDisplayTool';\nclass SegmentationRenderingEngine {\n  constructor() {\n    this._needsRender = new Set();\n    this._animationFrameSet = false;\n    this._animationFrameHandle = null;\n    this._renderFlaggedToolGroups = () => {\n      this._throwIfDestroyed();\n      const toolGroupIds = Array.from(this._needsRender.values());\n      for (const toolGroupId of toolGroupIds) {\n        this._triggerRender(toolGroupId);\n        this._needsRender.delete(toolGroupId);\n        if (this._needsRender.size === 0) {\n          this._animationFrameSet = false;\n          this._animationFrameHandle = null;\n          return;\n        }\n      }\n    };\n  }\n  removeToolGroup(toolGroupId) {\n    this._needsRender.delete(toolGroupId);\n    if (this._needsRender.size === 0) {\n      this._reset();\n    }\n  }\n  renderToolGroupSegmentations(toolGroupId) {\n    this._setToolGroupSegmentationToBeRenderedNextFrame([toolGroupId]);\n  }\n  _throwIfDestroyed() {\n    if (this.hasBeenDestroyed) {\n      throw new Error('this.destroy() has been manually called to free up memory, can not longer use this instance. Instead make a new one.');\n    }\n  }\n  _setToolGroupSegmentationToBeRenderedNextFrame(toolGroupIds) {\n    toolGroupIds.forEach(toolGroupId => {\n      this._needsRender.add(toolGroupId);\n    });\n    this._render();\n  }\n  _render() {\n    if (this._needsRender.size > 0 && this._animationFrameSet === false) {\n      this._animationFrameHandle = window.requestAnimationFrame(this._renderFlaggedToolGroups);\n      this._animationFrameSet = true;\n    }\n  }\n  _triggerRender(toolGroupId) {\n    const toolGroup = getToolGroup(toolGroupId);\n    if (!toolGroup) {\n      console.warn(`No tool group found with toolGroupId: ${toolGroupId}`);\n      return;\n    }\n    const {\n      viewportsInfo\n    } = toolGroup;\n    const viewports = viewportsInfo.map(({\n      viewportId,\n      renderingEngineId\n    }) => {\n      const renderingEngine = getRenderingEngine(renderingEngineId);\n      if (!renderingEngine) {\n        console.warn('rendering Engine has been destroyed');\n        return;\n      }\n      const viewport = renderingEngine.getViewport(viewportId);\n      if (viewport) {\n        return viewport;\n      }\n    }).filter(Boolean);\n    const segmentationDisplayToolInstance = toolGroup.getToolInstance(SegmentationDisplayTool.toolName);\n    if (!segmentationDisplayToolInstance) {\n      console.warn('No segmentation tool found inside', toolGroupId);\n      return;\n    }\n    function onSegmentationRender(evt) {\n      const {\n        element,\n        viewportId,\n        renderingEngineId\n      } = evt.detail;\n      element.removeEventListener(Enums.Events.IMAGE_RENDERED, onSegmentationRender);\n      const toolGroup = getToolGroupForViewport(viewportId, renderingEngineId);\n      if (!toolGroup) {\n        console.warn('toolGroup has been destroyed');\n        return;\n      }\n      const eventDetail = {\n        toolGroupId: toolGroup.id,\n        viewportId\n      };\n      triggerEvent(eventTarget, csToolsEvents.SEGMENTATION_RENDERED, {\n        ...eventDetail\n      });\n    }\n    viewports.forEach(({\n      element\n    }) => {\n      element.addEventListener(Enums.Events.IMAGE_RENDERED, onSegmentationRender);\n    });\n    segmentationDisplayToolInstance.renderSegmentation(toolGroupId);\n  }\n  _reset() {\n    window.cancelAnimationFrame(this._animationFrameHandle);\n    this._needsRender.clear();\n    this._animationFrameSet = false;\n    this._animationFrameHandle = null;\n  }\n}\nconst segmentationRenderingEngine = new SegmentationRenderingEngine();\nfunction triggerSegmentationRender(toolGroupId) {\n  segmentationRenderingEngine.renderToolGroupSegmentations(toolGroupId);\n}\nexport { segmentationRenderingEngine, triggerSegmentationRender };\nexport default triggerSegmentationRender;","map":{"version":3,"names":["triggerEvent","eventTarget","getRenderingEngine","Enums","Events","csToolsEvents","getToolGroup","getToolGroupForViewport","SegmentationDisplayTool","SegmentationRenderingEngine","constructor","_needsRender","Set","_animationFrameSet","_animationFrameHandle","_renderFlaggedToolGroups","_throwIfDestroyed","toolGroupIds","Array","from","values","toolGroupId","_triggerRender","delete","size","removeToolGroup","_reset","renderToolGroupSegmentations","_setToolGroupSegmentationToBeRenderedNextFrame","hasBeenDestroyed","Error","forEach","add","_render","window","requestAnimationFrame","toolGroup","console","warn","viewportsInfo","viewports","map","viewportId","renderingEngineId","renderingEngine","viewport","getViewport","filter","Boolean","segmentationDisplayToolInstance","getToolInstance","toolName","onSegmentationRender","evt","element","detail","removeEventListener","IMAGE_RENDERED","eventDetail","id","SEGMENTATION_RENDERED","addEventListener","renderSegmentation","cancelAnimationFrame","clear","segmentationRenderingEngine","triggerSegmentationRender"],"sources":["../../../../src/utilities/segmentation/triggerSegmentationRender.ts"],"sourcesContent":[null],"mappings":"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"},"metadata":{},"sourceType":"module","externalDependencies":[]}