!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t(require("@cornerstonejs/core"),require("gl-matrix")):"function"==typeof define&&define.amd?define(["@cornerstonejs/core","gl-matrix"],t):"object"==typeof exports?exports.cornerstoneStreamingImageVolumeLoader=t(require("@cornerstonejs/core"),require("gl-matrix")):e.cornerstoneStreamingImageVolumeLoader=t(e.cornerstone3D,e.window)}(self,((e,t)=>(()=>{"use strict";var a={953:t=>{t.exports=e},976:e=>{e.exports=t}},r={};function s(e){var t=r[e];if(void 0!==t)return t.exports;var n=r[e]={exports:{}};return a[e](n,n.exports,s),n.exports}s.d=(e,t)=>{for(var a in t)s.o(t,a)&&!s.o(e,a)&&Object.defineProperty(e,a,{enumerable:!0,get:t[a]})},s.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),s.r=e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})};var n={};return(()=>{s.r(n),s.d(n,{Enums:()=>e,StreamingDynamicImageVolume:()=>_,StreamingImageVolume:()=>g,cornerstoneStreamingDynamicImageVolumeLoader:()=>w,cornerstoneStreamingImageVolumeLoader:()=>h,helpers:()=>F});var e={};s.r(e),s.d(e,{Events:()=>x});var t=s(953);function a(e){return a="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},a(e)}function r(e,t,r){return(t=function(e){var t=function(e,t){if("object"!==a(e)||null===e)return e;var r=e[Symbol.toPrimitive];if(void 0!==r){var s=r.call(e,"string");if("object"!==a(s))return s;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(e)}(e);return"symbol"===a(t)?t:String(t)}(t))in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}const i=e=>{const a=function(e){const a=(0,t.getRenderingEngines)(),r=[];for(let s=0;s<a.length;s++){const n=a[s],i=t.utilities.getViewportsWithVolumeId(e,n.id);i.length&&r.push({renderingEngine:n,viewportIds:i.map((e=>e.id))})}return r}(e);a&&a.length&&a.forEach((e=>{let{renderingEngine:t,viewportIds:a}=e;t.hasBeenDestroyed||t.renderViewports(a)}))};function o(e,t){const a=e.length,{rescaleSlope:r,rescaleIntercept:s,suvbw:n}=t;if("PT"===t.modality&&"number"==typeof n)for(let t=0;t<a;t++)e[t]=n*(e[t]*r+s);else for(let t=0;t<a;t++)e[t]=e[t]*r+s;return e}const l=t.Enums.RequestType.Prefetch,{ProgressiveIterator:c}=t.utilities,{ImageQualityStatus:d}=t.Enums,{imageRetrieveMetadataProvider:m}=t.utilities;class u extends t.ImageVolume{constructor(e,a){super(e),r(this,"framesLoaded",0),r(this,"framesProcessed",0),r(this,"framesUpdated",0),r(this,"autoRenderOnLoad",!0),r(this,"cachedFrames",[]),r(this,"reRenderTarget",0),r(this,"reRenderFraction",2),r(this,"loadStatus",void 0),r(this,"imagesLoader",this),r(this,"cancelLoading",(()=>{const{loadStatus:e}=this;e&&e.loading&&(e.loading=!1,e.cancelled=!0,this.clearLoadCallbacks(),t.imageLoadPoolManager.filterRequests((e=>{let{additionalDetails:t}=e;return t.volumeId!==this.volumeId})))})),r(this,"load",(e=>{const{imageIds:a,loadStatus:r,numFrames:s}=this,{transferSyntaxUID:n}=t.metaData.get("transferSyntax",a[0])||{},i=t.metaData.get(m.IMAGE_RETRIEVE_CONFIGURATION,this.volumeId,n,"volume");if(this.imagesLoader=i?(i.create||t.ProgressiveRetrieveImages.createProgressive)(i):this,!0===r.loading)return;const{loaded:o}=this.loadStatus,l=a.length;o?e&&e({success:!0,framesLoaded:l,framesProcessed:l,numFrames:s,totalNumFrames:l}):(e&&this.loadStatus.callbacks.push(e),this._prefetchImageIds())})),this.loadStatus=a.loadStatus}invalidateVolume(e){const{imageData:t,vtkOpenGLTexture:a}=this,{numFrames:r}=this;for(let e=0;e<r;e++)a.setUpdatedFrame(e);t.modified(),e&&i(this.volumeId)}clearLoadCallbacks(){this.loadStatus.callbacks=[]}callLoadStatusCallback(e){const{framesUpdated:a,framesProcessed:r,totalNumFrames:s}=e,{volumeId:n,reRenderFraction:o,loadStatus:l,metadata:c}=this,{FrameOfReferenceUID:d}=c;if(this.autoRenderOnLoad&&(a>this.reRenderTarget||r===s)&&(this.reRenderTarget+=o,i(n)),r===s){l.callbacks.forEach((t=>t(e)));const a={FrameOfReferenceUID:d,volumeId:n};(0,t.triggerEvent)(t.eventTarget,t.Enums.Events.IMAGE_VOLUME_LOADING_COMPLETED,a)}}updateTextureAndTriggerEvents(e,a){let r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:d.FULL_RESOLUTION;const s=this.imageIdIndexToFrameIndex(e),{cachedFrames:n,numFrames:i,totalNumFrames:o}=this,{FrameOfReferenceUID:l}=this.metadata;if(n[s]>r)return;if(n[s]===d.FULL_RESOLUTION)return;const c=r===d.FULL_RESOLUTION;n[e]=r,this.framesUpdated++,c&&(this.framesLoaded++,this.framesProcessed++),this.vtkOpenGLTexture.setUpdatedFrame(s),this.imageData.modified();const m={FrameOfReferenceUID:l,imageVolume:this};(0,t.triggerEvent)(t.eventTarget,t.Enums.Events.IMAGE_VOLUME_MODIFIED,m),c&&this.framesProcessed===this.totalNumFrames&&(this.loadStatus.loaded=!0,this.loadStatus.loading=!1),this.callLoadStatusCallback({success:!0,imageIdIndex:e,imageId:a,framesLoaded:this.framesLoaded,framesProcessed:this.framesProcessed,framesUpdated:this.framesUpdated,numFrames:i,totalNumFrames:o,complete:c,imageQualityStatus:r}),this.loadStatus.loaded&&(this.loadStatus.callbacks=[])}successCallback(e,a){const r=this.getImageIdIndex(e),s=this.getLoaderImageOptions(e),n=this.getScalarDataByImageIdIndex(r);!function(e,t,a){if(!(e.buffer instanceof ArrayBuffer))return;const r=a.targetBuffer.offset,s=a.targetBuffer.length,n=t.pixelData?t.pixelData:t.getPixelData();try{if(e instanceof Float32Array){const t=4,a=new Float32Array(n);if(a.length!==s)throw"Error pixelData length does not match frame length";e.set(a,r/t)}if(e instanceof Int16Array){const t=2,a=new Int16Array(n);if(a.length!==s)throw"Error pixelData length does not match frame length";e.set(a,r/t)}if(e instanceof Uint16Array){const t=2,a=new Uint16Array(n);if(a.length!==s)throw"Error pixelData length does not match frame length";e.set(a,r/t)}if(e instanceof Uint8Array){const t=1,a=new Uint8Array(n);if(a.length!==s)throw"Error pixelData length does not match frame length";e.set(a,r/t)}}catch(e){console.error(e)}}(n,a,s);const{scalingParameters:i}=a.preScale||{},{imageQualityStatus:o}=a,l=this.imageIdIndexToFrameIndex(r),c=t.cache.getCachedImageBasedOnImageURI(e),d=t.cache.getVolumeContainingImageId(e);if(this.loadStatus.cancelled)return void console.warn("volume load cancelled, returning for imageIdIndex: ",r);if(!(c||d&&d.volume!==this))return this.updateTextureAndTriggerEvents(r,e,o);const m=!!c;var u,g;m&&s.targetBuffer&&this.imageCacheOffsetMap.set(e,{imageIdIndex:r,frameIndex:l,offset:(null===(u=s.targetBuffer)||void 0===u?void 0:u.offset)||0,length:null===(g=s.targetBuffer)||void 0===g?void 0:g.length});const h=c||d.volume;this.handleImageComingFromCache(h,m,i,n,l,n.buffer,r,e)}errorCallback(e,a,r){if(!a)return;const{totalNumFrames:s,numFrames:n}=this,i=this.getImageIdIndex(e);this.framesProcessed++,this.framesProcessed===s&&(this.loadStatus.loaded=!0,this.loadStatus.loading=!1),this.callLoadStatusCallback({success:!1,imageId:e,imageIdIndex:i,error:r,framesLoaded:this.framesLoaded,framesProcessed:this.framesProcessed,framesUpdated:this.framesUpdated,numFrames:n,totalNumFrames:s}),this.loadStatus.loaded&&(this.loadStatus.callbacks=[]);const o={error:r,imageIdIndex:i,imageId:e};(0,t.triggerEvent)(t.eventTarget,t.Enums.Events.IMAGE_LOAD_ERROR,o)}getLoaderImageOptions(e){const{transferSyntaxUID:a}=t.metaData.get("transferSyntax",e)||{},r=t.metaData.get("imagePlaneModule",e)||{},{rows:s,columns:n}=r,i=this.getImageIdIndex(e),o=this.getScalarDataByImageIdIndex(i);if(!o)return null;const l=o.buffer,{type:c,length:d,lengthInBytes:m}=function(e,t){let a,r;if(e instanceof Uint8Array)a="Uint8Array",r=1;else if(e instanceof Float32Array)a="Float32Array",r=4;else if(e instanceof Uint16Array)a="Uint16Array",r=2;else{if(!(e instanceof Int16Array))throw new Error("Unsupported array type");a="Int16Array",r=2}const s=e.length/t;return{type:a,byteSize:r,length:s,lengthInBytes:s*r}}(o,this.numFrames),u=t.metaData.get("modalityLutModule",e)||{},g=t.metaData.get("generalSeriesModule",e)||{},h={rescaleSlope:u.rescaleSlope,rescaleIntercept:u.rescaleIntercept,modality:g.modality};if("PT"===h.modality){const a=t.metaData.get("scalingModule",e);a&&(this._addScalingToVolume(a),h.suvbw=a.suvbw)}const I="number"==typeof h.rescaleSlope&&"number"==typeof h.rescaleIntercept;this.isPreScaled=I;const f=this.imageIdIndexToFrameIndex(i);return{targetBuffer:{arrayBuffer:l instanceof ArrayBuffer?void 0:l,offset:f*m,length:d,type:c,rows:s,columns:n},skipCreateImage:!0,preScale:{enabled:!0,scalingParameters:h},transferPixelData:!0,transferSyntaxUID:a,loader:t.imageLoader.loadImage,additionalDetails:{imageId:e,imageIdIndex:i,volumeId:this.volumeId}}}callLoadImage(e,a,r){const{cachedFrames:s}=this;if(s[a]!==d.FULL_RESOLUTION)return c.as(t.imageLoader.loadImage(e,r)).forEach((t=>{this.successCallback(e,t)}),this.errorCallback.bind(this,a,e))}getImageIdsRequests(e,t){return this.totalNumFrames=this.imageIds.length,this.autoRenderOnLoad&&(this.reRenderFraction=.02*this.totalNumFrames,this.reRenderTarget=this.reRenderFraction),e.map((e=>{const a=this.getImageIdIndex(e),r=l,s=t,n=this.getLoaderImageOptions(e);return{callLoadImage:this.callLoadImage.bind(this),imageId:e,imageIdIndex:a,options:n,priority:s,requestType:r,additionalDetails:{volumeId:this.volumeId}}}))}handleImageComingFromCache(e,t,a,r,s,n,i,o){(t?e.imageLoadObject:e.convertToCornerstoneImage(o,i)).promise.then((e=>{const t=this._scaleIfNecessary(e,a),{pixelsPerImage:l,bytesPerImage:c}=this.cornerstoneImageMetaData,d=r.constructor;let m=c*s;const u=c/l;r.BYTES_PER_ELEMENT!==u&&(m*=r.BYTES_PER_ELEMENT/u),new d(n,m,l).set(t),this.updateTextureAndTriggerEvents(i,o,e.imageQualityStatus)})).catch((e=>{this.errorCallback(o,!0,e)}))}getImageLoadRequests(e){throw new Error("Abstract method")}getImageIdsToLoad(){throw new Error("Abstract method")}loadImages(e,a){return this.loadStatus.loading=!0,this.getImageLoadRequests(5).reverse().forEach((e=>{if(!e)return;const{callLoadImage:a,imageId:r,imageIdIndex:s,options:n,priority:i,requestType:o,additionalDetails:l}=e;t.imageLoadPoolManager.addRequest(a.bind(this,r,s,n),o,l,i)})),Promise.resolve(!0)}_prefetchImageIds(){this.loadStatus.loading=!0;const e=[...this.getImageIdsToLoad()];return e.reverse(),this.totalNumFrames=this.imageIds.length,this.autoRenderOnLoad&&(this.reRenderFraction=.02*this.totalNumFrames,this.reRenderTarget=this.reRenderFraction),this.imagesLoader.loadImages(e,this).catch((e=>{console.debug("progressive loading failed to complete",e)}))}_scaleIfNecessary(e,t){var a;const r=null===(a=e.preScale)||void 0===a?void 0:a.scaled,s=!t||!t.rescaleIntercept||!t.rescaleSlope;if(!r&&s)return e.getPixelData().slice(0);if(!r&&t&&void 0!==t.rescaleIntercept&&void 0!==t.rescaleSlope)return o(e.getPixelData().slice(0),t);const{rescaleSlope:n,rescaleIntercept:i,suvbw:l}=t,{rescaleSlope:c,rescaleIntercept:d,suvbw:m}=e.preScale.scalingParameters;if(n===c&&i===d&&l===m)return e.getPixelData();const u=l/m,g=n/c,h=i-d*g;return o(e.getPixelData().slice(0),{...t,rescaleSlope:g,rescaleIntercept:h,suvbw:u})}_addScalingToVolume(e){if(this.scaling)return;const{suvbw:t,suvlbm:a,suvbsa:r}=e,s={};a&&(s.suvbwToSuvlbm=a/t),r&&(s.suvbwToSuvbsa=r/t),t&&(s.suvbw=t),this.scaling={PT:s}}}class g extends u{constructor(e,t){e.imageIds||(e.imageIds=t.imageIds),super(e,t),r(this,"getImageIdsToLoad",(()=>{const{imageIds:e}=this;return this.numFrames=e.length,e}))}getScalarData(){return this.scalarData}getImageLoadRequests(e){const{imageIds:t}=this;return this.getImageIdsRequests(t,e)}}const h=function(e,a){if(!a||!a.imageIds||!a.imageIds.length)throw new Error("ImageIds must be provided to create a streaming image volume");const r=async function(){if("wadouri"===a.imageIds[0].split(":")[0]){const[r,s]=[Math.floor(a.imageIds.length/2),a.imageIds.length-1],n=[0,r,s];await Promise.all(n.map((r=>new Promise(((s,n)=>{const i=a.imageIds[r];t.imageLoadPoolManager.addRequest((async()=>{t.imageLoader.loadImage(i).then((()=>{console.log("Prefetched imageId: ".concat(i)),s(!0)})).catch((e=>{n(e)}))}),t.Enums.RequestType.Prefetch,{volumeId:e},1)}))))).catch(console.error)}const{dimensions:r,spacing:s,origin:n,scalarData:i,direction:o,sizeInBytes:l,metadata:c,imageIds:d}=t.utilities.generateVolumePropsFromImageIds(a.imageIds,e);return new g({volumeId:e,metadata:c,dimensions:r,spacing:s,origin:n,direction:o,scalarData:i,sizeInBytes:l,imageIds:d},{imageIds:d,loadStatus:{loaded:!1,loading:!1,cancelled:!1,cachedFrames:[],callbacks:[]}})}();return{promise:r,decache:()=>{r.then((e=>{e.destroy(),e=null}))},cancel:()=>{r.then((e=>{e.cancelLoading()}))}}};function I(e,t){const a={};let r=[];const s=Object.keys(e);for(let n=0;n<s.length;n++){const i=new Set,o=e[s[n]];for(let e=0;e<o.length;e++){const r=t(o[e].imageId)||0;if(a[r]=a[r]||[],a[r].push({imageId:o[e].imageId}),i.add(r),i.size-1<e)return}if(0==n)r=Array.from(i);else if(!P(r,i))return}return a}function f(e,a){const r=t.metaData.get(a,e);try{return parseFloat(r)}catch{return}}function p(e){const a=t.metaData.get("20011003",e);try{const{InlineBinary:e}=a;if(e){const t=atob(e),a=new ArrayBuffer(t.length),r=new DataView(a);for(let e=0;e<t.length;e++)r.setUint8(e,t.charCodeAt(e));return new Float32Array(a)[0]}return parseFloat(a)}catch{return}}function y(e){let a=t.metaData.get("0019100c",e);try{const{InlineBinary:e}=a;return e&&(a=atob(e)),parseFloat(a)}catch{return}}function v(e){let a=t.metaData.get("00431039",e);try{const{InlineBinary:e}=a;return e&&(a=atob(e).split("//")),parseFloat(a[0])%1e5}catch{return}}function P(e,t){if(e.length!=t.size)return!1;for(let a=0;a<e.length;a++)if(!t.has(e[a]))return!1;return!0}function E(e){const a=t.metaData.get("petImageModule",e);return a?a.frameReferenceTime:0}const S=function(e){const a=function(e){const a=e.map((e=>{const{imagePositionPatient:a}=t.metaData.get("imagePlaneModule",e);return{imageId:e,imagePositionPatient:a}}));if(!a.every((e=>e.imagePositionPatient)))return null;const r=(i="imagePositionPatient",a.reduce(((e,t)=>((e[t[i]]=e[t[i]]||[]).push(t),e)),{})),s=Object.keys(r),n=r[s[0]].length;var i;return 1===n?null:s.every((e=>r[e].length===n))?r:null}(e);if(!a)return[e];const r=[e=>f(e,"TemporalPositionIdentifier"),e=>f(e,"DiffusionBValue"),e=>f(e,"TriggerTime"),e=>f(e,"EchoTime"),e=>f(e,"EchoNumber"),p,y,v,E];for(let e=0;e<r.length;e++){const t=I(a,r[e]);if(t)return Object.keys(t).map(Number.parseFloat).sort(((e,t)=>e-t)).map((e=>t[e].map((e=>e.imageId))))}return[e]};var b=s(976);const{createUint8SharedArray:D,createFloat32SharedArray:T}=t.utilities;var L=function(e){return e.DYNAMIC_VOLUME_TIME_POINT_INDEX_CHANGED="DYNAMIC_VOLUME_TIME_POINT_INDEX_CHANGED",e}(L||{});const x=L;class _ extends u{constructor(e,t){_._ensureValidData(e,t),super(e,t),r(this,"_numTimePoints",void 0),r(this,"_timePoints",void 0),r(this,"_timePointIndex",0),r(this,"_getTimePointRequests",((e,t)=>{const{imageIds:a}=e;return this.getImageIdsRequests(a,t)})),r(this,"_getTimePointsRequests",(e=>{const t=this._getTimePointsToLoad();let a=[];return t.forEach((t=>{const r=this._getTimePointRequests(t,e);a=a.concat(r)})),a})),r(this,"getImageLoadRequests",(e=>this._getTimePointsRequests(e))),this._numTimePoints=this.scalarData.length,this._timePoints=this._getTimePointsData()}static _ensureValidData(e,t){const a=t.imageIds,r=e.scalarData;if(a.length%r.length!=0)throw new Error("Number of imageIds is not a multiple of ".concat(r.length))}_getTimePointsData(){const{imageIds:e}=this,t=this.scalarData,{numFrames:a}=this,r=t.length,s=[];for(let n=0;n<r;n++){const r=n*a,i=r+a;s.push({imageIds:e.slice(r,i),scalarData:t[n]})}return s}_getTimePointsToLoad(){const e=this._timePoints,t=this._timePointIndex,a=[e[t]];let r=t-1,s=t+1;for(;r>=0||s<e.length;)r>=0&&a.push(e[r--]),s<e.length&&a.push(e[s++]);return a}getImageIdsToLoad(){const e=this._getTimePointsToLoad();let t=[];return e.forEach((e=>{const{imageIds:a}=e;t=t.concat(a)})),t}isDynamicVolume(){return!0}get timePointIndex(){return this._timePointIndex}set timePointIndex(e){if(e<0||e>=this.numTimePoints)throw new Error("Invalid timePointIndex (".concat(e,")"));if(this._timePointIndex===e)return;const{imageData:a}=this;this._timePointIndex=e,a.getPointData().setActiveScalars("timePoint-".concat(e)),this.invalidateVolume(!0),(0,t.triggerEvent)(t.eventTarget,x.DYNAMIC_VOLUME_TIME_POINT_INDEX_CHANGED,{volumeId:this.volumeId,timePointIndex:e})}get numTimePoints(){return this._numTimePoints}getScalarData(){return this.scalarData[this._timePointIndex]}}const w=function(e,a){if(!a||!a.imageIds||!a.imageIds.length)throw new Error("ImageIds must be provided to create a 4D streaming image volume");const{imageIds:r}=a,s=function(e){return S(e).map((e=>function(e){const a=t.utilities.makeVolumeMetadata(e),{BitsAllocated:r,PixelRepresentation:s,PhotometricInterpretation:n,ImageOrientationPatient:i,PixelSpacing:o,Columns:l,Rows:c}=a,d=b.vec3.fromValues(i[0],i[1],i[2]),m=b.vec3.fromValues(i[3],i[4],i[5]),u=b.vec3.create();b.vec3.cross(u,d,m);const{zSpacing:g,origin:h,sortedImageIds:I}=t.utilities.sortImageIdsAndGetSpacing(e,u),f=e.length,p=[o[1],o[0],g],y=[l,c,f],v=[...d,...m,...u],P=1===s;let E=1;"RGB"===n&&(E=3);const S=(16===r?4:1)*y[0]*y[1]*y[2]*E;if(!t.cache.isCacheable(S))throw new Error(t.Enums.Events.CACHE_SIZE_EXCEEDED);let L;switch(t.cache.decacheIfNecessaryUntilBytesAvailable(S),r){case 8:if(P)throw new Error("8 Bit signed images are not yet supported by this plugin.");L=D(y[0]*y[1]*y[2]);break;case 16:L=T(y[0]*y[1]*y[2]);break;case 24:L=D(y[0]*y[1]*y[2]*E)}return{metadata:a,sortedImageIds:I,dimensions:y,spacing:p,origin:h,direction:v,scalarData:L,sizeInBytes:S}}(e)))}(r),{metadata:n,dimensions:i,spacing:o,origin:l,direction:c,sizeInBytes:d}=s[0],m=[],u=[];s.forEach((e=>{m.push(e.sortedImageIds),u.push(e.scalarData)}));const g=m.flat();let h=new _({volumeId:e,metadata:n,dimensions:i,spacing:o,origin:l,direction:c,scalarData:u,sizeInBytes:d,imageIds:g},{imageIds:g,loadStatus:{loaded:!1,loading:!1,cancelled:!1,cachedFrames:[],callbacks:[]}});return{promise:Promise.resolve(h),decache:()=>{h.destroy(),h=null},cancel:()=>{h.cancelLoading()}}},F={getDynamicVolumeInfo:function(e){const t=S(e);return{isDynamicVolume:t.length>1,timePoints:t}}}})(),n})()));
//# sourceMappingURL=index.js.map