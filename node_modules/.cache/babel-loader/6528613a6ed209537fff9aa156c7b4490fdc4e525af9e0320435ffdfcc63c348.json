{"ast":null,"code":"import { BaseTool } from './base';\nimport { getEnabledElement, VolumeViewport, utilities, cache } from '@cornerstonejs/core';\nconst DEFAULT_MULTIPLIER = 4;\nconst DEFAULT_IMAGE_DYNAMIC_RANGE = 1024;\nconst PT = 'PT';\nclass WindowLevelTool extends BaseTool {\n  constructor(toolProps = {}, defaultToolProps = {\n    supportedInteractionTypes: ['Mouse', 'Touch']\n  }) {\n    super(toolProps, defaultToolProps);\n    this._getImageDynamicRangeFromMiddleSlice = (scalarData, dimensions) => {\n      const middleSliceIndex = Math.floor(dimensions[2] / 2);\n      const frameLength = dimensions[0] * dimensions[1];\n      let bytesPerVoxel;\n      let TypedArrayConstructor;\n      if (scalarData instanceof Float32Array) {\n        bytesPerVoxel = 4;\n        TypedArrayConstructor = Float32Array;\n      } else if (scalarData instanceof Uint8Array) {\n        bytesPerVoxel = 1;\n        TypedArrayConstructor = Uint8Array;\n      } else if (scalarData instanceof Uint16Array) {\n        bytesPerVoxel = 2;\n        TypedArrayConstructor = Uint16Array;\n      } else if (scalarData instanceof Int16Array) {\n        bytesPerVoxel = 2;\n        TypedArrayConstructor = Int16Array;\n      }\n      const buffer = scalarData.buffer;\n      const byteOffset = middleSliceIndex * frameLength * bytesPerVoxel;\n      const frame = new TypedArrayConstructor(buffer, byteOffset, frameLength);\n      const {\n        max,\n        min\n      } = this._getMinMax(frame, frameLength);\n      return max - min;\n    };\n  }\n  touchDragCallback(evt) {\n    this.mouseDragCallback(evt);\n  }\n  mouseDragCallback(evt) {\n    const {\n      element,\n      deltaPoints\n    } = evt.detail;\n    const enabledElement = getEnabledElement(element);\n    const {\n      renderingEngine,\n      viewport\n    } = enabledElement;\n    let volumeId, lower, upper, modality, newRange, viewportsContainingVolumeUID;\n    let isPreScaled = false;\n    const properties = viewport.getProperties();\n    if (viewport instanceof VolumeViewport) {\n      const targetId = this.getTargetId(viewport);\n      volumeId = targetId.split('volumeId:')[1];\n      viewportsContainingVolumeUID = utilities.getViewportsWithVolumeId(volumeId, renderingEngine.id);\n      ({\n        lower,\n        upper\n      } = properties.voiRange);\n      const volume = cache.getVolume(volumeId);\n      if (!volume) {\n        throw new Error('Volume not found ' + volumeId);\n      }\n      modality = volume.metadata.Modality;\n      isPreScaled = volume.scaling && Object.keys(volume.scaling).length > 0;\n    } else if (properties.voiRange) {\n      modality = viewport.modality;\n      ({\n        lower,\n        upper\n      } = properties.voiRange);\n      const {\n        preScale = {\n          scaled: false\n        }\n      } = viewport.getImageData?.() || {};\n      isPreScaled = preScale.scaled && preScale.scalingParameters?.suvbw !== undefined;\n    } else {\n      throw new Error('Viewport is not a valid type');\n    }\n    if (modality === PT && isPreScaled) {\n      newRange = this.getPTScaledNewRange({\n        deltaPointsCanvas: deltaPoints.canvas,\n        lower,\n        upper,\n        clientHeight: element.clientHeight,\n        isPreScaled,\n        viewport,\n        volumeId\n      });\n    } else {\n      newRange = this.getNewRange({\n        viewport,\n        deltaPointsCanvas: deltaPoints.canvas,\n        volumeId,\n        lower,\n        upper\n      });\n    }\n    viewport.setProperties({\n      voiRange: newRange\n    });\n    viewport.render();\n    if (viewport instanceof VolumeViewport) {\n      viewportsContainingVolumeUID.forEach(vp => {\n        if (viewport !== vp) {\n          vp.render();\n        }\n      });\n      return;\n    }\n  }\n  getPTScaledNewRange({\n    deltaPointsCanvas,\n    lower,\n    upper,\n    clientHeight,\n    viewport,\n    volumeId,\n    isPreScaled\n  }) {\n    let multiplier = DEFAULT_MULTIPLIER;\n    if (isPreScaled) {\n      multiplier = 5 / clientHeight;\n    } else {\n      multiplier = this._getMultiplierFromDynamicRange(viewport, volumeId) || DEFAULT_MULTIPLIER;\n    }\n    const deltaY = deltaPointsCanvas[1];\n    const wcDelta = deltaY * multiplier;\n    upper -= wcDelta;\n    upper = isPreScaled ? Math.max(upper, 0.1) : upper;\n    return {\n      lower,\n      upper\n    };\n  }\n  getNewRange({\n    viewport,\n    deltaPointsCanvas,\n    volumeId,\n    lower,\n    upper\n  }) {\n    const multiplier = this._getMultiplierFromDynamicRange(viewport, volumeId) || DEFAULT_MULTIPLIER;\n    const wwDelta = deltaPointsCanvas[0] * multiplier;\n    const wcDelta = deltaPointsCanvas[1] * multiplier;\n    let {\n      windowWidth,\n      windowCenter\n    } = utilities.windowLevel.toWindowLevel(lower, upper);\n    windowWidth += wwDelta;\n    windowCenter += wcDelta;\n    windowWidth = Math.max(windowWidth, 1);\n    return utilities.windowLevel.toLowHighRange(windowWidth, windowCenter);\n  }\n  _getMultiplierFromDynamicRange(viewport, volumeId) {\n    let imageDynamicRange;\n    if (volumeId) {\n      const imageVolume = cache.getVolume(volumeId);\n      const {\n        dimensions\n      } = imageVolume;\n      const scalarData = imageVolume.getScalarData();\n      const calculatedDynamicRange = this._getImageDynamicRangeFromMiddleSlice(scalarData, dimensions);\n      const BitsStored = imageVolume?.metadata?.BitsStored;\n      const metadataDynamicRange = BitsStored ? 2 ** BitsStored : Infinity;\n      imageDynamicRange = Math.min(calculatedDynamicRange, metadataDynamicRange);\n    } else {\n      imageDynamicRange = this._getImageDynamicRangeFromViewport(viewport);\n    }\n    const ratio = imageDynamicRange / DEFAULT_IMAGE_DYNAMIC_RANGE;\n    return ratio > 1 ? Math.round(ratio) : ratio;\n  }\n  _getImageDynamicRangeFromViewport(viewport) {\n    const {\n      imageData\n    } = viewport.getImageData();\n    const dimensions = imageData.getDimensions();\n    if (imageData.getRange) {\n      return imageData.getRange();\n    }\n    let scalarData;\n    if (imageData.getScalarData) {\n      scalarData = imageData.getScalarData();\n    } else {\n      scalarData = imageData.getPointData().getScalars();\n    }\n    if (dimensions[2] !== 1) {\n      return this._getImageDynamicRangeFromMiddleSlice(scalarData, dimensions);\n    }\n    let range;\n    if (scalarData.getRange) {\n      range = scalarData.getRange();\n    } else {\n      const {\n        min,\n        max\n      } = this._getMinMax(scalarData, scalarData.length);\n      range = [min, max];\n    }\n    return range[1] - range[0];\n  }\n  _getMinMax(frame, frameLength) {\n    let min = Infinity;\n    let max = -Infinity;\n    for (let i = 0; i < frameLength; i++) {\n      const voxel = frame[i];\n      if (voxel < min) {\n        min = voxel;\n      }\n      if (voxel > max) {\n        max = voxel;\n      }\n    }\n    return {\n      max,\n      min\n    };\n  }\n}\nWindowLevelTool.toolName = 'WindowLevel';\nexport default WindowLevelTool;","map":{"version":3,"names":["BaseTool","getEnabledElement","VolumeViewport","utilities","cache","DEFAULT_MULTIPLIER","DEFAULT_IMAGE_DYNAMIC_RANGE","PT","WindowLevelTool","constructor","toolProps","defaultToolProps","supportedInteractionTypes","_getImageDynamicRangeFromMiddleSlice","scalarData","dimensions","middleSliceIndex","Math","floor","frameLength","bytesPerVoxel","TypedArrayConstructor","Float32Array","Uint8Array","Uint16Array","Int16Array","buffer","byteOffset","frame","max","min","_getMinMax","touchDragCallback","evt","mouseDragCallback","element","deltaPoints","detail","enabledElement","renderingEngine","viewport","volumeId","lower","upper","modality","newRange","viewportsContainingVolumeUID","isPreScaled","properties","getProperties","targetId","getTargetId","split","getViewportsWithVolumeId","id","voiRange","volume","getVolume","Error","metadata","Modality","scaling","Object","keys","length","preScale","scaled","getImageData","scalingParameters","suvbw","undefined","getPTScaledNewRange","deltaPointsCanvas","canvas","clientHeight","getNewRange","setProperties","render","forEach","vp","multiplier","_getMultiplierFromDynamicRange","deltaY","wcDelta","wwDelta","windowWidth","windowCenter","windowLevel","toWindowLevel","toLowHighRange","imageDynamicRange","imageVolume","getScalarData","calculatedDynamicRange","BitsStored","metadataDynamicRange","Infinity","_getImageDynamicRangeFromViewport","ratio","round","imageData","getDimensions","getRange","getPointData","getScalars","range","i","voxel","toolName"],"sources":["../../../src/tools/WindowLevelTool.ts"],"sourcesContent":[null],"mappings":"AAAA,SAASA,QAAQ,QAAQ,QAAQ;AACjC,SACEC,iBAAiB,EACjBC,cAAc,EAEdC,SAAS,EACTC,KAAK,QAEA,qBAAqB;AAI5B,MAAMC,kBAAkB,GAAG,CAAC;AAC5B,MAAMC,2BAA2B,GAAG,IAAI;AACxC,MAAMC,EAAE,GAAG,IAAI;AAQf,MAAMC,eAAgB,SAAQR,QAAQ;EAEpCS,YACEC,SAAS,GAAG,EAAE,EACdC,gBAAgB,GAAG;IACjBC,yBAAyB,EAAE,CAAC,OAAO,EAAE,OAAO;GAC7C;IAED,KAAK,CAACF,SAAS,EAAEC,gBAAgB,CAAC;IAoMpC,KAAAE,oCAAoC,GAAG,CAACC,UAAU,EAAEC,UAAU,KAAI;MAChE,MAAMC,gBAAgB,GAAGC,IAAI,CAACC,KAAK,CAACH,UAAU,CAAC,CAAC,CAAC,GAAG,CAAC,CAAC;MAEtD,MAAMI,WAAW,GAAGJ,UAAU,CAAC,CAAC,CAAC,GAAGA,UAAU,CAAC,CAAC,CAAC;MACjD,IAAIK,aAAa;MACjB,IAAIC,qBAAqB;MAEzB,IAAIP,UAAU,YAAYQ,YAAY,EAAE;QACtCF,aAAa,GAAG,CAAC;QACjBC,qBAAqB,GAAGC,YAAY;OACrC,MAAM,IAAIR,UAAU,YAAYS,UAAU,EAAE;QAC3CH,aAAa,GAAG,CAAC;QACjBC,qBAAqB,GAAGE,UAAU;OACnC,MAAM,IAAIT,UAAU,YAAYU,WAAW,EAAE;QAC5CJ,aAAa,GAAG,CAAC;QACjBC,qBAAqB,GAAGG,WAAW;OACpC,MAAM,IAAIV,UAAU,YAAYW,UAAU,EAAE;QAC3CL,aAAa,GAAG,CAAC;QACjBC,qBAAqB,GAAGI,UAAU;;MAGpC,MAAMC,MAAM,GAAGZ,UAAU,CAACY,MAAM;MAChC,MAAMC,UAAU,GAAGX,gBAAgB,GAAGG,WAAW,GAAGC,aAAa;MACjE,MAAMQ,KAAK,GAAG,IAAIP,qBAAqB,CAACK,MAAM,EAAEC,UAAU,EAAER,WAAW,CAAC;MAExE,MAAM;QAAEU,GAAG;QAAEC;MAAG,CAAE,GAAG,IAAI,CAACC,UAAU,CAACH,KAAK,EAAET,WAAW,CAAC;MAExD,OAAOU,GAAG,GAAGC,GAAG;IAClB,CAAC;EA/ND;EAEAE,iBAAiBA,CAACC,GAAoC;IACpD,IAAI,CAACC,iBAAiB,CAACD,GAAG,CAAC;EAC7B;EAEAC,iBAAiBA,CAACD,GAAoC;IACpD,MAAM;MAAEE,OAAO;MAAEC;IAAW,CAAE,GAAGH,GAAG,CAACI,MAAM;IAC3C,MAAMC,cAAc,GAAGrC,iBAAiB,CAACkC,OAAO,CAAC;IACjD,MAAM;MAAEI,eAAe;MAAEC;IAAQ,CAAE,GAAGF,cAAc;IAEpD,IAAIG,QAAQ,EACVC,KAAK,EACLC,KAAK,EACLC,QAAQ,EACRC,QAAQ,EACRC,4BAA4B;IAC9B,IAAIC,WAAW,GAAG,KAAK;IAEvB,MAAMC,UAAU,GAAGR,QAAQ,CAACS,aAAa,EAAE;IAC3C,IAAIT,QAAQ,YAAYtC,cAAc,EAAE;MACtC,MAAMgD,QAAQ,GAAG,IAAI,CAACC,WAAW,CAACX,QAAiC,CAAC;MACpEC,QAAQ,GAAGS,QAAQ,CAACE,KAAK,CAAC,WAAW,CAAC,CAAC,CAAC,CAAC;MACzCN,4BAA4B,GAAG3C,SAAS,CAACkD,wBAAwB,CAC/DZ,QAAQ,EACRF,eAAe,CAACe,EAAE,CACnB;MACD,CAAC;QAAEZ,KAAK;QAAEC;MAAK,CAAE,GAAGK,UAAU,CAACO,QAAQ;MACvC,MAAMC,MAAM,GAAGpD,KAAK,CAACqD,SAAS,CAAChB,QAAQ,CAAC;MACxC,IAAI,CAACe,MAAM,EAAE;QACX,MAAM,IAAIE,KAAK,CAAC,mBAAmB,GAAGjB,QAAQ,CAAC;;MAEjDG,QAAQ,GAAGY,MAAM,CAACG,QAAQ,CAACC,QAAQ;MACnCb,WAAW,GAAGS,MAAM,CAACK,OAAO,IAAIC,MAAM,CAACC,IAAI,CAACP,MAAM,CAACK,OAAO,CAAC,CAACG,MAAM,GAAG,CAAC;KACvE,MAAM,IAAIhB,UAAU,CAACO,QAAQ,EAAE;MAC9BX,QAAQ,GAAIJ,QAAgB,CAACI,QAAQ;MACrC,CAAC;QAAEF,KAAK;QAAEC;MAAK,CAAE,GAAGK,UAAU,CAACO,QAAQ;MACvC,MAAM;QAAEU,QAAQ,GAAG;UAAEC,MAAM,EAAE;QAAK;MAAE,CAAE,GAAG1B,QAAQ,CAAC2B,YAAY,GAAE,CAAE,IAAI,EAAE;MACxEpB,WAAW,GACTkB,QAAQ,CAACC,MAAM,IAAID,QAAQ,CAACG,iBAAiB,EAAEC,KAAK,KAAKC,SAAS;KACrE,MAAM;MACL,MAAM,IAAIZ,KAAK,CAAC,8BAA8B,CAAC;;IAQjD,IAAId,QAAQ,KAAKrC,EAAE,IAAIwC,WAAW,EAAE;MAClCF,QAAQ,GAAG,IAAI,CAAC0B,mBAAmB,CAAC;QAClCC,iBAAiB,EAAEpC,WAAW,CAACqC,MAAM;QACrC/B,KAAK;QACLC,KAAK;QACL+B,YAAY,EAAEvC,OAAO,CAACuC,YAAY;QAClC3B,WAAW;QACXP,QAAQ;QACRC;OACD,CAAC;KACH,MAAM;MACLI,QAAQ,GAAG,IAAI,CAAC8B,WAAW,CAAC;QAC1BnC,QAAQ;QACRgC,iBAAiB,EAAEpC,WAAW,CAACqC,MAAM;QACrChC,QAAQ;QACRC,KAAK;QACLC;OACD,CAAC;;IAGJH,QAAQ,CAACoC,aAAa,CAAC;MACrBrB,QAAQ,EAAEV;KACX,CAAC;IAEFL,QAAQ,CAACqC,MAAM,EAAE;IAEjB,IAAIrC,QAAQ,YAAYtC,cAAc,EAAE;MACtC4C,4BAA4B,CAACgC,OAAO,CAAEC,EAAE,IAAI;QAC1C,IAAIvC,QAAQ,KAAKuC,EAAE,EAAE;UACnBA,EAAE,CAACF,MAAM,EAAE;;MAEf,CAAC,CAAC;MACF;;EAEJ;EAEAN,mBAAmBA,CAAC;IAClBC,iBAAiB;IACjB9B,KAAK;IACLC,KAAK;IACL+B,YAAY;IACZlC,QAAQ;IACRC,QAAQ;IACRM;EAAW,CACZ;IACC,IAAIiC,UAAU,GAAG3E,kBAAkB;IAEnC,IAAI0C,WAAW,EAAE;MACfiC,UAAU,GAAG,CAAC,GAAGN,YAAY;KAC9B,MAAM;MACLM,UAAU,GACR,IAAI,CAACC,8BAA8B,CAACzC,QAAQ,EAAEC,QAAQ,CAAC,IACvDpC,kBAAkB;;IAGtB,MAAM6E,MAAM,GAAGV,iBAAiB,CAAC,CAAC,CAAC;IACnC,MAAMW,OAAO,GAAGD,MAAM,GAAGF,UAAU;IAEnCrC,KAAK,IAAIwC,OAAO;IAChBxC,KAAK,GAAGI,WAAW,GAAG9B,IAAI,CAACY,GAAG,CAACc,KAAK,EAAE,GAAG,CAAC,GAAGA,KAAK;IAElD,OAAO;MAAED,KAAK;MAAEC;IAAK,CAAE;EACzB;EAEAgC,WAAWA,CAAC;IAAEnC,QAAQ;IAAEgC,iBAAiB;IAAE/B,QAAQ;IAAEC,KAAK;IAAEC;EAAK,CAAE;IACjE,MAAMqC,UAAU,GACd,IAAI,CAACC,8BAA8B,CAACzC,QAAQ,EAAEC,QAAQ,CAAC,IACvDpC,kBAAkB;IAEpB,MAAM+E,OAAO,GAAGZ,iBAAiB,CAAC,CAAC,CAAC,GAAGQ,UAAU;IACjD,MAAMG,OAAO,GAAGX,iBAAiB,CAAC,CAAC,CAAC,GAAGQ,UAAU;IAEjD,IAAI;MAAEK,WAAW;MAAEC;IAAY,CAAE,GAAGnF,SAAS,CAACoF,WAAW,CAACC,aAAa,CACrE9C,KAAK,EACLC,KAAK,CACN;IAED0C,WAAW,IAAID,OAAO;IACtBE,YAAY,IAAIH,OAAO;IAEvBE,WAAW,GAAGpE,IAAI,CAACY,GAAG,CAACwD,WAAW,EAAE,CAAC,CAAC;IAGtC,OAAOlF,SAAS,CAACoF,WAAW,CAACE,cAAc,CAACJ,WAAW,EAAEC,YAAY,CAAC;EACxE;EAEAL,8BAA8BA,CAACzC,QAAQ,EAAEC,QAAQ;IAC/C,IAAIiD,iBAAiB;IAErB,IAAIjD,QAAQ,EAAE;MACZ,MAAMkD,WAAW,GAAGvF,KAAK,CAACqD,SAAS,CAAChB,QAAQ,CAAC;MAC7C,MAAM;QAAE1B;MAAU,CAAE,GAAG4E,WAAW;MAClC,MAAM7E,UAAU,GAAG6E,WAAW,CAACC,aAAa,EAAE;MAC9C,MAAMC,sBAAsB,GAAG,IAAI,CAAChF,oCAAoC,CACtEC,UAAU,EACVC,UAAU,CACX;MACD,MAAM+E,UAAU,GAAGH,WAAW,EAAEhC,QAAQ,EAAEmC,UAAU;MACpD,MAAMC,oBAAoB,GAAGD,UAAU,GAAG,CAAC,IAAIA,UAAU,GAAGE,QAAQ;MAKpEN,iBAAiB,GAAGzE,IAAI,CAACa,GAAG,CAC1B+D,sBAAsB,EACtBE,oBAAoB,CACrB;KACF,MAAM;MACLL,iBAAiB,GAAG,IAAI,CAACO,iCAAiC,CAACzD,QAAQ,CAAC;;IAGtE,MAAM0D,KAAK,GAAGR,iBAAiB,GAAGpF,2BAA2B;IAE7D,OAAO4F,KAAK,GAAG,CAAC,GAAGjF,IAAI,CAACkF,KAAK,CAACD,KAAK,CAAC,GAAGA,KAAK;EAC9C;EAEAD,iCAAiCA,CAACzD,QAAQ;IACxC,MAAM;MAAE4D;IAAS,CAAE,GAAG5D,QAAQ,CAAC2B,YAAY,EAAE;IAC7C,MAAMpD,UAAU,GAAGqF,SAAS,CAACC,aAAa,EAAE;IAE5C,IAAID,SAAS,CAACE,QAAQ,EAAE;MACtB,OAAOF,SAAS,CAACE,QAAQ,EAAE;;IAE7B,IAAIxF,UAAU;IAEd,IAAIsF,SAAS,CAACR,aAAa,EAAE;MAC3B9E,UAAU,GAAGsF,SAAS,CAACR,aAAa,EAAE;KACvC,MAAM;MACL9E,UAAU,GAAGsF,SAAS,CAACG,YAAY,EAAE,CAACC,UAAU,EAAE;;IAGpD,IAAIzF,UAAU,CAAC,CAAC,CAAC,KAAK,CAAC,EAAE;MACvB,OAAO,IAAI,CAACF,oCAAoC,CAACC,UAAU,EAAEC,UAAU,CAAC;;IAG1E,IAAI0F,KAAK;IACT,IAAI3F,UAAU,CAACwF,QAAQ,EAAE;MACvBG,KAAK,GAAG3F,UAAU,CAACwF,QAAQ,EAAE;KAC9B,MAAM;MACL,MAAM;QAAExE,GAAG;QAAED;MAAG,CAAE,GAAG,IAAI,CAACE,UAAU,CAACjB,UAAU,EAAEA,UAAU,CAACkD,MAAM,CAAC;MACnEyC,KAAK,GAAG,CAAC3E,GAAG,EAAED,GAAG,CAAC;;IAGpB,OAAO4E,KAAK,CAAC,CAAC,CAAC,GAAGA,KAAK,CAAC,CAAC,CAAC;EAC5B;EAgCQ1E,UAAUA,CAACH,KAAgC,EAAET,WAAmB;IACtE,IAAIW,GAAG,GAAGkE,QAAQ;IAClB,IAAInE,GAAG,GAAG,CAACmE,QAAQ;IAEnB,KAAK,IAAIU,CAAC,GAAG,CAAC,EAAEA,CAAC,GAAGvF,WAAW,EAAEuF,CAAC,EAAE,EAAE;MACpC,MAAMC,KAAK,GAAG/E,KAAK,CAAC8E,CAAC,CAAC;MAEtB,IAAIC,KAAK,GAAG7E,GAAG,EAAE;QACfA,GAAG,GAAG6E,KAAK;;MAGb,IAAIA,KAAK,GAAG9E,GAAG,EAAE;QACfA,GAAG,GAAG8E,KAAK;;;IAGf,OAAO;MAAE9E,GAAG;MAAEC;IAAG,CAAE;EACrB;;AAGFtB,eAAe,CAACoG,QAAQ,GAAG,aAAa;AACxC,eAAepG,eAAe"},"metadata":{},"sourceType":"module","externalDependencies":[]}