{"ast":null,"code":"import { eventTarget, VolumeViewport, StackViewport, Enums, utilities, getEnabledElement } from '@cornerstonejs/core';\nimport { Colorbar } from './Colorbar';\nimport { getVOIMultipliers } from '../../getVOIMultipliers';\nconst {\n  Events\n} = Enums;\nconst defaultImageRange = {\n  lower: -1000,\n  upper: 1000\n};\nclass ViewportColorbar extends Colorbar {\n  constructor(props) {\n    const {\n      element,\n      volumeId\n    } = props;\n    const imageRange = ViewportColorbar._getImageRange(element, volumeId);\n    const voiRange = ViewportColorbar._getVOIRange(element, volumeId);\n    super({\n      ...props,\n      imageRange,\n      voiRange\n    });\n    this.autoHideTicks = () => {\n      if (this._hideTicksTimeoutId) {\n        return;\n      }\n      const timeLeft = this._hideTicksTime - Date.now();\n      if (timeLeft <= 0) {\n        this.hideTicks();\n      } else {\n        this._hideTicksTimeoutId = window.setTimeout(() => {\n          this._hideTicksTimeoutId = 0;\n          this.autoHideTicks();\n        }, timeLeft);\n      }\n    };\n    this._stackNewImageCallback = () => {\n      this.imageRange = ViewportColorbar._getImageRange(this._element);\n    };\n    this._imageVolumeModifiedCallback = evt => {\n      const {\n        volumeId\n      } = evt.detail.imageVolume;\n      if (volumeId !== this._volumeId) {\n        return;\n      }\n      const {\n        _element: element\n      } = this;\n      this.imageRange = ViewportColorbar._getImageRange(element, volumeId);\n    };\n    this._viewportVOIModifiedCallback = evt => {\n      const {\n        viewportId,\n        volumeId,\n        range: voiRange\n      } = evt.detail;\n      const {\n        viewport\n      } = this.enabledElement;\n      if (viewportId !== viewport.id || volumeId !== this._volumeId) {\n        return;\n      }\n      this.voiRange = voiRange;\n      this.showAndAutoHideTicks();\n    };\n    this._element = element;\n    this._volumeId = volumeId;\n    this._addCornerstoneEventListener();\n  }\n  get element() {\n    return this._element;\n  }\n  get enabledElement() {\n    return getEnabledElement(this._element);\n  }\n  getVOIMultipliers() {\n    const {\n      viewport\n    } = this.enabledElement;\n    return getVOIMultipliers(viewport, this._volumeId);\n  }\n  onVoiChange(voiRange) {\n    super.onVoiChange(voiRange);\n    const {\n      viewport\n    } = this.enabledElement;\n    if (viewport instanceof StackViewport) {\n      viewport.setProperties({\n        voiRange: voiRange\n      });\n      viewport.render();\n    } else if (viewport instanceof VolumeViewport) {\n      const {\n        _volumeId: volumeId\n      } = this;\n      const viewportsContainingVolumeUID = utilities.getViewportsWithVolumeId(volumeId, viewport.renderingEngineId);\n      viewport.setProperties({\n        voiRange\n      }, volumeId);\n      viewportsContainingVolumeUID.forEach(vp => vp.render());\n    }\n  }\n  static _getImageRange(element, volumeId) {\n    const enabledElement = getEnabledElement(element);\n    const {\n      viewport\n    } = enabledElement;\n    const actor = volumeId ? viewport.getActor(volumeId) : viewport.getDefaultActor();\n    if (!actor) {\n      return defaultImageRange;\n    }\n    const imageData = actor.actor.getMapper().getInputData();\n    const imageRange = imageData.getPointData().getScalars().getRange();\n    return imageRange[0] === 0 && imageRange[1] === 0 ? defaultImageRange : {\n      lower: imageRange[0],\n      upper: imageRange[1]\n    };\n  }\n  static _getVOIRange(element, volumeId) {\n    const enabledElement = getEnabledElement(element);\n    const {\n      viewport\n    } = enabledElement;\n    const volumeActor = volumeId ? viewport.getActor(volumeId) : viewport.getDefaultActor();\n    if (!volumeActor || !utilities.isImageActor(volumeActor)) {\n      return defaultImageRange;\n    }\n    const voiRange = volumeActor.actor.getProperty().getRGBTransferFunction(0).getRange();\n    return voiRange[0] === 0 && voiRange[1] === 0 ? defaultImageRange : {\n      lower: voiRange[0],\n      upper: voiRange[1]\n    };\n  }\n  showAndAutoHideTicks(interval = 1000) {\n    this._hideTicksTime = Date.now() + interval;\n    this.showTicks();\n    this.autoHideTicks();\n  }\n  _addCornerstoneEventListener() {\n    const {\n      _element: element\n    } = this;\n    eventTarget.addEventListener(Events.IMAGE_VOLUME_MODIFIED, this._imageVolumeModifiedCallback);\n    element.addEventListener(Events.STACK_NEW_IMAGE, this._stackNewImageCallback);\n    element.addEventListener(Events.VOI_MODIFIED, this._viewportVOIModifiedCallback);\n  }\n}\nexport { ViewportColorbar as default, ViewportColorbar };","map":{"version":3,"names":["eventTarget","VolumeViewport","StackViewport","Enums","utilities","getEnabledElement","Colorbar","getVOIMultipliers","Events","defaultImageRange","lower","upper","ViewportColorbar","constructor","props","element","volumeId","imageRange","_getImageRange","voiRange","_getVOIRange","autoHideTicks","_hideTicksTimeoutId","timeLeft","_hideTicksTime","Date","now","hideTicks","window","setTimeout","_stackNewImageCallback","_element","_imageVolumeModifiedCallback","evt","detail","imageVolume","_volumeId","_viewportVOIModifiedCallback","viewportId","range","viewport","enabledElement","id","showAndAutoHideTicks","_addCornerstoneEventListener","onVoiChange","setProperties","render","viewportsContainingVolumeUID","getViewportsWithVolumeId","renderingEngineId","forEach","vp","actor","getActor","getDefaultActor","imageData","getMapper","getInputData","getPointData","getScalars","getRange","volumeActor","isImageActor","getProperty","getRGBTransferFunction","interval","showTicks","addEventListener","IMAGE_VOLUME_MODIFIED","STACK_NEW_IMAGE","VOI_MODIFIED","default"],"sources":["../../../../../src/utilities/voi/colorbar/ViewportColorbar.ts"],"sourcesContent":[null],"mappings":"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"},"metadata":{},"sourceType":"module","externalDependencies":[]}