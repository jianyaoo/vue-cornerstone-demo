{"ast":null,"code":"import \"core-js/modules/es.array.push.js\";\nimport RequestType from '../enums/RequestType';\nimport { uuidv4 } from '../utilities';\nclass RequestPoolManager {\n  constructor(id) {\n    this.numRequests = {\n      interaction: 0,\n      thumbnail: 0,\n      prefetch: 0,\n      compute: 0\n    };\n    this.id = id ? id : uuidv4();\n    this.requestPool = {\n      interaction: {\n        0: []\n      },\n      thumbnail: {\n        0: []\n      },\n      prefetch: {\n        0: []\n      },\n      compute: {\n        0: []\n      }\n    };\n    this.grabDelay = 5;\n    this.awake = false;\n    this.numRequests = {\n      interaction: 0,\n      thumbnail: 0,\n      prefetch: 0,\n      compute: 0\n    };\n    this.maxNumRequests = {\n      interaction: 6,\n      thumbnail: 6,\n      prefetch: 5,\n      compute: 15\n    };\n  }\n  setMaxSimultaneousRequests(type, maxNumRequests) {\n    this.maxNumRequests[type] = maxNumRequests;\n  }\n  getMaxSimultaneousRequests(type) {\n    return this.maxNumRequests[type];\n  }\n  destroy() {\n    if (this.timeoutHandle) {\n      window.clearTimeout(this.timeoutHandle);\n    }\n  }\n  addRequest(requestFn, type, additionalDetails, priority = 0) {\n    const requestDetails = {\n      requestFn,\n      type,\n      additionalDetails\n    };\n    if (this.requestPool[type][priority] === undefined) {\n      this.requestPool[type][priority] = [];\n    }\n    this.requestPool[type][priority].push(requestDetails);\n    this.startGrabbing();\n  }\n  filterRequests(filterFunction) {\n    Object.keys(this.requestPool).forEach(type => {\n      const requestType = this.requestPool[type];\n      Object.keys(requestType).forEach(priority => {\n        requestType[priority] = requestType[priority].filter(requestDetails => {\n          return filterFunction(requestDetails);\n        });\n      });\n    });\n  }\n  clearRequestStack(type) {\n    if (!this.requestPool[type]) {\n      throw new Error(`No category for the type ${type} found`);\n    }\n    this.requestPool[type] = {\n      0: []\n    };\n  }\n  sendRequests(type) {\n    const requestsToSend = this.maxNumRequests[type] - this.numRequests[type];\n    for (let i = 0; i < requestsToSend; i++) {\n      const requestDetails = this.getNextRequest(type);\n      if (requestDetails === null) {\n        return false;\n      } else if (requestDetails) {\n        this.numRequests[type]++;\n        this.awake = true;\n        requestDetails.requestFn()?.finally(() => {\n          this.numRequests[type]--;\n          this.startAgain();\n        });\n      }\n    }\n    return true;\n  }\n  getNextRequest(type) {\n    const interactionPriorities = this.getSortedPriorityGroups(type);\n    for (const priority of interactionPriorities) {\n      if (this.requestPool[type][priority].length) {\n        return this.requestPool[type][priority].shift();\n      }\n    }\n    return null;\n  }\n  startGrabbing() {\n    const hasRemainingInteractionRequests = this.sendRequests(RequestType.Interaction);\n    const hasRemainingThumbnailRequests = this.sendRequests(RequestType.Thumbnail);\n    const hasRemainingPrefetchRequests = this.sendRequests(RequestType.Prefetch);\n    const hasRemainingComputeRequests = this.sendRequests(RequestType.Compute);\n    if (!hasRemainingInteractionRequests && !hasRemainingThumbnailRequests && !hasRemainingPrefetchRequests && !hasRemainingComputeRequests) {\n      this.awake = false;\n    }\n  }\n  startAgain() {\n    if (!this.awake) {\n      return;\n    }\n    if (this.grabDelay !== undefined) {\n      if (!this.timeoutHandle) {\n        this.timeoutHandle = window.setTimeout(() => {\n          this.timeoutHandle = null;\n          this.startGrabbing();\n        }, this.grabDelay);\n      }\n    } else {\n      this.startGrabbing();\n    }\n  }\n  getSortedPriorityGroups(type) {\n    const priorities = Object.keys(this.requestPool[type]).map(Number).filter(priority => this.requestPool[type][priority].length).sort((a, b) => a - b);\n    return priorities;\n  }\n  getRequestPool() {\n    return this.requestPool;\n  }\n}\nexport { RequestPoolManager };","map":{"version":3,"names":["RequestType","uuidv4","RequestPoolManager","constructor","id","numRequests","interaction","thumbnail","prefetch","compute","requestPool","grabDelay","awake","maxNumRequests","setMaxSimultaneousRequests","type","getMaxSimultaneousRequests","destroy","timeoutHandle","window","clearTimeout","addRequest","requestFn","additionalDetails","priority","requestDetails","undefined","push","startGrabbing","filterRequests","filterFunction","Object","keys","forEach","requestType","filter","clearRequestStack","Error","sendRequests","requestsToSend","i","getNextRequest","finally","startAgain","interactionPriorities","getSortedPriorityGroups","length","shift","hasRemainingInteractionRequests","Interaction","hasRemainingThumbnailRequests","Thumbnail","hasRemainingPrefetchRequests","Prefetch","hasRemainingComputeRequests","Compute","setTimeout","priorities","map","Number","sort","a","b","getRequestPool"],"sources":["../../../src/requestPool/requestPoolManager.ts"],"sourcesContent":[null],"mappings":"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"},"metadata":{},"sourceType":"module","externalDependencies":[]}