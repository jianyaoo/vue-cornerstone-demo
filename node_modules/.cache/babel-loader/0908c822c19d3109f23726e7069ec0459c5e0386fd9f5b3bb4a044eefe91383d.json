{"ast":null,"code":"import { getGPUTier } from 'detect-gpu';\nimport { SharedArrayBufferModes } from './enums';\nimport { getRenderingEngines } from './RenderingEngine/getRenderingEngine';\nlet csRenderInitialized = false;\nlet useSharedArrayBuffer = true;\nlet sharedArrayBufferMode = SharedArrayBufferModes.TRUE;\nimport { deepMerge } from './utilities';\nimport CentralizedWebWorkerManager from './webWorkerManager/webWorkerManager';\nconst defaultConfig = {\n  gpuTier: undefined,\n  detectGPUConfig: {},\n  rendering: {\n    useCPURendering: false,\n    preferSizeOverAccuracy: false,\n    useNorm16Texture: false,\n    strictZSpacingForVolumeViewport: true\n  },\n  enableCacheOptimization: true\n};\nlet config = {\n  gpuTier: undefined,\n  detectGPUConfig: {},\n  rendering: {\n    useCPURendering: false,\n    preferSizeOverAccuracy: false,\n    useNorm16Texture: false,\n    strictZSpacingForVolumeViewport: true\n  },\n  enableCacheOptimization: true\n};\nlet webWorkerManager = null;\nfunction _getGLContext() {\n  const canvas = document.createElement('canvas');\n  const gl = canvas.getContext('webgl2') || canvas.getContext('webgl') || canvas.getContext('experimental-webgl');\n  return gl;\n}\nfunction _hasActiveWebGLContext() {\n  const gl = _getGLContext();\n  return gl instanceof WebGLRenderingContext || gl instanceof WebGL2RenderingContext;\n}\nfunction hasSharedArrayBuffer() {\n  try {\n    if (new SharedArrayBuffer(0)) {\n      return true;\n    } else {\n      return false;\n    }\n  } catch {\n    return false;\n  }\n}\nasync function init(configuration = config) {\n  if (csRenderInitialized) {\n    return csRenderInitialized;\n  }\n  config = deepMerge(defaultConfig, configuration);\n  const hasWebGLContext = _hasActiveWebGLContext();\n  if (!hasWebGLContext) {\n    console.log('CornerstoneRender: GPU not detected, using CPU rendering');\n    config.rendering.useCPURendering = true;\n  } else {\n    config.gpuTier = config.gpuTier || (await getGPUTier(config.detectGPUConfig));\n    console.log('CornerstoneRender: Using detect-gpu to get the GPU benchmark:', config.gpuTier);\n    if (config.gpuTier?.tier < 1) {\n      console.log('CornerstoneRender: GPU is not powerful enough, using CPU rendering');\n      config.rendering.useCPURendering = true;\n    } else {\n      console.log('CornerstoneRender: using GPU rendering');\n    }\n  }\n  setUseSharedArrayBuffer(sharedArrayBufferMode);\n  csRenderInitialized = true;\n  if (!webWorkerManager) {\n    webWorkerManager = new CentralizedWebWorkerManager();\n  }\n  return csRenderInitialized;\n}\nfunction setUseCPURendering(status) {\n  config.rendering.useCPURendering = status;\n  csRenderInitialized = true;\n  _updateRenderingPipelinesForAllViewports();\n}\nfunction setPreferSizeOverAccuracy(status) {\n  config.rendering.preferSizeOverAccuracy = status;\n  csRenderInitialized = true;\n  _updateRenderingPipelinesForAllViewports();\n}\nfunction resetUseCPURendering() {\n  config.rendering.useCPURendering = !_hasActiveWebGLContext();\n  _updateRenderingPipelinesForAllViewports();\n}\nfunction getShouldUseCPURendering() {\n  return config.rendering.useCPURendering;\n}\nfunction setUseSharedArrayBuffer(mode) {\n  if (mode == SharedArrayBufferModes.AUTO) {\n    sharedArrayBufferMode = SharedArrayBufferModes.AUTO;\n    const hasSharedBuffer = hasSharedArrayBuffer();\n    if (!hasSharedBuffer) {\n      useSharedArrayBuffer = false;\n      console.warn(`CornerstoneRender: SharedArray Buffer not allowed, performance may be slower.\n        Try ensuring page is cross-origin isolated to enable SharedArrayBuffer.`);\n    } else {\n      useSharedArrayBuffer = true;\n      console.log('CornerstoneRender: using SharedArrayBuffer');\n    }\n    return;\n  }\n  if (mode == SharedArrayBufferModes.TRUE || mode == true) {\n    sharedArrayBufferMode = SharedArrayBufferModes.TRUE;\n    useSharedArrayBuffer = true;\n    return;\n  }\n  if (mode == SharedArrayBufferModes.FALSE || mode == false) {\n    sharedArrayBufferMode = SharedArrayBufferModes.FALSE;\n    useSharedArrayBuffer = false;\n    return;\n  }\n}\nfunction resetUseSharedArrayBuffer() {\n  setUseSharedArrayBuffer(sharedArrayBufferMode);\n}\nfunction getShouldUseSharedArrayBuffer() {\n  return useSharedArrayBuffer;\n}\nfunction isCornerstoneInitialized() {\n  return csRenderInitialized;\n}\nfunction getConfiguration() {\n  return config;\n}\nfunction setConfiguration(c) {\n  config = c;\n  _updateRenderingPipelinesForAllViewports();\n}\nfunction _updateRenderingPipelinesForAllViewports() {\n  getRenderingEngines().forEach(engine => engine.getViewports().forEach(viewport => viewport.updateRenderingPipeline?.()));\n}\nfunction getWebWorkerManager() {\n  if (!webWorkerManager) {\n    webWorkerManager = new CentralizedWebWorkerManager();\n  }\n  return webWorkerManager;\n}\nexport { init, getShouldUseCPURendering, getShouldUseSharedArrayBuffer, isCornerstoneInitialized, setUseCPURendering, setUseSharedArrayBuffer, setPreferSizeOverAccuracy, resetUseCPURendering, resetUseSharedArrayBuffer, getConfiguration, setConfiguration, getWebWorkerManager };","map":{"version":3,"names":["getGPUTier","SharedArrayBufferModes","getRenderingEngines","csRenderInitialized","useSharedArrayBuffer","sharedArrayBufferMode","TRUE","deepMerge","CentralizedWebWorkerManager","defaultConfig","gpuTier","undefined","detectGPUConfig","rendering","useCPURendering","preferSizeOverAccuracy","useNorm16Texture","strictZSpacingForVolumeViewport","enableCacheOptimization","config","webWorkerManager","_getGLContext","canvas","document","createElement","gl","getContext","_hasActiveWebGLContext","WebGLRenderingContext","WebGL2RenderingContext","hasSharedArrayBuffer","SharedArrayBuffer","init","configuration","hasWebGLContext","console","log","tier","setUseSharedArrayBuffer","setUseCPURendering","status","_updateRenderingPipelinesForAllViewports","setPreferSizeOverAccuracy","resetUseCPURendering","getShouldUseCPURendering","mode","AUTO","hasSharedBuffer","warn","FALSE","resetUseSharedArrayBuffer","getShouldUseSharedArrayBuffer","isCornerstoneInitialized","getConfiguration","setConfiguration","c","forEach","engine","getViewports","viewport","updateRenderingPipeline","getWebWorkerManager"],"sources":["../../src/init.ts"],"sourcesContent":[null],"mappings":"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"},"metadata":{},"sourceType":"module","externalDependencies":[]}