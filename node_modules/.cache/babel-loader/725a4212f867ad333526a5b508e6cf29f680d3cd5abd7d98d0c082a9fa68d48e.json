{"ast":null,"code":"import { imageLoader, Enums, eventTarget, imageLoadPoolManager, cache, getConfiguration as getCoreConfiguration } from '@cornerstonejs/core';\nimport { addToolState, getToolState } from './state';\nimport { getStackData, requestType, priority, getPromiseRemovedHandler, nearestIndex, range } from './stackPrefetchUtils';\nlet configuration = {\n  maxImagesToPrefetch: Infinity,\n  preserveExistingPool: true\n};\nlet resetPrefetchTimeout;\nconst resetPrefetchDelay = 10;\nfunction prefetch(element) {\n  const stackPrefetchData = getToolState(element);\n  if (!stackPrefetchData) {\n    return;\n  }\n  const stackPrefetch = stackPrefetchData || {};\n  const stack = getStackData(element);\n  if (!stack?.imageIds?.length) {\n    console.warn('CornerstoneTools.stackPrefetch: No images in stack.');\n    return;\n  }\n  const {\n    currentImageIdIndex\n  } = stack;\n  stackPrefetch.enabled &&= stackPrefetch.indicesToRequest?.length;\n  if (stackPrefetch.enabled === false) {\n    return;\n  }\n  function removeFromList(imageIdIndex) {\n    const index = stackPrefetch.indicesToRequest.indexOf(imageIdIndex);\n    if (index > -1) {\n      stackPrefetch.indicesToRequest.splice(index, 1);\n    }\n  }\n  stackPrefetchData.indicesToRequest.sort((a, b) => a - b);\n  const indicesToRequestCopy = stackPrefetch.indicesToRequest.slice();\n  indicesToRequestCopy.forEach(function (imageIdIndex) {\n    const imageId = stack.imageIds[imageIdIndex];\n    if (!imageId) {\n      return;\n    }\n    const distance = Math.abs(currentImageIdIndex - imageIdIndex);\n    const imageCached = distance < 6 ? cache.getImageLoadObject(imageId) : cache.isLoaded(imageId);\n    if (imageCached) {\n      removeFromList(imageIdIndex);\n    }\n  });\n  if (!stackPrefetch.indicesToRequest.length) {\n    return;\n  }\n  if (!configuration.preserveExistingPool) {\n    imageLoadPoolManager.clearRequestStack(requestType);\n  }\n  const nearest = nearestIndex(stackPrefetch.indicesToRequest, stack.currentImageIdIndex);\n  let imageId;\n  let nextImageIdIndex;\n  const preventCache = false;\n  function doneCallback(image) {\n    console.log('prefetch done: %s', image.imageId);\n    const imageIdIndex = stack.imageIds.indexOf(image.imageId);\n    removeFromList(imageIdIndex);\n  }\n  let lowerIndex = nearest.low;\n  let higherIndex = nearest.high;\n  const imageIdsToPrefetch = [];\n  while (lowerIndex >= 0 || higherIndex < stackPrefetch.indicesToRequest.length) {\n    const currentIndex = stack.currentImageIdIndex;\n    const shouldSkipLower = currentIndex - stackPrefetch.indicesToRequest[lowerIndex] > configuration.maxImagesToPrefetch;\n    const shouldSkipHigher = stackPrefetch.indicesToRequest[higherIndex] - currentIndex > configuration.maxImagesToPrefetch;\n    const shouldLoadLower = !shouldSkipLower && lowerIndex >= 0;\n    const shouldLoadHigher = !shouldSkipHigher && higherIndex < stackPrefetch.indicesToRequest.length;\n    if (!shouldLoadHigher && !shouldLoadLower) {\n      break;\n    }\n    if (shouldLoadLower) {\n      nextImageIdIndex = stackPrefetch.indicesToRequest[lowerIndex--];\n      imageId = stack.imageIds[nextImageIdIndex];\n      imageIdsToPrefetch.push(imageId);\n    }\n    if (shouldLoadHigher) {\n      nextImageIdIndex = stackPrefetch.indicesToRequest[higherIndex++];\n      imageId = stack.imageIds[nextImageIdIndex];\n      imageIdsToPrefetch.push(imageId);\n    }\n  }\n  const requestFn = (imageId, options) => imageLoader.loadAndCacheImage(imageId, options);\n  const {\n    useNorm16Texture\n  } = getCoreConfiguration().rendering;\n  imageIdsToPrefetch.forEach(imageId => {\n    const options = {\n      targetBuffer: {\n        type: useNorm16Texture ? undefined : 'Float32Array'\n      },\n      preScale: {\n        enabled: true\n      },\n      requestType\n    };\n    imageLoadPoolManager.addRequest(requestFn.bind(null, imageId, options), requestType, {\n      imageId\n    }, priority);\n  });\n}\nfunction onImageUpdated(e) {\n  clearTimeout(resetPrefetchTimeout);\n  resetPrefetchTimeout = setTimeout(function () {\n    const element = e.target;\n    try {\n      prefetch(element);\n    } catch (error) {\n      return;\n    }\n  }, resetPrefetchDelay);\n}\nfunction enable(element) {\n  const stack = getStackData(element);\n  if (!stack || !stack.imageIds || stack.imageIds.length === 0) {\n    console.warn('CornerstoneTools.stackPrefetch: No images in stack.');\n    return;\n  }\n  const stackPrefetchData = {\n    indicesToRequest: range(0, stack.imageIds.length - 1),\n    enabled: true,\n    direction: 1\n  };\n  const indexOfCurrentImage = stackPrefetchData.indicesToRequest.indexOf(stack.currentImageIdIndex);\n  stackPrefetchData.indicesToRequest.splice(indexOfCurrentImage, 1);\n  addToolState(element, stackPrefetchData);\n  prefetch(element);\n  element.removeEventListener(Enums.Events.STACK_NEW_IMAGE, onImageUpdated);\n  element.addEventListener(Enums.Events.STACK_NEW_IMAGE, onImageUpdated);\n  const promiseRemovedHandler = getPromiseRemovedHandler(element);\n  eventTarget.removeEventListener(Enums.Events.IMAGE_CACHE_IMAGE_REMOVED, promiseRemovedHandler);\n  eventTarget.addEventListener(Enums.Events.IMAGE_CACHE_IMAGE_REMOVED, promiseRemovedHandler);\n}\nfunction disable(element) {\n  clearTimeout(resetPrefetchTimeout);\n  element.removeEventListener(Enums.Events.STACK_NEW_IMAGE, onImageUpdated);\n  const promiseRemovedHandler = getPromiseRemovedHandler(element);\n  eventTarget.removeEventListener(Enums.Events.IMAGE_CACHE_IMAGE_REMOVED, promiseRemovedHandler);\n  const stackPrefetchData = getToolState(element);\n  if (stackPrefetchData && stackPrefetchData.indicesToRequest.length) {\n    stackPrefetchData.enabled = false;\n    imageLoadPoolManager.clearRequestStack(requestType);\n  }\n}\nfunction getConfiguration() {\n  return configuration;\n}\nfunction setConfiguration(config) {\n  configuration = config;\n}\nconst stackPrefetch = {\n  enable,\n  disable,\n  getConfiguration,\n  setConfiguration\n};\nexport default stackPrefetch;","map":{"version":3,"names":["imageLoader","Enums","eventTarget","imageLoadPoolManager","cache","getConfiguration","getCoreConfiguration","addToolState","getToolState","getStackData","requestType","priority","getPromiseRemovedHandler","nearestIndex","range","configuration","maxImagesToPrefetch","Infinity","preserveExistingPool","resetPrefetchTimeout","resetPrefetchDelay","prefetch","element","stackPrefetchData","stackPrefetch","stack","imageIds","length","console","warn","currentImageIdIndex","enabled","indicesToRequest","removeFromList","imageIdIndex","index","indexOf","splice","sort","a","b","indicesToRequestCopy","slice","forEach","imageId","distance","Math","abs","imageCached","getImageLoadObject","isLoaded","clearRequestStack","nearest","nextImageIdIndex","preventCache","doneCallback","image","log","lowerIndex","low","higherIndex","high","imageIdsToPrefetch","currentIndex","shouldSkipLower","shouldSkipHigher","shouldLoadLower","shouldLoadHigher","push","requestFn","options","loadAndCacheImage","useNorm16Texture","rendering","targetBuffer","type","undefined","preScale","addRequest","bind","onImageUpdated","e","clearTimeout","setTimeout","target","error","enable","direction","indexOfCurrentImage","removeEventListener","Events","STACK_NEW_IMAGE","addEventListener","promiseRemovedHandler","IMAGE_CACHE_IMAGE_REMOVED","disable","setConfiguration","config"],"sources":["../../../../src/utilities/stackPrefetch/stackPrefetch.ts"],"sourcesContent":[null],"mappings":"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"},"metadata":{},"sourceType":"module","externalDependencies":[]}